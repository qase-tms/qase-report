---
phase: 30-foundation-setup
plan: 03
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/index.css
  - src/components/ThemeProvider.tsx
autonomous: true

must_haves:
  truths:
    - "Dark theme loads by default without flash of unstyled content (FOUC)"
    - "Theme persists across page reloads via localStorage"
    - "CSS variables change when theme toggles"
  artifacts:
    - path: "src/index.css"
      provides: "Dark theme CSS variables as default"
      contains: "--background"
    - path: "src/components/ThemeProvider.tsx"
      provides: "Theme context and localStorage sync"
      contains: "useTheme"
  key_links:
    - from: "src/components/ThemeProvider.tsx"
      to: "localStorage"
      via: "theme persistence"
      pattern: "localStorage.*theme"
    - from: "src/index.css"
      to: ":root"
      via: "CSS variable definitions"
      pattern: ":root.*--background"
---

<objective>
Configure dark theme as default using Tailwind CSS variables with no FOUC.

Purpose: Maintain dark-first design (Playwright Smart Reporter style) through migration.
Output: Theme system ready for shadcn/ui components with localStorage persistence.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/STACK-SHADCN-MIGRATION.md
@.planning/research/PITFALLS-SHADCN-MIGRATION.md
@.planning/phases/30-foundation-setup/30-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure dark theme CSS variables as default</name>
  <files>src/index.css</files>
  <action>
Update src/index.css to set dark theme as the default (no .dark class needed for dark mode):

```css
@import "tailwindcss";

/* Base layer for Tailwind compatibility */
@layer base {
  /* Dark theme as DEFAULT (no class needed) */
  :root {
    --background: 224 71% 4%;
    --foreground: 213 31% 91%;
    --card: 224 71% 4%;
    --card-foreground: 213 31% 91%;
    --popover: 224 71% 4%;
    --popover-foreground: 213 31% 91%;
    --primary: 210 40% 98%;
    --primary-foreground: 222.2 47.4% 1.2%;
    --secondary: 222.2 47.4% 11.2%;
    --secondary-foreground: 210 40% 98%;
    --muted: 223 47% 11%;
    --muted-foreground: 215.4 16.3% 56.9%;
    --accent: 216 34% 17%;
    --accent-foreground: 210 40% 98%;
    --destructive: 0 63% 31%;
    --destructive-foreground: 210 40% 98%;
    --border: 216 34% 17%;
    --input: 216 34% 17%;
    --ring: 216 34% 17%;
    --radius: 0.5rem;

    /* Status colors (match current MUI theme) */
    --status-passed: 142 76% 36%;
    --status-failed: 0 84% 60%;
    --status-skipped: 48 96% 53%;
    --status-broken: 0 0% 45%;

    /* Chart colors for Recharts */
    --chart-1: 142 76% 36%;
    --chart-2: 0 84% 60%;
    --chart-3: 48 96% 53%;
    --chart-4: 217 91% 60%;
    --chart-5: 280 65% 60%;
  }

  /* Light theme (activated by .light class on html) */
  .light {
    --background: 0 0% 100%;
    --foreground: 224 71% 4%;
    --card: 0 0% 100%;
    --card-foreground: 224 71% 4%;
    --popover: 0 0% 100%;
    --popover-foreground: 224 71% 4%;
    --primary: 222.2 47.4% 11.2%;
    --primary-foreground: 210 40% 98%;
    --secondary: 210 40% 96.1%;
    --secondary-foreground: 222.2 47.4% 11.2%;
    --muted: 210 40% 96.1%;
    --muted-foreground: 215.4 16.3% 46.9%;
    --accent: 210 40% 96.1%;
    --accent-foreground: 222.2 47.4% 11.2%;
    --destructive: 0 84.2% 60.2%;
    --destructive-foreground: 210 40% 98%;
    --border: 214.3 31.8% 91.4%;
    --input: 214.3 31.8% 91.4%;
    --ring: 222.2 84% 4.9%;

    /* Status colors (light variants) */
    --status-passed: 142 71% 45%;
    --status-failed: 0 84% 60%;
    --status-skipped: 48 96% 53%;
    --status-broken: 0 0% 55%;

    /* Chart colors */
    --chart-1: 142 71% 45%;
    --chart-2: 0 84% 60%;
    --chart-3: 48 96% 53%;
    --chart-4: 217 91% 60%;
    --chart-5: 280 65% 60%;
  }
}

@layer base {
  * {
    @apply border-border;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* MUI coexistence - preserve until Phase 30-04 */
html,
body,
#root {
  margin: 0;
  padding: 0;
  min-height: 100vh;
}

html {
  overflow-y: auto;
  scrollbar-gutter: stable;
}
```

Key design decisions:
- Dark theme is DEFAULT (:root) - no .dark class needed
- Light theme requires .light class on html element
- This is INVERTED from shadcn default to match our dark-first design
- Status colors preserved from MUI theme for consistency during migration
- Chart colors defined for Recharts integration
  </action>
  <verify>
1. `npm run dev` - page loads with dark background
2. Inspect :root in DevTools - should see dark theme CSS variables
3. No FOUC on page load (dark immediately, not white flash then dark)
  </verify>
  <done>
Dark theme CSS variables set as default in :root, light theme activated by .light class.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ThemeProvider component</name>
  <files>src/components/ThemeProvider.tsx</files>
  <action>
Create a ThemeProvider component that manages theme state with localStorage:

```typescript
import { createContext, useContext, useEffect, useState } from 'react'

type Theme = 'dark' | 'light' | 'system'

interface ThemeProviderProps {
  children: React.ReactNode
  defaultTheme?: Theme
  storageKey?: string
}

interface ThemeProviderState {
  theme: Theme
  setTheme: (theme: Theme) => void
  resolvedTheme: 'dark' | 'light'
}

const ThemeProviderContext = createContext<ThemeProviderState | undefined>(undefined)

export function ThemeProvider({
  children,
  defaultTheme = 'dark',
  storageKey = 'vite-ui-theme',
}: ThemeProviderProps) {
  const [theme, setTheme] = useState<Theme>(() => {
    if (typeof window === 'undefined') return defaultTheme
    return (localStorage.getItem(storageKey) as Theme) || defaultTheme
  })

  const resolvedTheme = theme === 'system'
    ? (typeof window !== 'undefined' && window.matchMedia('(prefers-color-scheme: dark)').matches
        ? 'dark'
        : 'light')
    : theme

  useEffect(() => {
    const root = window.document.documentElement

    // Remove both classes first
    root.classList.remove('light', 'dark')

    // For our dark-first system: only add .light when light theme
    // Dark is default (no class needed)
    if (resolvedTheme === 'light') {
      root.classList.add('light')
    }
  }, [resolvedTheme])

  useEffect(() => {
    localStorage.setItem(storageKey, theme)
  }, [theme, storageKey])

  // Listen for system theme changes
  useEffect(() => {
    if (theme !== 'system') return

    const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
    const handleChange = () => {
      const root = window.document.documentElement
      root.classList.remove('light')
      if (!mediaQuery.matches) {
        root.classList.add('light')
      }
    }

    mediaQuery.addEventListener('change', handleChange)
    return () => mediaQuery.removeEventListener('change', handleChange)
  }, [theme])

  return (
    <ThemeProviderContext.Provider
      value={{
        theme,
        setTheme,
        resolvedTheme,
      }}
    >
      {children}
    </ThemeProviderContext.Provider>
  )
}

export function useTheme() {
  const context = useContext(ThemeProviderContext)
  if (context === undefined) {
    throw new Error('useTheme must be used within a ThemeProvider')
  }
  return context
}
```

Key features:
- Uses same localStorage key as existing MUI theme ('vite-ui-theme') for seamless migration
- Dark theme default (no class = dark)
- Light theme via .light class (inverted from shadcn standard)
- System theme support with media query listener
- resolvedTheme always returns actual theme ('dark' or 'light')

NOTE: This provider will coexist with MUI's CssVarsProvider during migration.
Do NOT integrate into App.tsx yet - that happens in Phase 31 when components migrate.
  </action>
  <verify>
1. File exists at src/components/ThemeProvider.tsx
2. TypeScript compiles: `npx tsc --noEmit`
3. Exports ThemeProvider and useTheme
  </verify>
  <done>
ThemeProvider component created with dark-first design and localStorage persistence.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add FOUC prevention script</name>
  <files>index.html</files>
  <action>
Add inline script to index.html to prevent flash of unstyled content:

Update the existing index.html to add a script in the head:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qase Report</title>
    <script>
      // FOUC prevention: Apply theme class before first paint
      (function() {
        const theme = localStorage.getItem('vite-ui-theme') || 'dark';
        const resolved = theme === 'system'
          ? (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light')
          : theme;
        // Our dark-first system: only add .light for light theme
        if (resolved === 'light') {
          document.documentElement.classList.add('light');
        }
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>
```

This script:
- Runs synchronously before any render
- Reads localStorage theme preference
- Applies .light class only for light theme (dark is default, no class needed)
- Handles 'system' preference with media query check
- Prevents white flash when user prefers dark theme
  </action>
  <verify>
1. Hard refresh page (Cmd+Shift+R) - no white flash before dark theme loads
2. Set theme to 'light' in localStorage, refresh - light theme loads immediately
3. Remove localStorage item, refresh - dark theme loads (default)
  </verify>
  <done>
FOUC prevention script added to index.html, theme applies before first paint.
  </done>
</task>

</tasks>

<verification>
1. Page loads with dark theme by default (no white flash)
2. DevTools shows CSS variables in :root with dark values
3. Manually adding .light to html element switches to light theme
4. ThemeProvider.tsx compiles and exports correctly
5. FOUC script in index.html runs before React hydrates
</verification>

<success_criteria>
- Dark theme is default via CSS variables (no FOUC)
- Light theme activates via .light class on html
- ThemeProvider ready for integration (dark-first design)
- localStorage key matches existing MUI theme key
- Theme persists across page reloads
</success_criteria>

<output>
After completion, create `.planning/phases/30-foundation-setup/30-03-SUMMARY.md`
</output>
