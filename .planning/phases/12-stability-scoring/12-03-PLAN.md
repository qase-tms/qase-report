---
phase: 12-stability-scoring
plan: 03
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - src/components/Dashboard/TestHealthWidget.tsx
  - src/components/Dashboard/index.tsx
autonomous: false

must_haves:
  truths:
    - "User sees test health widget on dashboard"
    - "Widget shows grade distribution (A+ to F counts)"
    - "Widget shows overall health summary"
    - "Widget only appears when history data exists"
  artifacts:
    - path: "src/components/Dashboard/TestHealthWidget.tsx"
      provides: "Grade distribution visualization component"
      exports: ["TestHealthWidget"]
    - path: "src/components/Dashboard/index.tsx"
      provides: "TestHealthWidget integration in dashboard layout"
      contains: "TestHealthWidget"
  key_links:
    - from: "src/components/Dashboard/TestHealthWidget.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "useRootStore() for gradeDistribution"
      pattern: "analyticsStore\\.gradeDistribution"
    - from: "src/components/Dashboard/index.tsx"
      to: "src/components/Dashboard/TestHealthWidget.tsx"
      via: "import and render"
      pattern: "import.*TestHealthWidget"
---

<objective>
Create test health widget showing grade distribution on dashboard.

Purpose: Provide at-a-glance test health overview (STAB-03).
Output: TestHealthWidget component integrated into Dashboard.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-stability-scoring/12-01-SUMMARY.md
@src/components/Dashboard/index.tsx
@src/components/Dashboard/StatsCard.tsx
@src/components/Dashboard/AlertsPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestHealthWidget component</name>
  <files>src/components/Dashboard/TestHealthWidget.tsx</files>
  <action>
Create a dashboard widget showing grade distribution following existing patterns (AlertsPanel, StatsCard).

1. Import dependencies:
   - Box, Paper, Typography, Chip, LinearProgress, Stack from @mui/material
   - observer from mobx-react-lite
   - useRootStore from store
   - StabilityGrade from types/stability

2. Define grade configuration for display:
   ```typescript
   const gradeConfig: Record<Exclude<StabilityGrade, 'N/A'>, { color: 'success' | 'info' | 'warning' | 'error'; label: string }> = {
     'A+': { color: 'success', label: 'Excellent' },
     'A': { color: 'success', label: 'Good' },
     'B': { color: 'info', label: 'Fair' },
     'C': { color: 'warning', label: 'Needs attention' },
     'D': { color: 'warning', label: 'Poor' },
     'F': { color: 'error', label: 'Critical' },
   }
   ```

3. Create TestHealthWidget component:
   - Wrap with observer()
   - Get analyticsStore from useRootStore()
   - Get gradeDistribution and testStabilityMap

   - If testStabilityMap is empty or has only a few tests, show message:
     "Load history data (10+ runs per test) to see test health grades"

   - Calculate total graded tests: sum of all grade counts
   - Calculate health score: weighted average where A+=100, A=95, B=85, C=75, D=65, F=30

4. Widget layout (Paper card):
   ```
   +-----------------------------------------+
   | Test Health              Overall: B (82) |
   +-----------------------------------------+
   | Grade Distribution                       |
   | A+ [=====] 5 (10%)                       |
   | A  [========] 10 (20%)                   |
   | B  [============] 15 (30%)               |
   | C  [======] 8 (16%)                      |
   | D  [===] 4 (8%)                          |
   | F  [====] 8 (16%)                        |
   +-----------------------------------------+
   | 50 tests graded                          |
   +-----------------------------------------+
   ```

5. For each grade row:
   - Grade letter chip (colored)
   - LinearProgress showing percentage of total
   - Count and percentage text

6. Overall health badge:
   - Calculate weighted score
   - Map to letter grade
   - Display as Chip in header

Implementation details:
- Use Stack with spacing for grade rows
- LinearProgress variant="determinate" for bars
- Chip for grade letters (small, colored)
- Typography for counts/percentages
- Paper with sx={{ p: 2 }} for card container

Export as named export.
  </action>
  <verify>
`test -f src/components/Dashboard/TestHealthWidget.tsx && grep -q "TestHealthWidget" src/components/Dashboard/TestHealthWidget.tsx && grep -q "gradeDistribution" src/components/Dashboard/TestHealthWidget.tsx && echo "Widget created"`
  </verify>
  <done>
TestHealthWidget.tsx exists showing grade distribution with progress bars, overall health score, and test count. Uses gradeDistribution from AnalyticsStore.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate TestHealthWidget into Dashboard</name>
  <files>src/components/Dashboard/index.tsx</files>
  <action>
Add TestHealthWidget to dashboard layout.

1. Import TestHealthWidget:
   `import { TestHealthWidget } from './TestHealthWidget'`

2. Add TestHealthWidget in the trends section, alongside TrendsChart and HistoryTimeline:
   - Show when history data exists (same condition as trends section)
   - Place in its own Grid item

3. Update layout to accommodate widget:
   - Current: TrendsChart (lg=8) + HistoryTimeline (lg=4)
   - New: TrendsChart (lg=6) + TestHealthWidget (lg=3) + HistoryTimeline (lg=3)
   - On smaller screens, stack vertically (xs=12 for all)

4. Conditional rendering:
   - Only show TestHealthWidget when historyStore.isHistoryLoaded
   - This ensures widget only appears when history data is available

Updated layout in the trends Box:
```tsx
{(analyticsStore.hasTrendData || historyStore.recentRuns.length > 0) && (
  <Box sx={{ mt: 3 }}>
    <Grid container spacing={3}>
      {analyticsStore.hasTrendData && (
        <Grid item xs={12} lg={6}>
          <TrendsChart />
        </Grid>
      )}
      {historyStore.isHistoryLoaded && (
        <Grid item xs={12} sm={6} lg={3}>
          <TestHealthWidget />
        </Grid>
      )}
      {historyStore.recentRuns.length > 0 && (
        <Grid item xs={12} sm={6} lg={3}>
          <HistoryTimeline />
        </Grid>
      )}
    </Grid>
  </Box>
)}
```

Note: The layout adjusts based on what's available:
- History only: Widget + Timeline side by side
- Trends + History: All three in row
- Trends only: Just TrendsChart (full width)
  </action>
  <verify>
`grep -q "TestHealthWidget" src/components/Dashboard/index.tsx && npm run build 2>&1 | grep -q "error" && echo "Build errors" || echo "Build OK"`
  </verify>
  <done>
Dashboard imports and renders TestHealthWidget in the trends section. Layout responsive with appropriate grid sizing. Build passes.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete stability scoring feature</name>
  <what-built>
Complete stability scoring feature:
- A+ to F grades calculated from pass rate, flakiness, duration variance
- Grade badges on test list items with tooltip showing score breakdown
- Grade filter chips in test list filters
- Test health widget on dashboard showing grade distribution
  </what-built>
  <how-to-verify>
1. Run `npm run dev` and open http://localhost:5173

2. Load a test report with history data (run.json + test-history.json)
   - If no history file, system should show "N/A" grades

3. Check Test List:
   - [ ] Grade badges (A+, A, B, C, D, F) appear on test items
   - [ ] Hovering badge shows tooltip: "Score: X (Pass: Y%, Flaky: Z%, CV: W%)"
   - [ ] Grade filter chips visible below status filters
   - [ ] Clicking grade chip filters tests to that grade
   - [ ] Multiple grade chips can be selected

4. Check Dashboard:
   - [ ] Test Health widget visible in trends section
   - [ ] Widget shows grade distribution with progress bars
   - [ ] Widget shows overall health score
   - [ ] Widget shows total tests graded count

5. Edge cases:
   - [ ] Tests with <10 runs show no grade badge (N/A hidden)
   - [ ] Widget shows helpful message if no tests have enough runs
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete and checkpoint approved:
1. `npm run build` - Production build succeeds
2. All STAB requirements verified:
   - STAB-01: Grade calculation with weighted formula
   - STAB-02: Grade filtering and grouping
   - STAB-03: Dashboard health widget
</verification>

<success_criteria>
- TestHealthWidget shows grade distribution
- Dashboard displays widget when history loaded
- All stability features work together (grades, filters, widget)
- User approves visual/functional verification
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-stability-scoring/12-03-SUMMARY.md`
</output>
