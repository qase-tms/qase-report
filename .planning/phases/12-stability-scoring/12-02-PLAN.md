---
phase: 12-stability-scoring
plan: 02
type: execute
wave: 2
depends_on: [12-01]
files_modified:
  - src/components/TestList/StabilityGradeFilter.tsx
  - src/components/TestList/TestListFilters.tsx
  - src/store/TestResultsStore.ts
  - src/components/TestList/TestListItem.tsx
autonomous: true

must_haves:
  truths:
    - "User can filter tests by stability grade"
    - "User can see stability grade badge on each test item"
    - "Filter chips show grade letters (A+, A, B, C, D, F)"
    - "Multiple grade filters can be combined"
  artifacts:
    - path: "src/components/TestList/StabilityGradeFilter.tsx"
      provides: "Filter chips for selecting stability grades"
      exports: ["StabilityGradeFilter"]
    - path: "src/store/TestResultsStore.ts"
      provides: "stabilityGradeFilter state and filtered logic"
      contains: "stabilityGradeFilter"
    - path: "src/components/TestList/TestListItem.tsx"
      provides: "Grade badge display next to stability badge"
      contains: "StabilityGrade"
  key_links:
    - from: "src/components/TestList/StabilityGradeFilter.tsx"
      to: "src/store/TestResultsStore.ts"
      via: "useRootStore() for filter state"
      pattern: "useRootStore"
    - from: "src/components/TestList/TestListItem.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "getStabilityScore for grade display"
      pattern: "analyticsStore\\.getStabilityScore"
    - from: "src/store/TestResultsStore.ts"
      to: "src/store/AnalyticsStore.ts"
      via: "root.analyticsStore for grade filtering"
      pattern: "this\\.root\\.analyticsStore"
---

<objective>
Add stability grade filtering and display to test list.

Purpose: Enable users to group/filter tests by health grade (STAB-02).
Output: StabilityGradeFilter component, TestResultsStore filter state, TestListItem grade badge.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-stability-scoring/12-01-SUMMARY.md
@src/store/TestResultsStore.ts
@src/components/TestList/TestListFilters.tsx
@src/components/TestList/TestListItem.tsx
@src/components/TestList/StabilityBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add stability grade filter state to TestResultsStore</name>
  <files>src/store/TestResultsStore.ts</files>
  <action>
Extend TestResultsStore with stability grade filtering.

1. Import StabilityGrade type:
   `import type { StabilityGrade } from '../types/stability'`

2. Add filter state property:
   `stabilityGradeFilters = new Set<StabilityGrade>()`

3. Add filter toggle method:
   ```typescript
   toggleStabilityGradeFilter = (grade: StabilityGrade) => {
     if (this.stabilityGradeFilters.has(grade)) {
       this.stabilityGradeFilters.delete(grade)
     } else {
       this.stabilityGradeFilters.add(grade)
     }
   }
   ```

4. Update clearFilters to also clear stabilityGradeFilters:
   ```typescript
   clearFilters = () => {
     this.searchQuery = ''
     this.statusFilters.clear()
     this.stabilityGradeFilters.clear()
   }
   ```

5. Update activeFilterCount to include stabilityGradeFilters:
   ```typescript
   get activeFilterCount(): number {
     return this.statusFilters.size + this.stabilityGradeFilters.size + (this.searchQuery.trim() ? 1 : 0)
   }
   ```

6. Update filteredResults computed to apply stability grade filter:
   - After existing status and search filtering
   - If stabilityGradeFilters.size > 0:
     - For each test, get grade from analyticsStore.getStabilityScore(test.signature)
     - Filter to only tests whose grade is in stabilityGradeFilters
     - Handle tests without signature (skip them when filtering by grade)
   - Access analyticsStore via: `this.root.analyticsStore`

Implementation note: The filtering happens in computed property, so it reacts to both test list changes AND filter changes automatically (MobX).
  </action>
  <verify>
`grep -q "stabilityGradeFilters" src/store/TestResultsStore.ts && grep -q "toggleStabilityGradeFilter" src/store/TestResultsStore.ts && echo "Filter state added"`
  </verify>
  <done>
TestResultsStore has stabilityGradeFilters Set, toggleStabilityGradeFilter method, clearFilters updated, activeFilterCount updated, filteredResults applies grade filter.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create StabilityGradeFilter component</name>
  <files>src/components/TestList/StabilityGradeFilter.tsx</files>
  <action>
Create a filter component following TestListFilters.tsx pattern.

1. Import dependencies:
   - Box, Chip, Typography from @mui/material
   - observer from mobx-react-lite
   - useRootStore from store
   - StabilityGrade from types/stability

2. Define grade options with colors:
   ```typescript
   const gradeOptions: { value: StabilityGrade; color: 'success' | 'info' | 'warning' | 'error' | 'default' }[] = [
     { value: 'A+', color: 'success' },
     { value: 'A', color: 'success' },
     { value: 'B', color: 'info' },
     { value: 'C', color: 'warning' },
     { value: 'D', color: 'warning' },
     { value: 'F', color: 'error' },
   ]
   ```
   Note: Exclude 'N/A' from filter options (insufficient data tests shouldn't be filtered to)

3. Create StabilityGradeFilter component:
   - Wrap with observer() for MobX reactivity
   - Get testResultsStore from useRootStore()
   - Render label "Grade:" and chips in a row
   - Each chip: variant filled if in stabilityGradeFilters, outlined otherwise
   - onClick calls toggleStabilityGradeFilter

4. Styling:
   - Use Box with display:flex, gap:1, alignItems:center
   - Small chips (size="small")
   - Label typography variant="body2", color="text.secondary"

Export as named export for use in TestListFilters.
  </action>
  <verify>
`test -f src/components/TestList/StabilityGradeFilter.tsx && grep -q "StabilityGradeFilter" src/components/TestList/StabilityGradeFilter.tsx && echo "Component created"`
  </verify>
  <done>
StabilityGradeFilter.tsx exists with grade chips (A+ through F), uses observer, toggles filters on click, shows filled/outlined variant based on selection.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate StabilityGradeFilter and update TestListItem</name>
  <files>src/components/TestList/TestListFilters.tsx, src/components/TestList/TestListItem.tsx</files>
  <action>
**Part A: Add StabilityGradeFilter to TestListFilters**

1. Import StabilityGradeFilter:
   `import { StabilityGradeFilter } from './StabilityGradeFilter'`

2. Add StabilityGradeFilter below existing status chips:
   - Add a Divider or spacing between status and grade filters
   - Render `<StabilityGradeFilter />` component

Layout:
```tsx
<Box sx={{ display: 'flex', flexDirection: 'column', gap: 2 }}>
  {/* Existing status filters */}
  <Box sx={{ display: 'flex', gap: 1, flexWrap: 'wrap' }}>
    {statuses.map(...)}
  </Box>

  {/* Grade filters */}
  <StabilityGradeFilter />
</Box>
```

**Part B: Add grade badge to TestListItem**

1. Import StabilityGrade display helpers (or inline):
   - Create a helper to get grade color: A+/A=success, B=info, C/D=warning, F=error, N/A=default

2. Get stability score alongside flakiness:
   ```typescript
   const stabilityResult = test.signature
     ? analyticsStore.getStabilityScore(test.signature)
     : null
   ```

3. Display grade badge before StabilityBadge:
   - Only show if stabilityResult exists AND grade !== 'N/A'
   - Use Chip with grade letter, colored by grade level
   - Size="small", sx={{ ml: 1 }} to match StabilityBadge spacing
   - Add Tooltip showing score breakdown: "Score: 85 (Pass: 90%, Flaky: 5%, CV: 10%)"

Implementation:
```tsx
{stabilityResult && stabilityResult.grade !== 'N/A' && (
  <Tooltip title={`Score: ${Math.round(stabilityResult.score)} (Pass: ${Math.round(stabilityResult.passRate)}%, Flaky: ${Math.round(stabilityResult.flakinessPercent)}%, CV: ${Math.round(stabilityResult.durationCV)}%)`}>
    <Chip
      label={stabilityResult.grade}
      size="small"
      color={getGradeColor(stabilityResult.grade)}
      sx={{ ml: 1, minWidth: 32 }}
    />
  </Tooltip>
)}
```

4. Add helper function getGradeColor in the file:
```typescript
const getGradeColor = (grade: StabilityGrade): 'success' | 'info' | 'warning' | 'error' | 'default' => {
  switch (grade) {
    case 'A+':
    case 'A':
      return 'success'
    case 'B':
      return 'info'
    case 'C':
    case 'D':
      return 'warning'
    case 'F':
      return 'error'
    default:
      return 'default'
  }
}
```
  </action>
  <verify>
`grep -q "StabilityGradeFilter" src/components/TestList/TestListFilters.tsx && grep -q "getStabilityScore" src/components/TestList/TestListItem.tsx && npm run build 2>&1 | grep -q "error" && echo "Build errors" || echo "Build OK"`
  </verify>
  <done>
TestListFilters renders StabilityGradeFilter. TestListItem shows grade badge with tooltip containing score breakdown. Build passes.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` - TypeScript compilation succeeds
2. `npm run dev` - App runs, TestList shows grade badges and filters
3. Grade filter chips visible in test list header
4. Clicking grade filter updates test list
5. Grade badges show on test items with tooltips
</verification>

<success_criteria>
- User can click grade chips (A+ through F) to filter tests
- Multiple grades can be selected simultaneously
- Grade badges appear on TestListItem with color coding
- Tooltip shows score breakdown (pass rate, flakiness, CV)
- Clear filters also clears grade selection
- Build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-stability-scoring/12-02-SUMMARY.md`
</output>
