---
phase: 19-top-bar-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/SearchModal/index.tsx
  - src/components/ExportButton/index.tsx
  - src/components/RunDateDisplay/index.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can open search with Cmd+K (Mac) or Ctrl+K (Windows/Linux)"
    - "Search shows results as user types (test names)"
    - "Selecting a search result opens test details"
    - "Export button downloads current report as JSON"
    - "Run date/time displayed prominently in top bar center"
  artifacts:
    - path: "src/components/SearchModal/index.tsx"
      provides: "Command palette search modal"
      exports: ["SearchModal"]
    - path: "src/components/ExportButton/index.tsx"
      provides: "JSON export download button"
      exports: ["ExportButton"]
    - path: "src/components/RunDateDisplay/index.tsx"
      provides: "Formatted run date/time display"
      exports: ["RunDateDisplay"]
    - path: "src/App.tsx"
      provides: "Updated AppBar with search, export, date display"
      contains: "useHotkeys"
  key_links:
    - from: "src/App.tsx"
      to: "src/components/SearchModal/index.tsx"
      via: "useHotkeys mod+k triggers setSearchOpen(true)"
      pattern: "useHotkeys.*mod\\+k"
    - from: "src/components/SearchModal/index.tsx"
      to: "RootStore"
      via: "useRootStore().selectTest() on result click"
      pattern: "selectTest"
    - from: "src/components/ExportButton/index.tsx"
      to: "RootStore stores"
      via: "Blob export of reportStore.runData + testResultsStore.resultsList"
      pattern: "createObjectURL"
    - from: "src/components/RunDateDisplay/index.tsx"
      to: "reportStore.runData"
      via: "execution.start_time with Intl.DateTimeFormat"
      pattern: "DateTimeFormat"
---

<objective>
Redesign the top bar with command palette search, export functionality, and prominent run date display.

Purpose: Enable quick test navigation via keyboard (Cmd+K), allow report download, and show run timing prominently per Playwright Smart Reporter design.

Output: Three new components (SearchModal, ExportButton, RunDateDisplay) and updated App.tsx with new AppBar layout.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-top-bar-redesign/19-RESEARCH.md

# Existing code
@src/App.tsx
@src/store/index.tsx
@src/store/ReportStore.ts
@src/store/TestResultsStore.ts
@src/components/ThemeToggle/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-hotkeys-hook and create SearchModal</name>
  <files>
    package.json
    src/components/SearchModal/index.tsx
  </files>
  <action>
1. Install react-hotkeys-hook:
   ```bash
   npm install react-hotkeys-hook
   ```

2. Create `src/components/SearchModal/index.tsx`:
   - MobX observer component accepting props: `open: boolean`, `onClose: () => void`
   - Use MUI Dialog with `fullWidth` and `maxWidth="md"` for responsive modal
   - TextField with `autoFocus`, `fullWidth`, placeholder "Search tests..."
   - Local state for search query (useState)
   - Filter `testResultsStore.resultsList` by title (case-insensitive includes)
   - List of results using MUI List/ListItem/ListItemButton/ListItemText
   - Show test title as primary, status + suite as secondary
   - On result click: call `root.selectTest(test.id)` then `onClose()`
   - Limit displayed results to first 10 for performance
   - Show "No results found" when query has no matches
   - Show "Type to search tests..." when query is empty

Key patterns from research:
- Dialog handles Escape key automatically via onClose
- autoFocus on TextField for immediate typing
- Filter logic: `test.title.toLowerCase().includes(query.toLowerCase())`
  </action>
  <verify>
    - `npm ls react-hotkeys-hook` shows package installed
    - `ls src/components/SearchModal/index.tsx` confirms file exists
    - No TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>
    - react-hotkeys-hook is installed
    - SearchModal component renders MUI Dialog with search input and results list
    - Clicking a result calls selectTest and closes modal
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ExportButton and RunDateDisplay components</name>
  <files>
    src/components/ExportButton/index.tsx
    src/components/RunDateDisplay/index.tsx
  </files>
  <action>
1. Create `src/components/ExportButton/index.tsx`:
   - MobX observer component (no props)
   - Use `useRootStore()` to access `reportStore` and `testResultsStore`
   - MUI IconButton with Download icon from @mui/icons-material
   - `disabled` when `!reportStore.runData`
   - `color="inherit"` for AppBar compatibility
   - `aria-label="Export report"`
   - onClick handler:
     a. Return early if no runData
     b. Create export object: `{ run: reportStore.runData, results: testResultsStore.resultsList }`
     c. Create Blob with `JSON.stringify(exportData, null, 2)`, type: 'application/json'
     d. Create URL with `URL.createObjectURL(blob)`
     e. Create anchor element, set href, download filename: `qase-report-${Date.now()}.json`
     f. Append to body, click(), remove from body
     g. CRITICAL: `setTimeout(() => URL.revokeObjectURL(url), 100)` to prevent memory leak

2. Create `src/components/RunDateDisplay/index.tsx`:
   - MobX observer component (no props)
   - Use `useRootStore()` to access `reportStore`
   - Return null if `!reportStore.runData`
   - Extract `start_time` from `reportStore.runData.execution.start_time`
   - Format using `Intl.DateTimeFormat('en-US', { dateStyle: 'medium', timeStyle: 'short' })`
   - Render MUI Typography with `variant="body2"`, `color="text.secondary"`
   - Display format: "Feb 10, 2026 at 2:30 PM"
  </action>
  <verify>
    - `ls src/components/ExportButton/index.tsx` confirms file exists
    - `ls src/components/RunDateDisplay/index.tsx` confirms file exists
    - No TypeScript errors: `npx tsc --noEmit`
  </verify>
  <done>
    - ExportButton renders disabled IconButton when no report, enabled when loaded
    - Clicking ExportButton downloads JSON file with run + results data
    - RunDateDisplay shows formatted date/time from run.execution.start_time
  </done>
</task>

<task type="auto">
  <name>Task 3: Update App.tsx with new AppBar layout and keyboard shortcut</name>
  <files>
    src/App.tsx
  </files>
  <action>
1. Add imports to App.tsx:
   - `import { useState } from 'react'`
   - `import { useHotkeys } from 'react-hotkeys-hook'`
   - `import { IconButton } from '@mui/material'`
   - `import { Search as SearchIcon } from '@mui/icons-material'`
   - `import { SearchModal } from './components/SearchModal'`
   - `import { ExportButton } from './components/ExportButton'`
   - `import { RunDateDisplay } from './components/RunDateDisplay'`

2. Add state and hook inside App component:
   ```typescript
   const [isSearchOpen, setSearchOpen] = useState(false)

   useHotkeys('mod+k', (e) => {
     e.preventDefault()
     setSearchOpen(true)
   }, {
     enableOnFormTags: false,
     preventDefault: true
   })
   ```

3. Update Toolbar layout for three sections (left/center/right):
   ```tsx
   <Toolbar variant="dense">
     {/* Left: Title */}
     <Box sx={{ display: 'flex', alignItems: 'center' }}>
       <Typography variant="h6" component="div">
         Qase | Report
       </Typography>
     </Box>

     {/* Center: Run Date (pushed by flexGrow) */}
     <Box sx={{ flexGrow: 1, display: 'flex', justifyContent: 'center' }}>
       <RunDateDisplay />
     </Box>

     {/* Right: Actions */}
     <Box sx={{ display: 'flex', alignItems: 'center', gap: 0.5 }}>
       <IconButton
         color="inherit"
         onClick={() => setSearchOpen(true)}
         aria-label="Search tests (Cmd+K)"
       >
         <SearchIcon />
       </IconButton>
       <ExportButton />
       <ThemeToggle />
     </Box>
   </Toolbar>
   ```

4. Add SearchModal at the end of App component (before closing ThemeRegistry tag):
   ```tsx
   <SearchModal open={isSearchOpen} onClose={() => setSearchOpen(false)} />
   ```

5. Import Typography from @mui/material if not already imported.
  </action>
  <verify>
    - `npm run build` completes without errors
    - `npm run dev` starts successfully
    - Open app in browser:
      - AppBar shows "Qase | Report" on left
      - Run date appears centered (after loading report)
      - Search icon, Download icon, Theme toggle visible on right
      - Press Cmd+K (Mac) or Ctrl+K (Windows) opens search modal
      - Search modal shows input field, typing filters results
      - Clicking result opens test details sidebar
      - Export button downloads JSON when report loaded
  </verify>
  <done>
    - App.tsx imports and renders all new components
    - Cmd+K / Ctrl+K opens SearchModal
    - AppBar has three-section layout: title | date | actions
    - All four TOP requirements met (TOP-01 through TOP-04)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Keyboard shortcut (TOP-01)**:
   - Load app, press Cmd+K (Mac) or Ctrl+K (Windows)
   - Search modal should open
   - Press Escape to close
   - Verify shortcut doesn't fire when typing in other inputs

2. **Search results (TOP-01 continued)**:
   - Load a report
   - Open search (Cmd+K)
   - Type part of a test name
   - Verify results filter as you type
   - Click a result, verify test details sidebar opens

3. **Export button (TOP-02)**:
   - Load a report
   - Click download icon in top bar
   - Verify JSON file downloads with run + results data
   - Verify button is disabled before report is loaded

4. **Theme toggle (TOP-03)**:
   - Verify theme toggle still visible and functional in top bar

5. **Run date display (TOP-04)**:
   - Load a report
   - Verify date appears centered in top bar
   - Format should be like "Feb 10, 2026 at 2:30 PM"
</verification>

<success_criteria>
- [ ] react-hotkeys-hook installed and working
- [ ] Cmd+K / Ctrl+K opens search modal
- [ ] Search filters tests by title as user types
- [ ] Selecting search result opens test details
- [ ] Export button downloads JSON report
- [ ] Run date/time displayed centered in top bar
- [ ] Theme toggle remains functional
- [ ] No TypeScript errors
- [ ] Build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/19-top-bar-redesign/19-01-SUMMARY.md`
</output>
