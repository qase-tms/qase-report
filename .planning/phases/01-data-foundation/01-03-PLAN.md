---
phase: 01-data-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/components/LoadReportButton/index.tsx
  - src/layout/MainLayout/index.tsx
autonomous: false

must_haves:
  truths:
    - "User can click button to open directory picker"
    - "User can select qase-report directory and see loading progress"
    - "User sees error message if directory is invalid or files are malformed"
    - "Parsed run.json metadata is accessible in state after load completes"
    - "Test results collection is accessible in state after load completes"
  artifacts:
    - path: "src/components/LoadReportButton/index.tsx"
      provides: "Button component with file input using webkitdirectory"
      exports: ["LoadReportButton"]
      min_lines: 40
    - path: "src/layout/MainLayout/index.tsx"
      provides: "Updated MainLayout rendering LoadReportButton"
      contains: "LoadReportButton"
  key_links:
    - from: "src/components/LoadReportButton/index.tsx"
      to: "src/store/index.tsx"
      via: "useRootStore hook access"
      pattern: "useRootStore\\(\\)"
    - from: "src/components/LoadReportButton/index.tsx"
      to: "src/store/index.tsx"
      via: "loadReport method call"
      pattern: "rootStore\\.loadReport"
    - from: "src/layout/MainLayout/index.tsx"
      to: "src/components/LoadReportButton/index.tsx"
      via: "component import and JSX usage"
      pattern: "import.*LoadReportButton|<LoadReportButton"
---

<objective>
Create UI component for directory selection and wire to MobX stores with loading states and verification output.

Purpose: Enable user to load Qase Report directory via File API, display progress and errors, and verify data is correctly parsed by logging to console. This completes Phase 1 success criteria: user can load run.json and results/*.json and see parsed data.

Output: LoadReportButton component integrated into MainLayout with file input, loading states, error display, and console verification output.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
@.planning/phases/01-data-foundation/01-01-SUMMARY.md
@.planning/phases/01-data-foundation/01-02-SUMMARY.md
@src/store/index.tsx
@src/layout/MainLayout/index.tsx
@src/components/Sidebar/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LoadReportButton component</name>
  <files>
    src/components/LoadReportButton/index.tsx
  </files>
  <action>
Create LoadReportButton component with file input and loading states:

**Component structure:**
```typescript
export const LoadReportButton = observer(() => {
  const { reportStore, testResultsStore, loadReport } = useRootStore()
  const inputRef = useRef<HTMLInputElement>(null)

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    // Call loadReport, handle errors, log to console
  }

  return (
    <Box>
      <input
        ref={inputRef}
        type="file"
        webkitdirectory="true"
        multiple
        style={{ display: 'none' }}
        onChange={handleFileSelect}
      />
      <Button onClick={() => inputRef.current?.click()} disabled={...}>
        {/* Loading state text */}
      </Button>
      {/* Error Alert if error exists */}
    </Box>
  )
})
```

**Implementation details:**
- Import: observer from mobx-react-lite, useRootStore from store, Button/Box/Alert from @mui/material, useRef from react
- Wrap component with observer() for reactive updates
- Use hidden file input with webkitdirectory="true" and multiple attributes (research Pattern 3)
- Button triggers input click via ref
- Button disabled when reportStore.isLoading OR testResultsStore.isLoading
- Button text shows loading progress: "Loading {current}/{total}..." when loading, "Load Report Directory" when idle
- handleFileSelect:
  - Check `e.target.files` exists
  - Call `await loadReport(e.target.files)` wrapped in try-catch
  - On success: console.log runData metadata and test results count
  - On error: display error (stores handle error state)
- Display Alert with severity="error" if reportStore.error OR testResultsStore.error exists
- Add console verification output after successful load:
  ```typescript
  console.log('Run loaded:', reportStore.runData)
  console.log('Test results loaded:', testResultsStore.resultsList.length)
  ```

Follow research patterns from RESEARCH.md "Pattern 3: File API with webkitdirectory" and "Code Examples > React Component Usage".

Follow codebase conventions: observer wrapper, useRootStore hook, MUI components, Prettier formatting (no semicolons, single quotes, 2 spaces).
  </action>
  <verify>
Run TypeScript compiler:
```bash
npx tsc --noEmit
```

Check component exports:
```bash
grep "export.*LoadReportButton" src/components/LoadReportButton/index.tsx
```

Verify observer usage:
```bash
grep "observer" src/components/LoadReportButton/index.tsx
```

Verify webkitdirectory attribute:
```bash
grep "webkitdirectory" src/components/LoadReportButton/index.tsx
```
  </verify>
  <done>
- LoadReportButton component exists and exports as observer-wrapped function
- Component has hidden file input with webkitdirectory="true" and multiple
- Button triggers file input click and shows loading state
- Component uses useRootStore to access stores
- Error Alert displays when store errors exist
- Console logs verification output on successful load
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate LoadReportButton into MainLayout</name>
  <files>
    src/layout/MainLayout/index.tsx
  </files>
  <action>
Update MainLayout to render LoadReportButton component:

**Changes to src/layout/MainLayout/index.tsx:**

1. Import LoadReportButton:
```typescript
import { LoadReportButton } from '../../components/LoadReportButton'
```

2. Add LoadReportButton to main content area in Grid layout:
- Place LoadReportButton in main Grid item (existing content area)
- Position prominently (e.g., top of content area or center)
- Keep existing "Open sidebar" button and Sidebar component intact

Example placement:
```typescript
<Grid item xs={12}>
  <LoadReportButton />
  <Button onClick={openDock}>Open sidebar</Button>
</Grid>
```

Preserve existing MainLayout structure (Grid layout, AppBar, Sidebar integration, openDock/closeDock functionality).

Follow codebase conventions from existing MainLayout pattern.
  </action>
  <verify>
Run TypeScript compiler:
```bash
npx tsc --noEmit
```

Check LoadReportButton import:
```bash
grep "import.*LoadReportButton" src/layout/MainLayout/index.tsx
```

Verify LoadReportButton JSX usage:
```bash
grep "<LoadReportButton" src/layout/MainLayout/index.tsx
```
  </verify>
  <done>
- MainLayout imports LoadReportButton component
- LoadReportButton rendered in main content area
- Existing MainLayout functionality preserved (sidebar, grid layout)
- TypeScript compilation succeeds
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Human verification of complete data loading flow</name>
  <action>
Request human verification of complete data loading flow from UI to store with File API directory selection, Zod validation, MobX reactive stores, and console verification output.

Claude has:
1. Created Zod schemas for run.json, test results, steps, and attachments with TypeScript inference
2. Built FileLoaderService, ParserService, and AttachmentService for file handling
3. Implemented ReportStore, TestResultsStore, and AttachmentsStore with MobX observables
4. Integrated stores into RootStore with loadReport coordinator method
5. Created LoadReportButton component with webkitdirectory file input
6. Added LoadReportButton to MainLayout for user access
  </action>
  <how-to-verify>
**Step 1: Start dev server**
```bash
npm run dev
```

**Step 2: Open application in browser**
- Navigate to URL shown in terminal (typically http://localhost:5173)
- Verify UI loads with "Load Report Directory" button visible

**Step 3: Prepare test data**
- You need a qase-report directory with structure:
  - `run.json` (metadata file)
  - `results/` directory with `*.json` test result files
  - `attachments/` directory (optional)

If you don't have test data, you can create minimal test files for verification:

**Minimal run.json:**
```json
{
  "title": "Test Run",
  "environment": "dev",
  "execution": {
    "start_time": 1234567890,
    "end_time": 1234567900,
    "duration": 10,
    "cumulative_duration": 10
  },
  "stats": {
    "total": 2,
    "passed": 1,
    "failed": 1,
    "skipped": 0,
    "broken": 0,
    "muted": 0
  },
  "results": [
    {"id": "test-1", "title": "Test 1", "status": "passed", "duration": 5, "thread": null},
    {"id": "test-2", "title": "Test 2", "status": "failed", "duration": 5, "thread": null}
  ],
  "threads": [],
  "suites": [],
  "host_data": {
    "node": "test-node",
    "system": "Linux",
    "release": "5.0",
    "version": "1.0",
    "machine": "x64"
  }
}
```

**Minimal results/test-1.json:**
```json
{
  "id": "test-1",
  "title": "Test 1",
  "signature": "sig-1",
  "muted": false,
  "execution": {
    "status": "passed",
    "start_time": 1234567890,
    "end_time": 1234567895,
    "duration": 5,
    "stacktrace": null,
    "thread": null
  },
  "message": null,
  "relations": null,
  "steps": [],
  "attachments": [],
  "params": {},
  "param_groups": [],
  "fields": {}
}
```

**Step 4: Test directory loading**
- Click "Load Report Directory" button
- File picker should open (browser's native directory picker)
- Select your qase-report directory
- Observe loading state: button text changes to "Loading X/Y..."
- Wait for loading to complete

**Step 5: Verify success**
- Button returns to "Load Report Directory" state (not loading)
- No error message displayed below button
- Open browser DevTools Console (F12)
- Verify console output shows:
  ```
  Run loaded: {title: "...", stats: {...}, ...}
  Test results loaded: N
  ```
  (N = number of JSON files in results/ directory)

**Step 6: Verify error handling**
- Try loading a directory WITHOUT run.json
- Verify error message displays: "run.json not found in selected directory"
- Try loading a directory with malformed JSON
- Verify error message displays validation details from Zod

**Expected outcomes:**
✅ Button is clickable and opens directory picker
✅ Loading progress shows "Loading X/Y..." during load
✅ Console logs display parsed run.json data
✅ Console logs display correct count of test results
✅ Error messages display for invalid directories or malformed JSON
✅ No browser errors or warnings in console
✅ TypeScript compilation has no errors

**Common issues:**
- Directory picker not opening: Check browser support (Chrome/Edge/Firefox desktop required; Safari/iOS limited support)
- "run.json not found": Ensure run.json exists at root of selected directory
- Validation errors: Check JSON structure matches Zod schemas
- Console errors about modules: Run `npm install` to ensure all dependencies installed
  </how-to-verify>
  <resume-signal>
Type **"approved"** if all verification steps pass and console shows parsed data.

If issues found, describe the specific problem (e.g., "Error message shows X" or "Console logs Y instead of Z").
  </resume-signal>
</task>

</tasks>

<verification>
Human verification checkpoint ensures:
1. File API directory selection works in browser
2. Zod validation accepts valid JSON and rejects invalid JSON
3. MobX stores correctly parse and store data
4. Loading states display correctly in UI
5. Error states display user-friendly messages
6. Console output confirms data is accessible from stores

This completes Phase 1 success criteria:
- ✓ User can load run.json and see parsed metadata in console/state
- ✓ User can load results/*.json and see parsed test results in state
- ✓ Application resolves attachment paths and makes them accessible (blob URLs registered)
- ✓ MobX store holds complete report data structure
</verification>

<success_criteria>
- LoadReportButton component renders in MainLayout
- Clicking button opens browser directory picker with webkitdirectory
- Valid qase-report directory loads successfully with progress indicator
- Console logs show parsed run.json metadata object
- Console logs show correct count of test results loaded
- Error messages display for missing run.json or malformed JSON
- Loading states prevent duplicate loads (button disabled)
- MobX stores react to state changes (observer pattern working)
- No TypeScript or runtime errors in console
- Phase 1 goal achieved: Application can load and parse Qase Report Format JSON files
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-03-SUMMARY.md`
</output>
