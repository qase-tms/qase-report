---
phase: 01-data-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/schemas/QaseRun.schema.ts
  - src/schemas/QaseTestResult.schema.ts
  - src/schemas/Step.schema.ts
  - src/schemas/Attachment.schema.ts
  - src/types/qase-report.types.ts
  - src/services/FileLoaderService.ts
  - src/services/ParserService.ts
  - src/services/AttachmentService.ts
autonomous: true

must_haves:
  truths:
    - "Run metadata can be validated before loading into state"
    - "Test result files can be validated with detailed error messages"
    - "Application can read arbitrary files from File API"
    - "JSON parsing produces typed data matching Qase Report Format"
  artifacts:
    - path: "src/schemas/QaseRun.schema.ts"
      provides: "Zod schema for run.json with TypeScript type inference"
      exports: ["QaseRunSchema", "QaseRun"]
      min_lines: 40
    - path: "src/schemas/QaseTestResult.schema.ts"
      provides: "Zod schema for test result with nested steps and attachments"
      exports: ["TestResultSchema", "QaseTestResult"]
      min_lines: 50
    - path: "src/services/FileLoaderService.ts"
      provides: "File API operations for directory loading"
      exports: ["FileLoaderService"]
      min_lines: 30
    - path: "src/services/ParserService.ts"
      provides: "JSON parsing with Zod validation"
      exports: ["ParserService"]
      min_lines: 25
    - path: "src/services/AttachmentService.ts"
      provides: "Blob URL creation and cleanup"
      exports: ["AttachmentService"]
      min_lines: 30
  key_links:
    - from: "src/services/ParserService.ts"
      to: "src/schemas/*.schema.ts"
      via: "schema imports and safeParse calls"
      pattern: "import.*Schema.*from.*schemas"
    - from: "src/types/qase-report.types.ts"
      to: "src/schemas/*.schema.ts"
      via: "z.infer type extraction"
      pattern: "z\\.infer<typeof.*Schema>"
---

<objective>
Create validated data schemas and file handling services for Qase Report Format JSON parsing.

Purpose: Establish type-safe foundation for loading and validating report data before storing in MobX. Prevents runtime errors from malformed JSON and provides automatic TypeScript types.

Output: Zod schemas matching Qase Report Format structure, services for File API operations, JSON parsing with validation, and attachment blob URL management.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
@src/store/index.tsx
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Zod and create schemas</name>
  <files>
    package.json
    package-lock.json
    src/schemas/QaseRun.schema.ts
    src/schemas/QaseTestResult.schema.ts
    src/schemas/Step.schema.ts
    src/schemas/Attachment.schema.ts
    src/types/qase-report.types.ts
  </files>
  <action>
Install Zod library:
```bash
npm install zod
```

Create Zod schemas matching Qase Report Format structure from research:

**src/schemas/Attachment.schema.ts:**
- Define AttachmentSchema with fields: id, file_name, file_path, mime_type, size (optional), content (nullable optional), temporary (optional)
- Export inferred TypeScript type: `export type Attachment = z.infer<typeof AttachmentSchema>`

**src/schemas/Step.schema.ts:**
- Define StepSchema as recursive type using z.lazy() for nested steps
- Fields: id, step_type (enum: text/request/assertion), parent_id (nullable), data (action, expected_result, input_data), execution (status, start_time, end_time, duration, attachments array), steps (recursive array)
- Export inferred type: `export type Step = z.infer<typeof StepSchema>`

**src/schemas/QaseTestResult.schema.ts:**
- Define TestResultSchema with fields: id, title, signature, muted, execution (status enum: passed/failed/skipped/broken, start_time, end_time, duration, stacktrace nullable, thread nullable), message (nullable), relations (nullable object with suite.data array), steps array, attachments array, params (record), param_groups (array of string arrays), fields (record), testops_ids (nullable optional array)
- Import AttachmentSchema and StepSchema
- Export inferred type: `export type QaseTestResult = z.infer<typeof TestResultSchema>`

**src/schemas/QaseRun.schema.ts:**
- Define QaseRunSchema with fields: title, environment (nullable optional), execution (start_time, end_time, duration, cumulative_duration), stats (total, passed, failed, skipped, broken, muted), results (array with id, title, status, duration, thread nullable), threads (string array), suites (string array), host_data (node, system, release, version, machine, python optional)
- Export inferred type: `export type QaseRun = z.infer<typeof QaseRunSchema>`

**src/types/qase-report.types.ts:**
- Re-export all types from schemas for centralized import: `export type { QaseRun, QaseTestResult, Step, Attachment } from '../schemas'`

Follow research patterns from RESEARCH.md sections "Pattern 2: Zod Schema with TypeScript Inference" and "Code Examples > Zod Schema Example".
  </action>
  <verify>
Run TypeScript compiler to verify no errors:
```bash
npx tsc --noEmit
```

Check Zod is installed:
```bash
npm list zod
```

Verify schemas export correct types by checking file structure with grep:
```bash
grep -l "export.*Schema" src/schemas/*.ts
grep -l "z.infer" src/schemas/*.ts
```
  </verify>
  <done>
- Zod appears in package.json dependencies
- All 4 schema files exist in src/schemas/
- Each schema file exports both Schema constant and inferred TypeScript type
- TypeScript compilation succeeds with no errors
- Types file re-exports all types for centralized access
  </done>
</task>

<task type="auto">
  <name>Task 2: Create FileLoaderService</name>
  <files>
    src/services/FileLoaderService.ts
  </files>
  <action>
Create FileLoaderService class for File API operations:

**Class structure:**
```typescript
export class FileLoaderService {
  async loadReportDirectory(files: FileList): Promise<{
    runFile: File | null
    resultFiles: File[]
    attachmentFiles: File[]
  }>

  async readAsText(file: File): Promise<string>
}
```

**Implementation details:**
- `loadReportDirectory`: Convert FileList to array, filter by webkitRelativePath:
  - runFile: ends with 'run.json'
  - resultFiles: includes '/results/' AND ends with '.json'
  - attachmentFiles: includes '/attachments/'
- `readAsText`: Use modern File API `.text()` method (not FileReader events), return promise

Follow research pattern from RESEARCH.md "Pattern 3: File API with webkitdirectory" and "Code Examples > Complete File Loading Flow".

Use TypeScript with proper typing (no any types).
  </action>
  <verify>
Run TypeScript compiler:
```bash
npx tsc --noEmit
```

Check file exports class:
```bash
grep "export class FileLoaderService" src/services/FileLoaderService.ts
```
  </verify>
  <done>
- FileLoaderService.ts exists and exports FileLoaderService class
- Class has loadReportDirectory and readAsText methods
- Methods return properly typed promises
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Create ParserService and AttachmentService</name>
  <files>
    src/services/ParserService.ts
    src/services/AttachmentService.ts
  </files>
  <action>
Create ParserService for validated JSON parsing:

**src/services/ParserService.ts:**
```typescript
export class ParserService {
  async parseJSON<T>(text: string, schema: z.ZodSchema<T>): Promise<T>
}
```
- Use `schema.safeParse(JSON.parse(text))`
- If `!result.success`, throw Error with `result.error.message`
- If success, return `result.data` (type-safe T)
- Use Zod's safeParse (not parse) to get validation details before throwing

Create AttachmentService for blob URL management:

**src/services/AttachmentService.ts:**
```typescript
export class AttachmentService {
  private blobUrls: Map<string, string>

  registerAttachment(id: string, file: File): string
  getAttachmentUrl(id: string): string | undefined
  cleanup(): void
}
```
- `registerAttachment`: Create blob URL with `URL.createObjectURL(file)`, store in Map, return URL
- `getAttachmentUrl`: Return URL from Map or undefined
- `cleanup`: Call `URL.revokeObjectURL(url)` for each URL, then clear Map

Follow research patterns from RESEARCH.md "Pattern 4: Blob URL Management for Attachments" and "Common Pitfalls > Pitfall 2: Memory Leaks from Blob URLs".

CRITICAL: Include cleanup method to prevent memory leaks (Pitfall 2 in research).
  </action>
  <verify>
Run TypeScript compiler:
```bash
npx tsc --noEmit
```

Check both services export classes:
```bash
grep "export class" src/services/*.ts
```

Verify ParserService imports Zod:
```bash
grep "import.*zod" src/services/ParserService.ts
```
  </verify>
  <done>
- ParserService.ts exists and exports ParserService class with parseJSON method
- AttachmentService.ts exists and exports AttachmentService class with registerAttachment, getAttachmentUrl, cleanup methods
- ParserService imports Zod and uses safeParse for validation
- AttachmentService uses URL.createObjectURL and URL.revokeObjectURL
- TypeScript compilation succeeds with no errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify all files exist:
```bash
ls src/schemas/*.schema.ts src/services/*.ts src/types/qase-report.types.ts
```

2. Run full TypeScript check:
```bash
npx tsc --noEmit
```

3. Verify Zod installation:
```bash
npm list zod
```

4. Check schema exports:
```bash
grep -h "export.*Schema\|export type" src/schemas/*.ts
```

All checks should pass with no errors.
</verification>

<success_criteria>
- Zod 3.x installed in package.json
- 4 schema files created with Zod schemas and inferred TypeScript types
- Types file centrally exports all types
- FileLoaderService handles File API operations for directory loading
- ParserService validates JSON with Zod schemas using safeParse
- AttachmentService manages blob URLs with cleanup to prevent memory leaks
- All TypeScript compilation succeeds with no errors
- Services follow research patterns (no FileReader events, modern File.text() API)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-01-SUMMARY.md`
</output>
