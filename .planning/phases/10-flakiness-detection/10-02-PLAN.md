---
phase: 10-flakiness-detection
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - src/components/TestList/StabilityBadge.tsx
  - src/components/TestList/TestListItem.tsx
autonomous: false

must_haves:
  truths:
    - "User sees stability badges on test list items (flaky, stable, new failure)"
    - "User sees flakiness percentage showing 'flaky in X of Y runs'"
    - "Badges only appear when sufficient history data exists (5+ runs)"
  artifacts:
    - path: "src/components/TestList/StabilityBadge.tsx"
      provides: "Visual stability indicator component"
      exports: ["StabilityBadge"]
      min_lines: 40
    - path: "src/components/TestList/TestListItem.tsx"
      provides: "Test item with stability badge integration"
      contains: "StabilityBadge"
  key_links:
    - from: "src/components/TestList/TestListItem.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "useRootStore().analyticsStore.getFlakinessScore"
      pattern: "getFlakinessScore"
    - from: "src/components/TestList/StabilityBadge.tsx"
      to: "src/types/flakiness.ts"
      via: "FlakinessResult prop type"
      pattern: "FlakinessResult"
---

<objective>
Create StabilityBadge component and integrate into TestListItem

Purpose: Provide visual feedback to users about test stability directly in the test list, showing flaky/stable/new_failure badges with flakiness percentage.

Output: StabilityBadge component showing status and "flaky in X of Y runs", integrated into TestListItem for tests with sufficient history.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-flakiness-detection/10-01-SUMMARY.md
@src/components/TestList/TestListItem.tsx
@src/types/flakiness.ts
@src/store/AnalyticsStore.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StabilityBadge component</name>
  <files>src/components/TestList/StabilityBadge.tsx</files>
  <action>
Create StabilityBadge component that displays test stability status.

Props:
```typescript
interface StabilityBadgeProps {
  result: FlakinessResult
}
```

Implementation:
1. Import Chip and Tooltip from MUI
2. Import FlakinessResult from '../../types/flakiness'
3. Return null if `result.status === 'insufficient_data'` (badge hidden when < 5 runs)

Badge appearance by status:
- **flaky**: Chip with color="warning", icon=LoopIcon (from @mui/icons-material), label shows "Flaky"
- **stable**: Chip with color="success", icon=CheckCircleIcon, label shows "Stable"
- **new_failure**: Chip with color="error", icon=NewReleasesIcon, label shows "New Failure"

Tooltip shows detailed info (FLKY-03):
- For flaky: "Flaky in {statusChanges} of {totalRuns} runs ({flakinessPercent}%)"
- For stable: "Stable across {totalRuns} runs"
- For new_failure: "Started failing after {N} stable runs"

Use Chip size="small" and sx={{ ml: 1, height: 20 }} for compact display.

Export as named export: `export const StabilityBadge = ...`
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>StabilityBadge component renders appropriate badge based on FlakinessResult status</done>
</task>

<task type="auto">
  <name>Task 2: Integrate StabilityBadge into TestListItem</name>
  <files>src/components/TestList/TestListItem.tsx</files>
  <action>
Update TestListItem to show stability badges for tests with history.

Changes:
1. Import useRootStore from '../../store'
2. Import StabilityBadge from './StabilityBadge'
3. Remove memo() wrapper (need store access, MobX observer handles optimization)
4. Wrap component with observer() from 'mobx-react-lite'

Inside component:
1. Get analyticsStore from useRootStore()
2. Get flakiness result: `const flakinessResult = test.signature ? analyticsStore.getFlakinessScore(test.signature) : null`
3. Only call getFlakinessScore if test.signature exists (some tests may not have signatures)

In JSX, add StabilityBadge after ListItemText:
```tsx
<ListItemText
  primary={test.title}
  secondary={durationText}
  primaryTypographyProps={{ noWrap: true }}
/>
{flakinessResult && <StabilityBadge result={flakinessResult} />}
```

This places the badge on the right side of each test list item, showing stability status when history data exists.

Note: StabilityBadge handles insufficient_data internally (returns null), so we just pass the result.
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit`</verify>
  <done>TestListItem shows StabilityBadge for tests with sufficient history data</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify flakiness detection UI</name>
  <files>n/a</files>
  <action>
Human verification of complete flakiness detection implementation with stability badges.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173
3. Load a report directory with test-history.json containing 5+ runs for some tests
4. Navigate to test list and verify:
   - Tests with 5+ runs show stability badges (Flaky/Stable/New Failure)
   - Tests with fewer than 5 runs show no badge (correct - insufficient data)
   - Hover over badge to see tooltip with "flaky in X of Y runs" detail
   - Badge colors: warning (orange) for flaky, success (green) for stable, error (red) for new failure

If no test-history.json with sufficient runs available:
- Create manual test by loading report multiple times (addCurrentRun accumulates history)
- Or verify badges don't appear (correct behavior for insufficient data)
  </verify>
  <done>
User confirms flakiness detection UI works correctly:
- StabilityBadge shows appropriate status (flaky/stable/new_failure)
- Badge hidden when insufficient data (< 5 runs)
- Tooltips show flakiness percentage
- Colors match status (warning/success/error)
  </done>
</task>

</tasks>

<verification>
After all tasks:
1. `npx tsc --noEmit` passes
2. StabilityBadge component exists with proper styling
3. TestListItem imports and renders StabilityBadge
4. Badges visible on test list items with sufficient history
5. Tooltips show flakiness percentage per FLKY-03
</verification>

<success_criteria>
- StabilityBadge shows flaky/stable/new_failure with appropriate colors
- StabilityBadge hidden when insufficient_data (< 5 runs)
- TestListItem displays badge for tests with signatures
- Tooltip shows "flaky in X of Y runs" format
- Human verification confirms visual appearance and functionality
</success_criteria>

<output>
After completion, create `.planning/phases/10-flakiness-detection/10-02-SUMMARY.md`
</output>
