---
phase: 06-attachments-viewer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/store/AttachmentViewerStore.ts
  - src/store/index.tsx
autonomous: true

must_haves:
  truths:
    - "AttachmentViewerStore manages viewer open/close state"
    - "AttachmentViewerStore tracks current attachment and related list"
    - "Libraries installed for image lightbox and syntax highlighting"
  artifacts:
    - path: "src/store/AttachmentViewerStore.ts"
      provides: "Viewer state management"
      exports: ["AttachmentViewerStore"]
    - path: "package.json"
      provides: "New dependencies"
      contains: "yet-another-react-lightbox"
  key_links:
    - from: "src/store/index.tsx"
      to: "src/store/AttachmentViewerStore.ts"
      via: "RootStore property"
      pattern: "attachmentViewerStore.*AttachmentViewerStore"
---

<objective>
Install viewer libraries and create AttachmentViewerStore for centralized viewer state management.

Purpose: Provides foundation for image/text viewers accessible from multiple locations (test details, steps)
Output: Working MobX store for viewer state, dependencies installed
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-attachments-viewer/06-RESEARCH.md

@src/store/index.tsx
@src/store/AttachmentsStore.ts
@src/schemas/Attachment.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install viewer libraries</name>
  <files>package.json</files>
  <action>
Install yet-another-react-lightbox and prism-react-renderer:

```bash
npm install yet-another-react-lightbox prism-react-renderer
```

yet-another-react-lightbox: Modern TypeScript-native lightbox with zoom/download plugins
prism-react-renderer: Lightweight syntax highlighting (50KB vs 500KB alternatives)

Do NOT install prismjs directly - prism-react-renderer vendors its own Prism subset.
  </action>
  <verify>
`npm ls yet-another-react-lightbox prism-react-renderer` shows both installed
`npm run build` passes (no dependency conflicts)
  </verify>
  <done>Both libraries in package.json dependencies, build passes</done>
</task>

<task type="auto">
  <name>Task 2: Create AttachmentViewerStore and integrate into RootStore</name>
  <files>src/store/AttachmentViewerStore.ts, src/store/index.tsx</files>
  <action>
Create AttachmentViewerStore following existing MobX patterns (see AttachmentsStore.ts):

```typescript
// src/store/AttachmentViewerStore.ts
import { makeAutoObservable } from 'mobx'
import type { RootStore } from './index'
import type { Attachment } from '../schemas/Attachment.schema'

/**
 * MobX store for attachment viewer state.
 * Manages which attachment is being viewed and gallery navigation.
 */
export class AttachmentViewerStore {
  currentAttachment: Attachment | null = null
  attachmentList: Attachment[] = []
  currentIndex = 0
  viewerOpen = false

  constructor(public root: RootStore) {
    makeAutoObservable(this)
  }

  /**
   * Opens the viewer for an attachment.
   * Optionally accepts related attachments for gallery navigation.
   */
  openViewer(attachment: Attachment, relatedAttachments: Attachment[] = []) {
    this.currentAttachment = attachment
    this.attachmentList = relatedAttachments.length > 0 ? relatedAttachments : [attachment]
    this.currentIndex = Math.max(0, this.attachmentList.findIndex(a => a.id === attachment.id))
    this.viewerOpen = true
  }

  /**
   * Closes the viewer and clears state.
   */
  closeViewer() {
    this.currentAttachment = null
    this.attachmentList = []
    this.currentIndex = 0
    this.viewerOpen = false
  }

  /**
   * Updates current index for gallery navigation.
   */
  setCurrentIndex(index: number) {
    this.currentIndex = index
    this.currentAttachment = this.attachmentList[index] || null
  }

  /**
   * Returns true if current attachment is an image.
   */
  get isImage(): boolean {
    return this.currentAttachment?.mime_type?.startsWith('image/') ?? false
  }

  /**
   * Returns true if current attachment is text.
   */
  get isText(): boolean {
    return this.currentAttachment?.mime_type?.startsWith('text/') ?? false
  }

  /**
   * Returns all image attachments from the list (for lightbox gallery).
   */
  get imageAttachments(): Attachment[] {
    return this.attachmentList.filter(a => a.mime_type?.startsWith('image/'))
  }
}
```

Update RootStore in src/store/index.tsx:
1. Import AttachmentViewerStore
2. Add property: `attachmentViewerStore: AttachmentViewerStore`
3. Initialize in constructor: `this.attachmentViewerStore = new AttachmentViewerStore(this)`

Place the new property after attachmentsStore (existing) for consistency.
  </action>
  <verify>
`npm run build` passes (TypeScript compiles)
`grep -n "attachmentViewerStore" src/store/index.tsx` shows property and initialization
  </verify>
  <done>AttachmentViewerStore created with open/close/navigation methods, integrated into RootStore</done>
</task>

</tasks>

<verification>
- [ ] `npm ls yet-another-react-lightbox prism-react-renderer` shows versions
- [ ] `npm run build` passes with no errors
- [ ] AttachmentViewerStore.ts exists with openViewer, closeViewer, setCurrentIndex methods
- [ ] RootStore has attachmentViewerStore property initialized
</verification>

<success_criteria>
- Libraries installed and importable
- AttachmentViewerStore manages viewer state (open/close, current attachment, gallery navigation)
- RootStore exposes attachmentViewerStore via useRootStore() hook
- Build passes with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-attachments-viewer/06-01-SUMMARY.md`
</output>
