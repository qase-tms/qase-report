---
phase: 23-gallery-view
plan: 02
type: execute
wave: 2
depends_on: [23-01]
files_modified:
  - src/components/Gallery/index.tsx
  - src/components/Gallery/GalleryGrid.tsx
  - src/components/Gallery/GalleryItem.tsx
  - src/components/Gallery/GalleryFilters.tsx
  - src/components/NavigationDrawer/index.tsx
  - src/layout/MainLayout/index.tsx
  - src/store/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can see all attachments in a grid layout"
    - "User can filter by type (All, Screenshots, Logs, Other)"
    - "Each attachment shows which test it belongs to"
    - "Clicking attachment opens viewer (lightbox)"
    - "Clicking 'open test' button navigates to test details"
    - "Gallery is accessible via navigation drawer"
  artifacts:
    - path: "src/components/Gallery/index.tsx"
      provides: "Main Gallery view component"
      exports: ["Gallery"]
    - path: "src/components/Gallery/GalleryGrid.tsx"
      provides: "Responsive ImageList grid"
      exports: ["GalleryGrid"]
    - path: "src/components/Gallery/GalleryItem.tsx"
      provides: "Individual gallery item with overlay"
      exports: ["GalleryItem"]
    - path: "src/components/Gallery/GalleryFilters.tsx"
      provides: "Filter chips (All/Screenshots/Logs/Other)"
      exports: ["GalleryFilters"]
  key_links:
    - from: "src/components/Gallery/index.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "useRootStore().analyticsStore.galleryAttachments"
      pattern: "analyticsStore\\.galleryAttachments"
    - from: "src/components/Gallery/GalleryItem.tsx"
      to: "attachmentViewerStore.openViewer"
      via: "click handler opens lightbox"
      pattern: "attachmentViewerStore\\.openViewer"
    - from: "src/components/Gallery/GalleryItem.tsx"
      to: "selectTest"
      via: "action button navigates to test"
      pattern: "selectTest\\(item\\.testId\\)"
    - from: "src/layout/MainLayout/index.tsx"
      to: "src/components/Gallery/index.tsx"
      via: "renders Gallery when activeView is 'gallery'"
      pattern: "activeView.*gallery.*Gallery"
    - from: "src/components/NavigationDrawer/index.tsx"
      to: "activeView"
      via: "gallery nav item added"
      pattern: "id:.*gallery"
---

<objective>
Create Gallery view component with responsive grid, type filters, and navigation integration.

Purpose: Allow users to browse all attachments across all tests in a visual gallery, filter by type, see test context, and navigate to test details.

Output: Gallery components integrated into navigation and main layout.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-gallery-view/23-RESEARCH.md
@.planning/phases/23-gallery-view/23-01-SUMMARY.md

# Existing patterns to follow
@src/components/FailureClusters/index.tsx — view component pattern with empty states
@src/components/SidebarFilters/index.tsx — filter chip pattern
@src/components/TestDetails/TestStepAttachment.tsx — attachment rendering with blob URLs
@src/components/NavigationDrawer/index.tsx — navigation item pattern
@src/layout/MainLayout/index.tsx — view routing pattern
@src/store/index.tsx — activeView type definition
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Gallery components (index, Grid, Item, Filters)</name>
  <files>
    src/components/Gallery/index.tsx
    src/components/Gallery/GalleryGrid.tsx
    src/components/Gallery/GalleryItem.tsx
    src/components/Gallery/GalleryFilters.tsx
  </files>
  <action>
Create src/components/Gallery/ directory with four files:

**GalleryFilters.tsx:**
- Props: `activeFilter`, `onFilterChange`, `counts: {all, screenshots, logs, other}`
- Render horizontal Box with Chip components for each filter
- Use `color={activeFilter === X ? 'primary' : 'default'}` for selected state
- Show counts in labels: "Screenshots (5)"
- Follow SidebarFilters.tsx pattern for chip styling

**GalleryItem.tsx:**
- Props: `item: GalleryAttachment`
- Uses `useRootStore()` to get `attachmentViewerStore`, `attachmentsStore`, `selectTest`
- Get blob URL: `attachmentsStore.getAttachmentUrl(item.attachment.id)`
- Determine if image: `item.attachment.mime_type?.startsWith('image/')`
- Render MUI ImageListItem with:
  - If image and blobUrl: `<img>` with lazy loading, objectFit cover, height 200px
  - If not image: placeholder Box with FileIcon centered (gray background)
  - ImageListItemBar with:
    - title: attachment.file_name (truncated if needed)
    - subtitle: item.testTitle
    - actionIcon: IconButton with OpenInNew icon to navigate to test
- Click on item -> `attachmentViewerStore.openViewer(item.attachment)`
- Click on action button -> `selectTest(item.testId)` with `e.stopPropagation()`
- Use sx for hover effect: `&:hover { opacity: 0.9 }`

**GalleryGrid.tsx:**
- Props: `attachments: GalleryAttachment[]`
- Use MUI useMediaQuery + useTheme for responsive columns:
  - xs (down('sm')): 1 col
  - sm (between 'sm', 'md'): 2 cols
  - md (between 'md', 'lg'): 3 cols
  - lg+: 4 cols
- Render ImageList with cols and gap={16}
- Map attachments to GalleryItem components

**index.tsx (Gallery):**
- Use observer() wrapper
- useState for activeFilter: 'all' | 'screenshots' | 'logs' | 'other' (default 'all')
- Get `analyticsStore`, `reportStore` from useRootStore()
- Import `categorizeAttachment` from types/gallery
- Compute filtered attachments based on activeFilter:
  - 'all': galleryAttachments
  - 'screenshots'/'logs'/'other': filter by categorizeAttachment(mime_type)
- Compute counts for each category
- Handle empty states:
  - No report loaded: "No report loaded" centered text (like FailureClusters)
  - No attachments: Paper with "No attachments found" message
- Render:
  - Title: "Gallery" (Typography variant="h5")
  - Subtitle: "{count} attachment(s)" (Typography variant="body2")
  - GalleryFilters with counts and handlers
  - GalleryGrid with filtered attachments
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
Gallery components render grid of attachments with:
- Responsive columns (1-4 based on screen size)
- Type filter chips with counts
- Test name overlay on each item
- Click to view, action button to navigate to test
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Gallery to navigation and routing</name>
  <files>
    src/store/index.tsx
    src/components/NavigationDrawer/index.tsx
    src/layout/MainLayout/index.tsx
  </files>
  <action>
**src/store/index.tsx:**
- Update activeView type to include 'gallery':
  ```typescript
  activeView: 'dashboard' | 'tests' | 'analytics' | 'failure-clusters' | 'gallery' = 'dashboard'
  ```
- Update setActiveView signature accordingly

**src/components/NavigationDrawer/index.tsx:**
- Add import: `import { Collections as GalleryIcon } from '@mui/icons-material'`
- Add gallery to navItems array (after failure-clusters, before analytics):
  ```typescript
  {
    id: 'gallery' as const,
    label: 'Gallery',
    icon: <GalleryIcon />,
  },
  ```

**src/layout/MainLayout/index.tsx:**
- Add import: `import { Gallery } from '../../components/Gallery'`
- Add gallery case in renderView():
  ```typescript
  if (activeView === 'gallery') {
    return <Gallery />
  }
  ```
  Place after failure-clusters case, before analytics case.
  </action>
  <verify>
1. `npm run build` succeeds
2. `npm run dev` — Gallery appears in navigation drawer
3. Clicking Gallery nav item shows Gallery view
  </verify>
  <done>
Gallery view accessible via navigation drawer icon (Collections icon), routes correctly in MainLayout.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full integration</name>
  <files></files>
  <action>
Run dev server and verify:
1. Load a report with attachments
2. Click Gallery in navigation
3. Verify attachments display in grid
4. Test filter chips change displayed attachments
5. Click attachment - lightbox opens
6. Click "open test" icon - test details dock opens

If any issues found, fix them. This task is verification only.
  </action>
  <verify>
`npm run dev` — manually test all gallery interactions work as expected
  </verify>
  <done>
Gallery fully functional: grid displays, filters work, clicking opens viewer, action navigates to test.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Gallery accessible via navigation drawer
4. Attachments display in responsive grid (test different viewport sizes)
5. Filter chips correctly filter attachments by type
6. Each attachment shows test name in overlay
7. Click attachment opens viewer (existing lightbox)
8. Click action button navigates to test details
9. Empty states render correctly (no report, no attachments)
</verification>

<success_criteria>
- GAL-01: Gallery view shows all attachments from all tests (grid layout)
- GAL-02: Filter chips work (All/Screenshots/Logs/Other with counts)
- GAL-03: Each attachment shows test title in ImageListItemBar subtitle
- GAL-04: Action icon navigates to test details (opens dock with test)
- Navigation: Gallery accessible via drawer with Collections icon
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/23-gallery-view/23-02-SUMMARY.md`
</output>
