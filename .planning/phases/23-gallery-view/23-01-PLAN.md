---
phase: 23-gallery-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/gallery.ts
  - src/store/AnalyticsStore.ts
autonomous: true

must_haves:
  truths:
    - "AnalyticsStore provides galleryAttachments with all attachments from all tests"
    - "Each gallery attachment includes test metadata (id, title, status)"
    - "Attachments from both test-level and nested step-level are collected"
  artifacts:
    - path: "src/types/gallery.ts"
      provides: "GalleryAttachment interface and AttachmentCategory type"
      exports: ["GalleryAttachment", "AttachmentCategory", "categorizeAttachment"]
    - path: "src/store/AnalyticsStore.ts"
      provides: "galleryAttachments computed property"
      contains: "get galleryAttachments"
  key_links:
    - from: "src/store/AnalyticsStore.ts"
      to: "src/types/gallery.ts"
      via: "import GalleryAttachment type"
      pattern: "import.*GalleryAttachment.*from.*gallery"
    - from: "src/store/AnalyticsStore.ts"
      to: "testResultsStore.resultsList"
      via: "iterates over all tests"
      pattern: "this\\.root\\.testResultsStore\\.resultsList"
---

<objective>
Add cross-test attachment aggregation to AnalyticsStore for Gallery view.

Purpose: Provide computed data layer that collects all attachments from all tests (both test-level and step-level) with test metadata, enabling the Gallery UI to display attachments with their originating test context.

Output: GalleryAttachment type definition and galleryAttachments computed property in AnalyticsStore.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-gallery-view/23-RESEARCH.md

# Existing patterns to follow
@src/store/AnalyticsStore.ts — failureClusters pattern for cross-test aggregation
@src/types/stability.ts — type definition pattern
@src/schemas/Step.schema.ts — nested step structure with execution.attachments
@src/schemas/Attachment.schema.ts — Attachment type shape
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GalleryAttachment type and categorization helper</name>
  <files>src/types/gallery.ts</files>
  <action>
Create new type file with:

1. `GalleryAttachment` interface:
   - `attachment: Attachment` — original attachment data
   - `testId: string` — test ID for navigation
   - `testTitle: string` — test title for display
   - `testStatus: 'passed' | 'failed' | 'skipped' | 'broken'` — test status
   - `source: 'test' | 'step'` — where attachment was found
   - `stepId?: string` — step ID if from step (optional)

2. `AttachmentCategory` type: `'screenshots' | 'logs' | 'other'`

3. `categorizeAttachment(mimeType: string): AttachmentCategory` helper function:
   - `image/*` -> 'screenshots'
   - `text/*` or `application/json` -> 'logs'
   - Everything else -> 'other'
   - Handle undefined/empty mimeType gracefully (return 'other')

Follow existing pattern from src/types/stability.ts for exports.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit src/types/gallery.ts`
  </verify>
  <done>
GalleryAttachment interface exported, categorizeAttachment function works for all MIME type categories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add galleryAttachments computed property to AnalyticsStore</name>
  <files>src/store/AnalyticsStore.ts</files>
  <action>
Add to AnalyticsStore (after failureClusters getter):

1. Import types:
   ```typescript
   import type { GalleryAttachment } from '../types/gallery'
   import type { Step } from '../schemas/Step.schema'
   ```

2. Add `galleryAttachments` computed property that:
   - Iterates over `this.root.testResultsStore.resultsList`
   - For each test, collects test-level attachments with metadata
   - Recursively collects step-level attachments using helper function
   - Returns `GalleryAttachment[]`

3. Add recursive helper (private method or inline function):
   ```typescript
   const collectStepAttachments = (
     steps: Step[],
     testId: string,
     testTitle: string,
     testStatus: 'passed' | 'failed' | 'skipped' | 'broken',
     collector: GalleryAttachment[]
   ) => {
     for (const step of steps) {
       for (const attachment of step.execution.attachments) {
         collector.push({
           attachment,
           testId,
           testTitle,
           testStatus,
           source: 'step',
           stepId: step.id,
         })
       }
       if (step.steps && step.steps.length > 0) {
         collectStepAttachments(step.steps, testId, testTitle, testStatus, collector)
       }
     }
   }
   ```

4. Add convenience computed properties:
   - `galleryAttachmentCount: number` — total count
   - `hasGalleryAttachments: boolean` — whether any attachments exist

Follow existing failureClusters pattern for structure and JSDoc comments.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
AnalyticsStore exports galleryAttachments computed property that:
- Returns all attachments from all tests with test metadata
- Includes both test-level and step-level attachments (recursively collected)
- Automatically updates when test results change (MobX reactivity)
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors: `npx tsc --noEmit`
2. Build succeeds: `npm run build`
3. Verify computed property is reactive by checking AnalyticsStore uses makeAutoObservable
</verification>

<success_criteria>
- GalleryAttachment type exported from src/types/gallery.ts
- categorizeAttachment helper correctly categorizes image/text/other MIME types
- AnalyticsStore.galleryAttachments returns flat array of all attachments with test metadata
- Both test-level (test.attachments) and step-level (step.execution.attachments, recursive) collected
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/23-gallery-view/23-01-SUMMARY.md`
</output>
