---
phase: 35-suite-hierarchy-progress
plan: 03
type: execute
wave: 3
depends_on: ["35-01", "35-02"]
files_modified:
  - src/components/TestList/index.tsx
autonomous: true

must_haves:
  truths:
    - "Suite hierarchy displays as expandable rows in table"
    - "Collapse/expand state persists during filtering"
    - "Suites with no matching tests are hidden during filtering"
    - "User can expand all suites to see all tests"
  artifacts:
    - path: "src/components/TestList/index.tsx"
      provides: "Integrated tree data with expand state"
      contains: "buildSuiteTree"
      exports: ["TestList"]
  key_links:
    - from: "src/components/TestList/index.tsx"
      to: "buildSuiteTree"
      via: "useMemo tree transformation"
      pattern: "useMemo.*buildSuiteTree"
    - from: "src/components/TestList/index.tsx"
      to: "DataTable"
      via: "getSubRows prop"
      pattern: "getSubRows.*subRows"
---

<objective>
Integrate tree transformation and expand state management into TestList component, completing the suite hierarchy feature.

Purpose: Connect all pieces (buildSuiteTree, DataTable with expanding, columns with progress) to display working suite hierarchy with persistent expand/collapse state across filtering.

Output: TestList uses tree data with suite hierarchy, expanded state persists during filter changes.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/35-suite-hierarchy-progress/35-RESEARCH.md
@.planning/phases/35-suite-hierarchy-progress/35-01-PLAN.md
@.planning/phases/35-suite-hierarchy-progress/35-02-PLAN.md
@src/components/TestList/index.tsx
@src/components/TestList/buildSuiteTree.ts
@src/components/TestList/DataTable.tsx
@src/hooks/useSuiteExpandState.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate tree data and expand state in TestList</name>
  <files>src/components/TestList/index.tsx</files>
  <action>
Update TestList component to use tree transformation and manage expand state.

**Add imports:**
```typescript
import { useState, useMemo, useEffect } from 'react'
import { ExpandedState } from '@tanstack/react-table'
import { buildSuiteTree, type TreeNode } from './buildSuiteTree'
```

**Add sessionStorage persistence for expanded state:**

Create constants and helper:
```typescript
const STORAGE_KEY = 'qase-report-expanded-suites'

// Load expanded state from sessionStorage (SSR-safe)
const loadExpandedState = (): ExpandedState => {
  if (typeof window === 'undefined') return {}
  try {
    const stored = sessionStorage.getItem(STORAGE_KEY)
    return stored ? JSON.parse(stored) : {}
  } catch {
    return {}
  }
}
```

**Add state for expanded rows:**
```typescript
const [expanded, setExpanded] = useState<ExpandedState>(loadExpandedState)

// Persist expanded state to sessionStorage
useEffect(() => {
  if (typeof window !== 'undefined') {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(expanded))
  }
}, [expanded])
```

**Transform filtered data to tree structure:**
```typescript
// Transform flat results to tree structure with useMemo
// Recalculates when filteredResults changes
const treeData = useMemo(
  () => buildSuiteTree(filteredResults),
  [filteredResults]
)
```

**Update columns memoization for TreeNode type:**
```typescript
const columns = useMemo(
  () => createColumns((id: string) => selectTest(id)),
  [selectTest]
)
```

**Update DataTable with tree props:**
```typescript
<DataTable
  columns={columns}
  data={treeData}
  onRowClick={(row) => {
    // Only open test details for test rows
    if (row.type === 'test' && row.testData) {
      selectTest(row.testData.id)
    }
  }}
  height={tableHeight}
  // Tree expansion props
  getSubRows={(row) => row.subRows}
  getRowId={(row) => row.id}
  expanded={expanded}
  onExpandedChange={setExpanded}
/>
```

**Update filter summary text:**
Count total tests across all suites, not treeData length:
```typescript
// Calculate total tests in tree for summary
const totalTestsInTree = treeData.reduce(
  (sum, suite) => sum + (suite.totalTests || 0),
  0
)

<p className="text-sm text-muted-foreground mb-2">
  Showing {totalTestsInTree} of {resultsList.length} tests
  {activeFilterCount > 0 && ` (${activeFilterCount} filter${activeFilterCount !== 1 ? 's' : ''} active)`}
</p>
```

**Remove old useSuiteExpandState hook usage if present.**

**Full component structure:**
```typescript
export const TestList = observer(() => {
  const { testResultsStore, selectTest } = useRootStore()
  const { filteredResults, resultsList, activeFilterCount } = testResultsStore

  // Expanded state with sessionStorage persistence
  const [expanded, setExpanded] = useState<ExpandedState>(loadExpandedState)

  useEffect(() => {
    if (typeof window !== 'undefined') {
      sessionStorage.setItem(STORAGE_KEY, JSON.stringify(expanded))
    }
  }, [expanded])

  // Early return if no tests
  if (resultsList.length === 0) {
    return (...)
  }

  const tableHeight = window.innerHeight - 300

  // Transform to tree structure (memoized)
  const treeData = useMemo(
    () => buildSuiteTree(filteredResults),
    [filteredResults]
  )

  // Columns with TreeNode type
  const columns = useMemo(
    () => createColumns((id: string) => selectTest(id)),
    [selectTest]
  )

  // Calculate total tests in tree
  const totalTestsInTree = treeData.reduce(
    (sum, suite) => sum + (suite.totalTests || 0),
    0
  )

  return (
    <div className="bg-card rounded-lg border shadow-sm p-4">
      <h6 className="text-lg font-semibold mb-4">Tests</h6>

      <div className="mb-4 flex flex-col gap-4">
        <TestListSearch />
        <TestListFilters />
      </div>

      <p className="text-sm text-muted-foreground mb-2">
        Showing {totalTestsInTree} of {resultsList.length} tests
        {activeFilterCount > 0 && ` (${activeFilterCount} filter${activeFilterCount !== 1 ? 's' : ''} active)`}
      </p>

      {totalTestsInTree === 0 && resultsList.length > 0 ? (
        <p className="text-sm text-muted-foreground py-4 text-center">
          No tests match current filters.
        </p>
      ) : (
        <DataTable
          columns={columns}
          data={treeData}
          onRowClick={(row) => {
            if (row.type === 'test' && row.testData) {
              selectTest(row.testData.id)
            }
          }}
          height={tableHeight}
          getSubRows={(row) => row.subRows}
          getRowId={(row) => row.id}
          expanded={expanded}
          onExpandedChange={setExpanded}
        />
      )}
    </div>
  )
})
```

**Key behaviors:**
1. Tree transformation happens once when filteredResults changes
2. Expanded state persists to sessionStorage on change
3. Expanding a suite is independent of filtering
4. Empty suites (no matching children) don't appear in tree (handled by buildSuiteTree)
5. Row click only opens details for test rows, not suites
  </action>
  <verify>
```bash
# Check buildSuiteTree import
grep "import.*buildSuiteTree" src/components/TestList/index.tsx

# Check useMemo for tree transformation
grep "useMemo.*buildSuiteTree" src/components/TestList/index.tsx

# Check expanded state management
grep "useState.*ExpandedState" src/components/TestList/index.tsx

# Check sessionStorage persistence
grep "sessionStorage.*expanded" src/components/TestList/index.tsx

# Check DataTable tree props
grep -A5 "getSubRows" src/components/TestList/index.tsx

# Full build verification
npm run build
```
  </verify>
  <done>
- TestList imports and uses buildSuiteTree
- Tree transformation uses useMemo for performance
- Expanded state persists to sessionStorage
- DataTable receives getSubRows, getRowId, expanded, onExpandedChange props
- Row click only triggers selectTest for test rows
- Filter summary shows correct test count from tree
- Build passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify complete integration and cleanup</name>
  <files>src/components/TestList/index.tsx</files>
  <action>
Final verification and cleanup of the integration.

**Verification steps:**

1. **Start dev server and load a report:**
```bash
npm run dev
```

2. **Open browser at http://localhost:5173**

3. **Verify suite hierarchy:**
- Suites display as parent rows with folder icon
- Tests display as child rows with file icon
- Chevron icon shows expand/collapse state

4. **Verify expand/collapse:**
- Click chevron to expand suite
- Collapsed suites hide their tests
- Expanded suites show tests indented

5. **Verify progress bars:**
- Suite rows show multi-color progress bar
- Hover shows tooltip with duration and counts
- Colors: green=passed, red=failed, yellow=skipped, gray=broken

6. **Verify state persistence:**
- Expand a suite
- Apply a filter (e.g., status: failed)
- Check that suite remains expanded
- Remove filter
- Suite should still be expanded

7. **Verify filtering behavior:**
- Apply status filter to show only failed tests
- Suites with no failed tests should not appear
- Suites with failed tests should show only those tests

**Cleanup if needed:**
- Remove any unused imports
- Remove old useSuiteExpandState hook if no longer used elsewhere
- Ensure no console.log statements remain

**Record verification results for summary.**
  </action>
  <verify>
```bash
# Start dev server
npm run dev &

# Wait for server to start
sleep 5

# Check server is running
curl -s http://localhost:5173 | head -5

# Build check
npm run build

# Kill background dev server
pkill -f "vite"
```
  </verify>
  <done>
- Dev server starts without errors
- Suite hierarchy displays correctly
- Expand/collapse works with state persistence
- Progress bars show on suite rows with correct colors
- Filtering preserves expand state
- Build passes without errors
- No unused imports or console.log statements
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build` succeeds
2. Tree transformation: Uses buildSuiteTree with useMemo
3. Expand state: Persists to sessionStorage across filter changes
4. Integration: DataTable receives all tree props

Manual verification:
- Load report with multiple suites
- Expand/collapse suites with chevron
- Progress bars show on suite rows
- Filter by status - expanded state preserved
- Refresh page - expanded state restored from sessionStorage
</verification>

<success_criteria>
- [ ] TestList uses buildSuiteTree to transform filteredResults
- [ ] Expanded state managed with useState and persisted to sessionStorage
- [ ] DataTable receives getSubRows, getRowId, expanded, onExpandedChange
- [ ] Row click only opens TestDetailsDrawer for test rows
- [ ] Suite rows show progress bar, test rows show status
- [ ] Expand/collapse state persists across filter changes
- [ ] npm run build passes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/35-suite-hierarchy-progress/35-03-SUMMARY.md`
</output>
