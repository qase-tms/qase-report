---
phase: 24-comparison-view
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/components/Comparison/index.tsx
  - src/components/Comparison/RunSelector.tsx
  - src/components/Comparison/ComparisonSummary.tsx
  - src/components/Comparison/DiffList.tsx
  - src/components/NavigationDrawer/index.tsx
  - src/store/index.tsx
  - src/layout/MainLayout.tsx
autonomous: true

must_haves:
  truths:
    - "User can select two runs from dropdowns for comparison"
    - "View shows tests that changed status with color-coded indicators"
    - "View shows tests added or removed between runs"
    - "Duration changes highlighted with direction indicators"
    - "Clicking test navigates to test details"
  artifacts:
    - path: "src/components/Comparison/index.tsx"
      provides: "Main Comparison view component"
      min_lines: 50
    - path: "src/components/Comparison/RunSelector.tsx"
      provides: "Dual dropdown for run selection"
      exports: ["RunSelector"]
    - path: "src/components/Comparison/DiffList.tsx"
      provides: "Grouped diff display with expandable sections"
      exports: ["DiffList"]
    - path: "src/components/NavigationDrawer/index.tsx"
      provides: "Comparison navigation item"
      contains: "comparison"
  key_links:
    - from: "src/components/Comparison/index.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "useRootStore().analyticsStore"
      pattern: "analyticsStore\\.comparison"
    - from: "src/components/Comparison/DiffList.tsx"
      to: "src/store/index.tsx"
      via: "selectTest() navigation"
      pattern: "selectTest"
---

<objective>
Create Comparison view component with run selection and diff display.

Purpose: Enable users to select two runs and visualize differences in test results including status changes (regressions/fixes), added/removed tests, and duration changes.

Output: ComparisonView integrated into navigation, accessible via sidebar.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-comparison-view/24-RESEARCH.md
@.planning/phases/24-comparison-view/24-01-SUMMARY.md

@src/store/AnalyticsStore.ts
@src/store/index.tsx
@src/types/comparison.ts
@src/components/Gallery/index.tsx
@src/components/FailureClusters/index.tsx
@src/components/NavigationDrawer/index.tsx
@src/layout/MainLayout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create RunSelector component for dual run selection</name>
  <files>src/components/Comparison/RunSelector.tsx</files>
  <action>
Create RunSelector component following MUI Select patterns:

```typescript
import { observer } from 'mobx-react-lite'
import {
  Box,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Typography,
  Paper,
} from '@mui/material'
import { CompareArrows as CompareIcon } from '@mui/icons-material'
import { useRootStore } from '../../store'

export const RunSelector = observer(() => {
  const { analyticsStore } = useRootStore()
  const {
    comparableRuns,
    selectedBaseRunId,
    selectedCompareRunId,
    setSelectedBaseRunId,
    setSelectedCompareRunId,
  } = analyticsStore

  const formatRunDate = (timestamp: number): string => {
    return new Date(timestamp).toLocaleString()
  }

  const formatRunLabel = (run: typeof comparableRuns[0]): string => {
    const date = formatRunDate(run.start_time)
    const passRate = run.stats.total > 0
      ? Math.round((run.stats.passed / run.stats.total) * 100)
      : 0
    return `${date} (${passRate}% pass)`
  }

  return (
    <Paper sx={{ p: 2, mb: 3 }}>
      <Box
        sx={{
          display: 'flex',
          alignItems: 'center',
          gap: 2,
          flexWrap: 'wrap',
        }}
      >
        <FormControl sx={{ minWidth: 280 }} size="small">
          <InputLabel id="base-run-label">Base Run (older)</InputLabel>
          <Select
            labelId="base-run-label"
            id="base-run-select"
            value={selectedBaseRunId ?? ''}
            label="Base Run (older)"
            onChange={e => setSelectedBaseRunId(e.target.value || null)}
          >
            <MenuItem value="">
              <em>Select a run</em>
            </MenuItem>
            {comparableRuns.map(run => (
              <MenuItem
                key={run.run_id}
                value={run.run_id}
                disabled={run.run_id === selectedCompareRunId}
              >
                {formatRunLabel(run)}
              </MenuItem>
            ))}
          </Select>
        </FormControl>

        <CompareIcon sx={{ color: 'text.secondary' }} />

        <FormControl sx={{ minWidth: 280 }} size="small">
          <InputLabel id="compare-run-label">Compare Run (newer)</InputLabel>
          <Select
            labelId="compare-run-label"
            id="compare-run-select"
            value={selectedCompareRunId ?? ''}
            label="Compare Run (newer)"
            onChange={e => setSelectedCompareRunId(e.target.value || null)}
          >
            <MenuItem value="">
              <em>Select a run</em>
            </MenuItem>
            {comparableRuns.map(run => (
              <MenuItem
                key={run.run_id}
                value={run.run_id}
                disabled={run.run_id === selectedBaseRunId}
              >
                {formatRunLabel(run)}
              </MenuItem>
            ))}
          </Select>
        </FormControl>
      </Box>

      {comparableRuns.length === 0 && (
        <Typography variant="body2" color="text.secondary" sx={{ mt: 1 }}>
          Load a report with history data to enable comparison.
        </Typography>
      )}
    </Paper>
  )
})
```

Key features:
- Uses MUI Select with size="small" for compact display
- Shows pass rate in dropdown for quick identification
- Disables already-selected run in other dropdown
- Shows help text when no history available
  </action>
  <verify>File exists and exports RunSelector</verify>
  <done>RunSelector provides dual dropdowns for base/compare run selection with pass rate labels</done>
</task>

<task type="auto">
  <name>Task 2: Create ComparisonSummary and DiffList components</name>
  <files>src/components/Comparison/ComparisonSummary.tsx, src/components/Comparison/DiffList.tsx</files>
  <action>
Create ComparisonSummary.tsx for stats overview:

```typescript
import { Box, Paper, Typography, Chip, Grid } from '@mui/material'
import {
  TrendingUp as RegressionIcon,
  TrendingDown as FixedIcon,
  Add as AddedIcon,
  Remove as RemovedIcon,
  Speed as DurationIcon,
} from '@mui/icons-material'
import type { ComparisonResult } from '../../types/comparison'

interface ComparisonSummaryProps {
  comparison: ComparisonResult
}

export const ComparisonSummary = ({ comparison }: ComparisonSummaryProps) => {
  const { summary, baseRun, compareRun } = comparison

  const formatDate = (timestamp: number): string => {
    return new Date(timestamp).toLocaleDateString()
  }

  return (
    <Paper sx={{ p: 2, mb: 3 }}>
      <Typography variant="subtitle2" color="text.secondary" gutterBottom>
        Comparing {formatDate(baseRun.start_time)} to {formatDate(compareRun.start_time)}
      </Typography>

      <Box sx={{ display: 'flex', flexWrap: 'wrap', gap: 1, mt: 1 }}>
        {summary.regressionCount > 0 && (
          <Chip
            icon={<RegressionIcon />}
            label={`${summary.regressionCount} regression${summary.regressionCount !== 1 ? 's' : ''}`}
            color="error"
            size="small"
          />
        )}
        {summary.fixedCount > 0 && (
          <Chip
            icon={<FixedIcon />}
            label={`${summary.fixedCount} fixed`}
            color="success"
            size="small"
          />
        )}
        {summary.addedCount > 0 && (
          <Chip
            icon={<AddedIcon />}
            label={`${summary.addedCount} added`}
            color="info"
            size="small"
          />
        )}
        {summary.removedCount > 0 && (
          <Chip
            icon={<RemovedIcon />}
            label={`${summary.removedCount} removed`}
            color="warning"
            size="small"
          />
        )}
        {summary.durationChangedCount > 0 && (
          <Chip
            icon={<DurationIcon />}
            label={`${summary.durationChangedCount} duration change${summary.durationChangedCount !== 1 ? 's' : ''}`}
            size="small"
          />
        )}
        <Chip
          label={`${comparison.diff.unchangedCount} unchanged`}
          variant="outlined"
          size="small"
        />
      </Box>
    </Paper>
  )
}
```

Create DiffList.tsx for expandable grouped diff display:

```typescript
import { useState, useCallback } from 'react'
import {
  Box,
  List,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Collapse,
  Typography,
  Chip,
  Paper,
} from '@mui/material'
import {
  ExpandMore as ExpandMoreIcon,
  ExpandLess as ExpandLessIcon,
  ErrorOutline as RegressionIcon,
  CheckCircleOutline as FixedIcon,
  Add as AddedIcon,
  Remove as RemovedIcon,
  Speed as DurationIcon,
  ArrowUpward as SlowerIcon,
  ArrowDownward as FasterIcon,
} from '@mui/icons-material'
import type { ComparisonResult, StatusChange, DurationChange } from '../../types/comparison'
import { useRootStore } from '../../store'

interface DiffListProps {
  comparison: ComparisonResult
}

type DiffSection = 'regressions' | 'fixed' | 'added' | 'removed' | 'duration'

export const DiffList = ({ comparison }: DiffListProps) => {
  const { selectTest } = useRootStore()
  const [expanded, setExpanded] = useState<Set<DiffSection>>(new Set(['regressions']))

  const toggleSection = useCallback((section: DiffSection) => {
    setExpanded(prev => {
      const next = new Set(prev)
      if (next.has(section)) {
        next.delete(section)
      } else {
        next.add(section)
      }
      return next
    })
  }, [])

  const { diff } = comparison
  const regressions = diff.statusChanged.filter(c => c.changeType === 'regression')
  const fixed = diff.statusChanged.filter(c => c.changeType === 'fixed')

  const handleTestClick = (signature: string) => {
    // Find test ID by signature in current results
    const { testResultsStore } = useRootStore()
    const test = testResultsStore.resultsList.find(t => t.signature === signature)
    if (test) {
      selectTest(test.id)
    }
  }

  const renderStatusChangeItem = (item: StatusChange) => (
    <ListItemButton
      key={item.signature}
      onClick={() => handleTestClick(item.signature)}
      sx={{ pl: 4 }}
    >
      <ListItemText
        primary={item.title}
        secondary={`${item.oldStatus} -> ${item.newStatus}`}
      />
    </ListItemButton>
  )

  const renderDurationItem = (item: DurationChange) => {
    const isFaster = item.difference < 0
    return (
      <ListItemButton
        key={item.signature}
        onClick={() => handleTestClick(item.signature)}
        sx={{ pl: 4 }}
      >
        <ListItemIcon sx={{ minWidth: 36 }}>
          {isFaster ? (
            <FasterIcon color="success" fontSize="small" />
          ) : (
            <SlowerIcon color="error" fontSize="small" />
          )}
        </ListItemIcon>
        <ListItemText
          primary={item.title}
          secondary={`${item.oldDuration}ms -> ${item.newDuration}ms (${item.percentChange > 0 ? '+' : ''}${Math.round(item.percentChange)}%)`}
        />
      </ListItemButton>
    )
  }

  const renderAddedRemovedItem = (item: typeof diff.added[0], isAdded: boolean) => (
    <ListItemButton
      key={item.signature}
      onClick={() => handleTestClick(item.signature)}
      sx={{ pl: 4 }}
    >
      <ListItemText
        primary={item.title}
        secondary={`${item.status} (${item.duration}ms)`}
      />
    </ListItemButton>
  )

  const sections = [
    {
      id: 'regressions' as const,
      label: 'Regressions',
      icon: <RegressionIcon color="error" />,
      count: regressions.length,
      items: regressions,
      render: renderStatusChangeItem,
    },
    {
      id: 'fixed' as const,
      label: 'Fixed',
      icon: <FixedIcon color="success" />,
      count: fixed.length,
      items: fixed,
      render: renderStatusChangeItem,
    },
    {
      id: 'added' as const,
      label: 'Added Tests',
      icon: <AddedIcon color="info" />,
      count: diff.added.length,
      items: diff.added,
      render: (item: typeof diff.added[0]) => renderAddedRemovedItem(item, true),
    },
    {
      id: 'removed' as const,
      label: 'Removed Tests',
      icon: <RemovedIcon color="warning" />,
      count: diff.removed.length,
      items: diff.removed,
      render: (item: typeof diff.removed[0]) => renderAddedRemovedItem(item, false),
    },
    {
      id: 'duration' as const,
      label: 'Duration Changes',
      icon: <DurationIcon />,
      count: diff.durationChanged.length,
      items: diff.durationChanged,
      render: renderDurationItem,
    },
  ]

  return (
    <Paper>
      <List disablePadding>
        {sections.map(section => {
          if (section.count === 0) return null

          return (
            <Box key={section.id}>
              <ListItemButton onClick={() => toggleSection(section.id)}>
                <ListItemIcon>{section.icon}</ListItemIcon>
                <ListItemText primary={section.label} />
                <Chip label={section.count} size="small" sx={{ mr: 1 }} />
                {expanded.has(section.id) ? <ExpandLessIcon /> : <ExpandMoreIcon />}
              </ListItemButton>
              <Collapse in={expanded.has(section.id)} timeout="auto" unmountOnExit>
                <List component="div" disablePadding>
                  {section.items.map(section.render)}
                </List>
              </Collapse>
            </Box>
          )
        })}
      </List>

      {sections.every(s => s.count === 0) && (
        <Box sx={{ p: 3, textAlign: 'center' }}>
          <Typography color="text.secondary">
            No differences found between selected runs.
          </Typography>
        </Box>
      )}
    </Paper>
  )
}
```

Note: DiffList uses hook inside handler which is incorrect. Fix by moving useRootStore to component level and using destructured selectTest/testResultsStore.
  </action>
  <verify>Files exist and export ComparisonSummary and DiffList</verify>
  <done>ComparisonSummary shows color-coded chips for diff stats; DiffList shows expandable sections for regressions, fixed, added, removed, and duration changes with test navigation</done>
</task>

<task type="auto">
  <name>Task 3: Create main Comparison view and integrate with navigation</name>
  <files>src/components/Comparison/index.tsx, src/components/NavigationDrawer/index.tsx, src/store/index.tsx, src/layout/MainLayout.tsx</files>
  <action>
Create src/components/Comparison/index.tsx following Gallery/FailureClusters pattern:

```typescript
import { observer } from 'mobx-react-lite'
import { Box, Typography, Paper } from '@mui/material'
import { useRootStore } from '../../store'
import { RunSelector } from './RunSelector'
import { ComparisonSummary } from './ComparisonSummary'
import { DiffList } from './DiffList'

export const Comparison = observer(() => {
  const { analyticsStore, reportStore, historyStore } = useRootStore()

  // No report loaded
  if (!reportStore.runData) {
    return (
      <Box
        sx={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          height: '50vh',
          color: 'text.secondary',
        }}
      >
        No report loaded
      </Box>
    )
  }

  // No history data
  if (!historyStore.isHistoryLoaded || analyticsStore.comparableRuns.length < 2) {
    return (
      <Box sx={{ p: 3 }}>
        <Typography variant="h5" gutterBottom>
          Comparison
        </Typography>
        <Paper sx={{ p: 3, textAlign: 'center' }}>
          <Typography color="text.secondary">
            At least 2 runs are required for comparison. Load a report with history data containing multiple runs.
          </Typography>
        </Paper>
      </Box>
    )
  }

  const comparison = analyticsStore.comparison

  return (
    <Box sx={{ p: 3 }}>
      <Box sx={{ mb: 3 }}>
        <Typography variant="h5" gutterBottom>
          Comparison
        </Typography>
        <Typography variant="body2" color="text.secondary">
          Compare two test runs to see status changes, added/removed tests, and duration differences.
        </Typography>
      </Box>

      <RunSelector />

      {comparison ? (
        <>
          <ComparisonSummary comparison={comparison} />
          <DiffList comparison={comparison} />
        </>
      ) : (
        <Paper sx={{ p: 3, textAlign: 'center' }}>
          <Typography color="text.secondary">
            Select two runs above to see the comparison.
          </Typography>
        </Paper>
      )}
    </Box>
  )
})
```

Update src/store/index.tsx:
1. Add 'comparison' to activeView union type:
```typescript
activeView: 'dashboard' | 'tests' | 'analytics' | 'failure-clusters' | 'gallery' | 'comparison' = 'dashboard'
```

2. Update setActiveView signature:
```typescript
setActiveView = (view: 'dashboard' | 'tests' | 'analytics' | 'failure-clusters' | 'gallery' | 'comparison') => {
```

Update src/components/NavigationDrawer/index.tsx:
1. Add import for CompareArrows icon:
```typescript
import { CompareArrows as ComparisonIcon } from '@mui/icons-material'
```

2. Add comparison to navItems array (after gallery):
```typescript
{
  id: 'comparison' as const,
  label: 'Comparison',
  icon: <ComparisonIcon />,
},
```

Update src/layout/MainLayout.tsx:
1. Add import for Comparison:
```typescript
import { Comparison } from '../components/Comparison'
```

2. Add case in view rendering (in the switch/conditional that renders different views):
```typescript
{activeView === 'comparison' && <Comparison />}
```

Ensure all imports are correct and components render based on activeView state.
  </action>
  <verify>
1. `npm run build` succeeds
2. Run dev server: `npm run dev`
3. Load a report with history data
4. Click "Comparison" in sidebar
5. Verify dropdowns show available runs
6. Select two runs and verify diff display
  </verify>
  <done>Comparison view accessible via sidebar navigation, displays run selectors, summary stats, and expandable diff lists; clicking test navigates to test details</done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Comparison navigation item appears in sidebar with CompareArrows icon
3. View shows empty state when no history or <2 runs
4. Run selectors show up to 20 most recent runs with pass rate
5. Selecting two runs displays:
   - Summary with color-coded chips (regressions, fixed, added, removed, duration)
   - Expandable sections for each diff category
6. Clicking a test in diff list opens test details dock
7. Regressions section expanded by default (most important)
</verification>

<success_criteria>
- COMP-01: User can select two runs from history for comparison (dual dropdown selectors)
- COMP-02: View shows tests that changed status between runs (statusChanged with regression/fixed)
- COMP-03: View shows new/removed tests between runs (added/removed arrays)
- COMP-04: Duration changes highlighted (durationChanged with faster/slower indicators)
- Navigation integrated into sidebar
- Test click navigates to test details
</success_criteria>

<output>
After completion, create `.planning/phases/24-comparison-view/24-02-SUMMARY.md`
</output>
