---
phase: 22-failure-clusters
plan: 02
type: execute
wave: 2
depends_on:
  - "22-01"
files_modified:
  - src/components/FailureClusters/index.tsx
  - src/components/FailureClusters/ClusterGroup.tsx
  - src/components/NavigationDrawer/index.tsx
  - src/layout/MainLayout/index.tsx
  - src/store/index.tsx
autonomous: false

must_haves:
  truths:
    - "User can navigate to Failure Clusters view from sidebar"
    - "Each cluster shows count of affected tests and error pattern"
    - "Cluster is expandable to reveal all tests in that group"
    - "Clicking a test opens test details dock"
  artifacts:
    - path: "src/components/FailureClusters/index.tsx"
      provides: "Main FailureClusters view component"
      exports: ["FailureClusters"]
    - path: "src/components/FailureClusters/ClusterGroup.tsx"
      provides: "Expandable cluster group component"
      exports: ["ClusterGroup"]
  key_links:
    - from: "src/components/FailureClusters/index.tsx"
      to: "analyticsStore.failureClusters"
      via: "MobX observer and useRootStore"
      pattern: "analyticsStore\\.failureClusters"
    - from: "src/components/FailureClusters/ClusterGroup.tsx"
      to: "rootStore.selectTest"
      via: "onSelectTest callback"
      pattern: "selectTest|onSelectTest"
    - from: "src/layout/MainLayout/index.tsx"
      to: "src/components/FailureClusters/index.tsx"
      via: "activeView === 'failure-clusters' routing"
      pattern: "FailureClusters"
---

<objective>
Create FailureClusters view component with expandable cluster groups and navigation integration

Purpose: Users can view failed tests grouped by similar error messages, expand clusters to see all affected tests, and navigate to test details for investigation.

Output: FailureClusters view accessible from sidebar navigation, showing expandable groups of tests sharing common error patterns.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/22-failure-clusters/22-RESEARCH.md
@.planning/phases/22-failure-clusters/22-01-SUMMARY.md

@src/store/AnalyticsStore.ts
@src/store/index.tsx
@src/components/TestList/SuiteGroup.tsx
@src/components/TestList/TestListItem.tsx
@src/components/NavigationDrawer/index.tsx
@src/layout/MainLayout/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ClusterGroup component</name>
  <files>src/components/FailureClusters/ClusterGroup.tsx</files>
  <action>
Create new directory and file: `src/components/FailureClusters/ClusterGroup.tsx`

Follow SuiteGroup.tsx pattern (expandable list with Collapse):

```typescript
import { List, ListItemButton, ListItemIcon, ListItemText, Collapse, Box, Typography } from '@mui/material'
import { ExpandLess, ExpandMore, ErrorOutline } from '@mui/icons-material'
import { observer } from 'mobx-react-lite'
import type { QaseTestResult } from '../../schemas/QaseTestResult.schema'
import { TestListItem } from '../TestList/TestListItem'
import { usePrefersReducedMotion } from '../../hooks/usePrefersReducedMotion'

interface ClusterGroupProps {
  errorPattern: string
  tests: QaseTestResult[]
  isExpanded: boolean
  onToggle: () => void
  onSelectTest: (id: string) => void
}

export const ClusterGroup = observer(({
  errorPattern,
  tests,
  isExpanded,
  onToggle,
  onSelectTest,
}: ClusterGroupProps) => {
  const prefersReducedMotion = usePrefersReducedMotion()
  const contentId = `cluster-${encodeURIComponent(errorPattern.slice(0, 20))}-content`

  // Display-friendly error pattern (truncate if too long)
  const displayPattern = errorPattern === '__no_error__'
    ? 'No error message'
    : errorPattern.length > 80
      ? errorPattern.slice(0, 80) + '...'
      : errorPattern

  return (
    <>
      <ListItemButton
        onClick={onToggle}
        sx={{
          bgcolor: 'error.dark',
          '&:hover': { bgcolor: 'error.main' },
          borderRadius: 1,
          mb: 0.5,
        }}
        aria-expanded={isExpanded}
        aria-controls={contentId}
      >
        <ListItemIcon sx={{ minWidth: 36, color: 'error.contrastText' }}>
          <ErrorOutline />
        </ListItemIcon>
        <ListItemText
          primary={
            <Typography variant="body2" sx={{ color: 'error.contrastText', fontFamily: 'monospace' }}>
              {displayPattern}
            </Typography>
          }
          secondary={
            <Typography variant="caption" sx={{ color: 'error.contrastText', opacity: 0.8 }}>
              {tests.length} test{tests.length !== 1 ? 's' : ''} affected
            </Typography>
          }
        />
        {isExpanded ? (
          <ExpandLess sx={{ color: 'error.contrastText' }} />
        ) : (
          <ExpandMore sx={{ color: 'error.contrastText' }} />
        )}
      </ListItemButton>
      <Collapse
        in={isExpanded}
        timeout={prefersReducedMotion ? 0 : 'auto'}
        unmountOnExit
        id={contentId}
      >
        <List component="div" disablePadding>
          <Box sx={{ pl: 2, py: 1 }}>
            {tests.map(test => (
              <TestListItem
                key={test.id}
                test={test}
                onSelect={onSelectTest}
              />
            ))}
          </Box>
        </List>
      </Collapse>
    </>
  )
})
```
  </action>
  <verify>TypeScript compilation: `npx tsc --noEmit` passes</verify>
  <done>ClusterGroup component created with expandable list, error pattern display, test count, and test item navigation</done>
</task>

<task type="auto">
  <name>Task 2: Create FailureClusters view component</name>
  <files>src/components/FailureClusters/index.tsx</files>
  <action>
Create `src/components/FailureClusters/index.tsx`:

```typescript
import { useState, useCallback } from 'react'
import { observer } from 'mobx-react-lite'
import { Box, Typography, Paper, List } from '@mui/material'
import { useRootStore } from '../../store'
import { ClusterGroup } from './ClusterGroup'

export const FailureClusters = observer(() => {
  const { analyticsStore, selectTest, reportStore } = useRootStore()
  const [expandedClusters, setExpandedClusters] = useState<Set<string>>(new Set())

  const handleToggle = useCallback((errorPattern: string) => {
    setExpandedClusters(prev => {
      const next = new Set(prev)
      if (next.has(errorPattern)) {
        next.delete(errorPattern)
      } else {
        next.add(errorPattern)
      }
      return next
    })
  }, [])

  const handleSelectTest = useCallback((testId: string) => {
    selectTest(testId)
  }, [selectTest])

  // No report loaded
  if (!reportStore.runData) {
    return (
      <Box
        sx={{
          display: 'flex',
          justifyContent: 'center',
          alignItems: 'center',
          height: '50vh',
          color: 'text.secondary',
        }}
      >
        No report loaded
      </Box>
    )
  }

  const clusters = analyticsStore.failureClusters

  // No failure clusters
  if (clusters.length === 0) {
    return (
      <Box sx={{ p: 3 }}>
        <Typography variant="h5" gutterBottom>
          Failure Clusters
        </Typography>
        <Paper sx={{ p: 3, textAlign: 'center' }}>
          <Typography color="text.secondary">
            No failure clusters found. Tests with similar error messages will appear here when 2 or more tests fail with the same error pattern.
          </Typography>
        </Paper>
      </Box>
    )
  }

  // Calculate totals
  const totalTests = clusters.reduce((sum, c) => sum + c.tests.length, 0)

  return (
    <Box sx={{ p: 3 }}>
      <Box sx={{ mb: 3 }}>
        <Typography variant="h5" gutterBottom>
          Failure Clusters
        </Typography>
        <Typography variant="body2" color="text.secondary">
          {clusters.length} cluster{clusters.length !== 1 ? 's' : ''} grouping {totalTests} failed test{totalTests !== 1 ? 's' : ''} by similar error messages
        </Typography>
      </Box>
      <List>
        {clusters.map(cluster => (
          <ClusterGroup
            key={cluster.errorPattern}
            errorPattern={cluster.errorPattern}
            tests={cluster.tests}
            isExpanded={expandedClusters.has(cluster.errorPattern)}
            onToggle={() => handleToggle(cluster.errorPattern)}
            onSelectTest={handleSelectTest}
          />
        ))}
      </List>
    </Box>
  )
})
```
  </action>
  <verify>TypeScript compilation: `npx tsc --noEmit` passes</verify>
  <done>FailureClusters view component created with cluster list, expand state management, and test navigation</done>
</task>

<task type="auto">
  <name>Task 3: Add navigation and routing for failure-clusters view</name>
  <files>src/store/index.tsx, src/components/NavigationDrawer/index.tsx, src/layout/MainLayout/index.tsx</files>
  <action>
**1. Update RootStore (src/store/index.tsx):**

Change activeView type to include 'failure-clusters':

```typescript
// Line ~25, update the type:
activeView: 'dashboard' | 'tests' | 'analytics' | 'failure-clusters' = 'dashboard'

// Line ~68, update setActiveView signature:
setActiveView = (view: 'dashboard' | 'tests' | 'analytics' | 'failure-clusters') => {
  this.activeView = view
}
```

**2. Update NavigationDrawer (src/components/NavigationDrawer/index.tsx):**

Add BubbleChart icon import and update navItems:

```typescript
// Update imports (add BubbleChart):
import {
  Dashboard as DashboardIcon,
  FormatListBulleted as TestsIcon,
  ErrorOutline as FailureClustersIcon,
  ChevronLeft as ChevronLeftIcon,
  ChevronRight as ChevronRightIcon,
  BubbleChart as AnalyticsIcon,
} from '@mui/icons-material'

// Update navItems array (around line 35):
const navItems = [
  {
    id: 'dashboard' as const,
    label: 'Dashboard',
    icon: <DashboardIcon />,
  },
  {
    id: 'tests' as const,
    label: 'Tests',
    icon: <TestsIcon />,
  },
  {
    id: 'failure-clusters' as const,
    label: 'Failure Clusters',
    icon: <FailureClustersIcon />,
  },
  {
    id: 'analytics' as const,
    label: 'Analytics',
    icon: <AnalyticsIcon />,
  },
]
```

**3. Update MainLayout (src/layout/MainLayout/index.tsx):**

Add import and routing:

```typescript
// Add import at top:
import { FailureClusters } from '../../components/FailureClusters'

// In renderView function, add case before analytics:
if (activeView === 'failure-clusters') {
  return <FailureClusters />
}
```
  </action>
  <verify>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Dev server: `npm run dev` starts without errors
3. Browser: Sidebar shows "Failure Clusters" navigation item
4. Clicking "Failure Clusters" in sidebar shows the view
  </verify>
  <done>
- RootStore activeView type includes 'failure-clusters'
- NavigationDrawer has "Failure Clusters" nav item with ErrorOutline icon
- MainLayout routes to FailureClusters component
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Failure Clusters feature:
- Algorithm in AnalyticsStore groups failed tests by normalized error message
- FailureClusters view displays clusters with expandable groups
- Each cluster shows error pattern and test count
- Clicking test opens test details dock
- Navigation from sidebar
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173
3. Load a report with multiple failed tests (ideally some with similar error messages)
4. Click "Failure Clusters" in sidebar
5. Verify:
   - [ ] Clusters are displayed with error patterns
   - [ ] Each cluster shows count of affected tests
   - [ ] Clicking cluster header expands to show tests
   - [ ] Clicking a test opens test details dock
   - [ ] Only clusters with 2+ tests are shown
   - [ ] Clusters sorted by test count (largest first)
6. If no failures: "No failure clusters found" message displays
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit`
2. Dev server runs: `npm run dev`
3. Navigation works: Sidebar -> Failure Clusters -> view loads
4. Clusters display correctly with error patterns and counts
5. Expand/collapse works with smooth animation (respects reduced motion)
6. Test click opens details dock
7. Empty state shows when no clusters exist
</verification>

<success_criteria>
- FailureClusters view accessible from sidebar navigation
- Clusters displayed with error pattern and affected test count
- Clusters expandable to reveal all tests in group
- Clicking test navigates to test details (dock opens)
- Only clusters with 2+ tests shown
- Clusters sorted by test count descending
- Empty state message when no failure clusters exist
- Accessibility: ARIA attributes on expandable sections
- Animation respects prefers-reduced-motion
</success_criteria>

<output>
After completion, create `.planning/phases/22-failure-clusters/22-02-SUMMARY.md`
</output>
