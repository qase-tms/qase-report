---
phase: 04-test-details-view
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/TestDetails/index.tsx
  - src/components/TestDetails/TestHeader.tsx
  - src/components/TestDetails/TestError.tsx
  - src/components/TestDetails/TestParams.tsx
  - src/components/TestDetails/TestFields.tsx
  - src/layout/MainLayout/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can see test name, status icon, and duration when test selected"
    - "User can see error message and stacktrace for failed/broken tests"
    - "User can see test parameters in key-value format"
    - "User can see custom fields in key-value format"
    - "User can close details view and return to test list"
  artifacts:
    - path: "src/components/TestDetails/index.tsx"
      provides: "Main container with observer, sections with conditional rendering"
      exports: ["TestDetails"]
    - path: "src/components/TestDetails/TestHeader.tsx"
      provides: "Name, status icon, duration display"
      exports: ["TestHeader"]
    - path: "src/components/TestDetails/TestError.tsx"
      provides: "Error message and stacktrace with monospace formatting"
      exports: ["TestError"]
    - path: "src/components/TestDetails/TestParams.tsx"
      provides: "Parameters key-value list"
      exports: ["TestParams"]
    - path: "src/components/TestDetails/TestFields.tsx"
      provides: "Custom fields key-value list with null handling"
      exports: ["TestFields"]
  key_links:
    - from: "src/components/TestDetails/index.tsx"
      to: "src/store/index.tsx"
      via: "useRootStore().selectedTest and clearSelection"
      pattern: "useRootStore.*selectedTest|clearSelection"
    - from: "src/layout/MainLayout/index.tsx"
      to: "src/components/TestDetails/index.tsx"
      via: "import and render in Sidebar children"
      pattern: "import.*TestDetails.*Sidebar.*TestDetails"
    - from: "src/components/TestDetails/TestHeader.tsx"
      to: "src/components/TestList/statusIcon.tsx"
      via: "getStatusIcon import and usage"
      pattern: "import.*getStatusIcon.*statusIcon"
---

<objective>
Create TestDetails component that displays complete test information in the Sidebar.

Purpose: Enable users to view full test details including name, status, duration, error info, parameters, and custom fields.
Output: TestDetails component folder with subcomponents, integrated into MainLayout Sidebar.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-test-details-view/04-RESEARCH.md

@src/store/index.tsx
@src/schemas/QaseTestResult.schema.ts
@src/components/Sidebar/index.tsx
@src/components/TestList/statusIcon.tsx
@src/components/TestList/TestListItem.tsx
@src/layout/MainLayout/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TestDetails subcomponents (TestHeader, TestError, TestParams, TestFields)</name>
  <files>
    src/components/TestDetails/TestHeader.tsx
    src/components/TestDetails/TestError.tsx
    src/components/TestDetails/TestParams.tsx
    src/components/TestDetails/TestFields.tsx
  </files>
  <action>
Create four presentational components that receive QaseTestResult as prop:

**TestHeader.tsx:**
- Display test title with status icon (reuse getStatusIcon from ../TestList/statusIcon)
- Show duration using established pattern: >= 1000 ? seconds with .toFixed(1) : ms
- Use MUI Stack for layout, Box with flex for title+icon row
- Show muted badge (Chip size="small" with label "Muted") if test.muted is true

**TestError.tsx:**
- Section heading "Error Details"
- Conditionally render test.message with color="error"
- Conditionally render test.execution.stacktrace in monospace:
  - Box container with bgcolor="grey.100", p=2, borderRadius=1, maxHeight=400, overflow="auto"
  - Typography with component="pre", fontFamily="monospace", fontSize="0.875rem", whiteSpace="pre-wrap", wordBreak="break-all", margin=0

**TestParams.tsx:**
- Section heading "Parameters"
- Map Object.entries(test.params) to key-value rows
- Use Box with display="flex", gap=1 for each row
- Key: Typography fontWeight="600", minWidth=120
- Value: Typography color="text.secondary"

**TestFields.tsx:**
- Section heading "Custom Fields"
- Map Object.entries(test.fields) to key-value rows
- Same layout as TestParams
- Handle null values with nullish coalescing: value ?? 'N/A'

All components: TypeScript interface for props with test: QaseTestResult
  </action>
  <verify>Files exist with correct exports: `ls src/components/TestDetails/*.tsx`</verify>
  <done>Four subcomponents created with proper TypeScript types and MUI styling</done>
</task>

<task type="auto">
  <name>Task 2: Create TestDetails container component</name>
  <files>src/components/TestDetails/index.tsx</files>
  <action>
Create main container component with observer pattern:

- Import observer from mobx-react-lite
- Import useRootStore from ../../store
- Import MUI components: Stack, Divider, Typography, IconButton, Box
- Import CloseIcon from @mui/icons-material/Close
- Import all four subcomponents

**Component structure:**
```
export const TestDetails = observer(() => {
  const { selectedTest, clearSelection } = useRootStore()

  // Early return for null state
  if (!selectedTest) {
    return <Typography>Select a test to view details</Typography>
  }

  return (
    <Box sx={{ p: 2 }}>
      {/* Header with close button */}
      <Box sx={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', mb: 2 }}>
        <Typography variant="h6">Test Details</Typography>
        <IconButton onClick={clearSelection} size="small" aria-label="close details">
          <CloseIcon />
        </IconButton>
      </Box>

      {/* Sections with dividers - conditional rendering */}
      <Stack spacing={3} divider={<Divider />}>
        <TestHeader test={selectedTest} />
        {selectedTest.execution.stacktrace && <TestError test={selectedTest} />}
        {Object.keys(selectedTest.params).length > 0 && <TestParams test={selectedTest} />}
        {Object.keys(selectedTest.fields).length > 0 && <TestFields test={selectedTest} />}
      </Stack>
    </Box>
  )
})
```

IMPORTANT: Use explicit `> 0` comparison for Object.keys().length checks to avoid rendering "0" in UI.
  </action>
  <verify>`grep -l "observer" src/components/TestDetails/index.tsx && grep -l "selectedTest" src/components/TestDetails/index.tsx`</verify>
  <done>TestDetails container uses observer pattern, handles null state, renders sections conditionally</done>
</task>

<task type="auto">
  <name>Task 3: Integrate TestDetails into MainLayout Sidebar</name>
  <files>src/layout/MainLayout/index.tsx</files>
  <action>
Update MainLayout to render TestDetails in Sidebar:

1. Add import: `import { TestDetails } from '../../components/TestDetails'`

2. Replace Sidebar children "Hello from sidebar" with `<TestDetails />`

3. Remove the "Open sidebar" button - sidebar now opens only via test selection (already wired in Phase 3)

The Sidebar opening is already handled by TestList selectTest -> openDock pattern from Phase 3.
clearSelection in TestDetails close button will close the sidebar via existing closeDock behavior.
  </action>
  <verify>
Run dev server: `npm run dev &`
Wait for server start, then open browser at localhost:5173
Load a test report, click on a test in the list
Expected: Sidebar opens with test details showing name, status icon, duration
Click close button: Sidebar closes
  </verify>
  <done>TestDetails renders in Sidebar when test is selected, close button works</done>
</task>

</tasks>

<verification>
Manual verification:
1. Load report with multiple tests (passed, failed, broken, skipped)
2. Click on passed test - see name, status icon (green check), duration
3. Click on failed test - see error message and stacktrace section
4. Click on test with parameters - see Parameters section with key-value pairs
5. Click on test with custom fields - see Custom Fields section
6. Close button returns to test list
7. Different test selection updates detail view automatically (MobX reactivity)
</verification>

<success_criteria>
- DETL-01: Test details shows name, status (icon), and duration
- DETL-02: Failed/broken tests display error message and stacktrace with proper formatting
- DETL-03: Parameters displayed in key-value format (only when params exist)
- DETL-04: Custom fields displayed in key-value format with null handling
- Navigation: Close button clears selection and closes sidebar
- Reactivity: Selecting different test updates detail view without page refresh
</success_criteria>

<output>
After completion, create `.planning/phases/04-test-details-view/04-01-SUMMARY.md`
</output>
