---
phase: 34-tanstack-table-migration
plan: 03
type: execute
wave: 3
depends_on: ["34-02"]
files_modified:
  - src/components/TestList/DataTable.tsx
  - src/components/TestList/index.tsx
autonomous: true

must_haves:
  truths:
    - Table scrolls smoothly with 500+ tests loaded
    - Only visible rows + overscan rendered (not all 500+ rows)
    - Scroll position persists during filtering/sorting
    - Header remains visible (sticky) when scrolling table body
    - No white space flashing or janky scrolling
  artifacts:
    - path: src/components/TestList/DataTable.tsx
      provides: Virtualized table with useVirtualizer
      contains: "useVirtualizer"
      min_lines: 100
    - path: src/components/TestList/index.tsx
      provides: Fixed height container for virtualization
      contains: "height:"
  key_links:
    - from: src/components/TestList/DataTable.tsx
      to: useVirtualizer
      via: @tanstack/react-virtual import
      pattern: "useVirtualizer.*estimateSize.*overscan"
    - from: virtualRows
      to: position: absolute
      via: CSS transform
      pattern: "transform:.*translateY"
---

<objective>
Integrate @tanstack/react-virtual with DataTable for performant rendering of 500+ test rows.

Purpose: Maintain Phase 17 virtual scrolling performance (~6KB bundle) with new table-based UI.
Output: DataTable renders only visible rows, handles large datasets without lag.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-tanstack-table-migration/34-RESEARCH.md
@.planning/phases/34-tanstack-table-migration/34-02-SUMMARY.md
@src/components/TestList/DataTable.tsx
@src/components/TestList/VirtualizedTestList.tsx
@src/components/TestList/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add virtualization to DataTable component</name>
  <files>src/components/TestList/DataTable.tsx</files>
  <action>
Update DataTable.tsx to integrate @tanstack/react-virtual:

**Add imports:**
```typescript
import { useRef } from 'react'
import { useVirtualizer } from '@tanstack/react-virtual'
```

**Add ref for scroll container:**
```typescript
const tableContainerRef = useRef<HTMLDivElement>(null)
```

**Get sorted rows from table:**
```typescript
const { rows } = table.getRowModel()
```

**Configure virtualizer:**
```typescript
const rowVirtualizer = useVirtualizer({
  count: rows.length,
  getScrollElement: () => tableContainerRef.current,
  estimateSize: () => 72, // Match current VirtualizedTestList row height
  overscan: 2, // Match current overscanCount
})

const virtualRows = rowVirtualizer.getVirtualItems()
```

**Update table container div:**
```typescript
<div
  ref={tableContainerRef}
  className="overflow-auto rounded-md border"
  style={{ height: '600px' }} // Will be made configurable via props
>
```

**Update TableBody rendering:**
Replace `table.getRowModel().rows.map()` with:

```typescript
<TableBody style={{ height: `${rowVirtualizer.getTotalSize()}px`, position: 'relative' }}>
  {virtualRows.length ? (
    virtualRows.map((virtualRow) => {
      const row = rows[virtualRow.index]
      return (
        <TableRow
          key={row.id}
          data-index={virtualRow.index}
          onClick={() => onRowClick?.(row.original)}
          className="cursor-pointer hover:bg-accent"
          style={{
            position: 'absolute',
            transform: `translateY(${virtualRow.start}px)`,
            width: '100%',
            height: '72px', // Fixed height per research recommendation
          }}
        >
          {row.getVisibleCells().map((cell) => (
            <TableCell key={cell.id}>
              {flexRender(cell.column.columnDef.cell, cell.getContext())}
            </TableCell>
          ))}
        </TableRow>
      )
    })
  ) : (
    <TableRow>
      <TableCell colSpan={columns.length} className="text-center">
        No results.
      </TableCell>
    </TableRow>
  )}
</TableBody>
```

Per research Pattern 2: Use position: absolute with transform: translateY() for virtualized rows. This is critical for smooth scrolling performance (research Pitfall 2).

Per research: estimateSize: 72 matches current VirtualizedTestList.tsx row height (line 123). Fixed heights are simpler than dynamic heights - no measureElement needed (research Open Question #4).

Per research: overscan: 2 matches current implementation (VirtualizedTestList.tsx line 140). Renders 2 extra rows above/below viewport to prevent white space during fast scrolling.

AVOID anti-patterns:
- Don't skip position: absolute - causes layout thrashing (research Pitfall 2)
- Don't use height: auto on virtualized rows - breaks calculations (research Pitfall 2)
- Always use virtualRows, not rows directly - defeats virtualization purpose (research Anti-Patterns)
  </action>
  <verify>
```bash
cat src/components/TestList/DataTable.tsx | grep -E "useVirtualizer|estimateSize.*72|position.*absolute|translateY"
```
Component uses virtual scrolling with correct configuration.
  </verify>
  <done>DataTable.tsx uses useVirtualizer with estimateSize: 72 and overscan: 2, renders virtualized rows with position: absolute and transform: translateY()</done>
</task>

<task type="auto">
  <name>Task 2: Make table height configurable and integrate with TestList page</name>
  <files>
src/components/TestList/DataTable.tsx
src/components/TestList/index.tsx
  </files>
  <action>
**Update DataTable.tsx props:**
Add height prop to DataTableProps interface:
```typescript
interface DataTableProps<TData, TValue> {
  columns: ColumnDef<TData, TValue>[]
  data: TData[]
  onRowClick?: (row: TData) => void
  height?: number // Default: 600
}
```

Replace hardcoded height with:
```typescript
style={{ height: `${height ?? 600}px` }}
```

**Update TestList/index.tsx:**
Calculate available height dynamically:

```typescript
// Calculate table height: viewport - header - filters - search - padding
// This ensures table fills available space without causing page scrollbar
const tableHeight = window.innerHeight - 200 // Adjust based on actual layout
```

Pass height to DataTable:
```typescript
<DataTable
  columns={columns}
  data={data}
  onRowClick={(test) => selectTest(test.id)}
  height={tableHeight}
/>
```

Per Phase 32-03 layout decision (STATE.md): Main content area has overflow-y-auto with CSS Grid providing height constraint. Table should fill this space efficiently.

Alternative approach if window.innerHeight causes issues: Use CSS flexbox on parent div with flex-1 and let table inherit height via flex: 1 on DataTable wrapper. Choose whichever integrates cleanly with existing MainLayout structure.
  </action>
  <verify>
```bash
cat src/components/TestList/DataTable.tsx | grep -E "height\?:"
cat src/components/TestList/index.tsx | grep -E "height="
npm run dev
```
DataTable accepts height prop, TestList passes calculated height, dev server starts.
  </verify>
  <done>DataTable.tsx accepts optional height prop (default 600), TestList/index.tsx calculates and passes table height based on viewport</done>
</task>

</tasks>

<verification>
1. Load test report with 500+ tests (or use test-data/ if available)
2. Open browser DevTools Performance tab, start recording
3. Scroll table rapidly up and down
4. Stop recording and analyze:
   - Frame rate should stay near 60 FPS (no significant drops)
   - CPU usage should be reasonable (not spiking)
5. Check DOM elements: Only ~10-20 TableRow elements should exist (visible + overscan), not 500+
6. Verify scroll position preserved when:
   - Applying status filter
   - Sorting by column
   - Searching by text
7. Verify header stays visible (sticky) when scrolling body
8. Load report with < 20 tests - verify no white space gaps or layout issues
</verification>

<success_criteria>
- [ ] DataTable.tsx integrates useVirtualizer from @tanstack/react-virtual
- [ ] Virtual scrolling parameters: estimateSize: 72, overscan: 2
- [ ] Virtualized rows use position: absolute with transform: translateY()
- [ ] Only visible rows + overscan rendered in DOM (not all rows)
- [ ] Smooth 60 FPS scrolling with 500+ tests
- [ ] Header remains sticky during scroll
- [ ] Scroll position preserved during filtering/sorting
- [ ] No console warnings about layout shifts or re-renders
</success_criteria>

<output>
After completion, create `.planning/phases/34-tanstack-table-migration/34-03-SUMMARY.md`
</output>
