---
phase: 34-tanstack-table-migration
plan: 04
type: execute
wave: 4
depends_on: ["34-03"]
files_modified:
  - src/components/CommandPalette/CommandPalette.tsx
  - src/components/CommandPalette/index.ts
  - src/layout/MainLayout/index.tsx
  - src/components/ui/command.tsx
autonomous: true

must_haves:
  truths:
    - Pressing Cmd+K (Mac) or Ctrl+K (Windows/Linux) opens command palette
    - User can type search query and see fuzzy-matched results
    - Search matches test titles with typo tolerance (fuzzy matching)
    - Pressing Escape closes command palette
    - Clicking result navigates to test details (opens drawer)
    - Command palette shows up to 10 results
  artifacts:
    - path: src/components/CommandPalette/CommandPalette.tsx
      provides: Command palette component with fuzzy search
      exports: ["CommandPalette"]
      min_lines: 80
    - path: src/components/ui/command.tsx
      provides: shadcn Command UI component
      exports: ["Command", "CommandInput", "CommandList", "CommandItem"]
    - path: src/layout/MainLayout/index.tsx
      provides: Command palette integration with Cmd+K
      contains: "CommandPalette"
  key_links:
    - from: src/components/CommandPalette/CommandPalette.tsx
      to: rankItem from @tanstack/match-sorter-utils
      via: fuzzy filter function
      pattern: "rankItem.*\.passed"
    - from: react-hotkeys-hook
      to: CommandPalette open state
      via: useHotkeys('mod+k')
      pattern: "useHotkeys.*mod\\+k"
---

<objective>
Create command palette with Cmd+K hotkey and fuzzy search using @tanstack/match-sorter-utils.

Purpose: Provide quick test navigation with typo-tolerant search (success criteria #3).
Output: Working command palette accessible via Cmd+K, searches tests with fuzzy matching.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/34-tanstack-table-migration/34-RESEARCH.md
@.planning/phases/34-tanstack-table-migration/34-03-SUMMARY.md
@src/components/TestList/TestListSearch.tsx
@src/store/TestResultsStore.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install shadcn Command component and create fuzzy filter</name>
  <files>
src/components/ui/command.tsx
src/components/CommandPalette/CommandPalette.tsx
src/components/CommandPalette/index.ts
  </files>
  <action>
**Install shadcn command component:**
```bash
npx shadcn@latest add command -y
```

This installs Command, CommandDialog, CommandInput, CommandList, CommandEmpty, CommandGroup, CommandItem primitives.

**Create CommandPalette component:**

File: src/components/CommandPalette/CommandPalette.tsx

```typescript
import { useState, useMemo } from 'react'
import { observer } from 'mobx-react-lite'
import { Search } from 'lucide-react'
import { rankItem } from '@tanstack/match-sorter-utils'
import { useRootStore } from '@/store'
import {
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandItem,
} from '@/components/ui/command'
import { getStatusIcon } from '@/components/TestList/statusIcon'

interface CommandPaletteProps {
  open: boolean
  onOpenChange: (open: boolean) => void
}

export const CommandPalette = observer(({ open, onOpenChange }: CommandPaletteProps) => {
  const { testResultsStore, selectTest } = useRootStore()
  const [query, setQuery] = useState('')

  // Fuzzy filter using match-sorter-utils
  const results = useMemo(() => {
    if (!query.trim()) {
      return []
    }

    const lowerQuery = query.toLowerCase()

    // Rank each test by title match quality
    const ranked = testResultsStore.resultsList
      .map(test => ({
        test,
        rank: rankItem(test.title, lowerQuery)
      }))
      .filter(item => item.rank.passed) // Only include matches above threshold
      .sort((a, b) => b.rank.rank - a.rank.rank) // Sort by match quality
      .slice(0, 10) // Limit to 10 results
      .map(item => item.test)

    return ranked
  }, [query, testResultsStore.resultsList])

  const handleSelect = (testId: string) => {
    selectTest(testId)
    onOpenChange(false)
    setQuery('') // Reset query on selection
  }

  return (
    <CommandDialog open={open} onOpenChange={onOpenChange}>
      <CommandInput
        placeholder="Search tests..."
        value={query}
        onValueChange={setQuery}
      />
      <CommandList>
        <CommandEmpty>No tests found.</CommandEmpty>
        {results.map(test => (
          <CommandItem
            key={test.id}
            value={test.id}
            onSelect={() => handleSelect(test.id)}
            className="flex items-center gap-2 cursor-pointer"
          >
            {getStatusIcon(test.execution.status)}
            <span className="flex-1 truncate">{test.title}</span>
            <span className="text-xs text-muted-foreground">
              {test.execution.duration >= 1000
                ? `${(test.execution.duration / 1000).toFixed(1)}s`
                : `${test.execution.duration}ms`}
            </span>
          </CommandItem>
        ))}
      </CommandList>
    </CommandDialog>
  )
})
```

**Create barrel export:**

File: src/components/CommandPalette/index.ts
```typescript
export { CommandPalette } from './CommandPalette'
```

Per research Pattern 4: rankItem() scores each test title against query, returns { passed: boolean, rank: number }. Only include matches with passed: true, sort by rank descending (higher rank = better match).

Per research Open Question #2: Command palette uses independent fuzzy logic (doesn't need full TanStack Table instance). Shares rankItem function concept but operates on resultsList directly.

AVOID anti-pattern: Don't use simple .includes() - requirement is fuzzy matching with typo tolerance (success criteria #3 from planning context).
  </action>
  <verify>
```bash
test -f src/components/ui/command.tsx && test -f src/components/CommandPalette/CommandPalette.tsx && echo "Components created"
cat src/components/CommandPalette/CommandPalette.tsx | grep -E "rankItem|match-sorter-utils"
```
Command component installed, CommandPalette uses fuzzy filtering.
  </verify>
  <done>src/components/ui/command.tsx installed via shadcn CLI, CommandPalette.tsx implements fuzzy search with rankItem from @tanstack/match-sorter-utils</done>
</task>

<task type="auto">
  <name>Task 2: Integrate command palette with Cmd+K hotkey in MainLayout</name>
  <files>src/layout/MainLayout/index.tsx</files>
  <action>
Update MainLayout/index.tsx to add command palette with keyboard shortcut:

**Add imports:**
```typescript
import { useState } from 'react'
import { useHotkeys } from 'react-hotkeys-hook'
import { CommandPalette } from '@/components/CommandPalette'
```

**Add state for command palette:**
```typescript
const [commandPaletteOpen, setCommandPaletteOpen] = useState(false)
```

**Add hotkey binding:**
```typescript
// mod+k works as Cmd+K on Mac, Ctrl+K on Windows/Linux
useHotkeys('mod+k', (e) => {
  e.preventDefault() // Prevent browser default (search bar focus)
  setCommandPaletteOpen(true)
}, { enableOnFormTags: true }) // Works even when input focused
```

**Add CommandPalette component:**
Place before closing tag of main layout container:
```typescript
<CommandPalette
  open={commandPaletteOpen}
  onOpenChange={setCommandPaletteOpen}
/>
```

Per package.json: react-hotkeys-hook v5.2.4 already installed (no new dependency).

Per research: 'mod+k' is cross-platform modifier - automatically maps to Cmd on Mac, Ctrl on Windows/Linux.

enableOnFormTags: true ensures hotkey works even when user is typing in TestListSearch input (common UX pattern for command palettes).

IMPORTANT: CommandPalette should be sibling to main content (not inside scrollable container) so dialog overlay covers entire viewport.
  </action>
  <verify>
```bash
cat src/layout/MainLayout/index.tsx | grep -E "useHotkeys|mod\\+k|CommandPalette|commandPaletteOpen"
npm run dev
```
MainLayout imports and renders CommandPalette with hotkey binding, dev server starts.
  </verify>
  <done>MainLayout/index.tsx uses useHotkeys('mod+k') to open CommandPalette, renders CommandPalette component with controlled open state</done>
</task>

</tasks>

<verification>
1. Run `npm run dev` and load test report
2. Press Cmd+K (Mac) or Ctrl+K (Windows/Linux) - verify command palette opens
3. Type "login" - verify tests with "login" in title appear
4. Type "logn" (typo) - verify fuzzy matching still finds "login" tests
5. Type "auth" - verify tests with "authentication" appear (partial match)
6. Verify results show status icon and duration
7. Verify maximum 10 results displayed (if more than 10 matches)
8. Press Escape - verify palette closes
9. Click result - verify:
   - TestDetailsDrawer opens with correct test
   - Command palette closes automatically
   - Query resets (next open shows empty)
10. Test hotkey while focused in TestListSearch input - verify still works (enableOnFormTags)
</verification>

<success_criteria>
- [ ] shadcn/ui command component installed at src/components/ui/command.tsx
- [ ] CommandPalette.tsx implements fuzzy search with rankItem
- [ ] MainLayout/index.tsx integrates CommandPalette with useHotkeys('mod+k')
- [ ] Cmd+K (Mac) or Ctrl+K (Windows/Linux) opens command palette
- [ ] Typing query shows fuzzy-matched results (typo-tolerant)
- [ ] Results limited to 10 items
- [ ] Clicking result opens TestDetailsDrawer and closes palette
- [ ] Escape closes palette
- [ ] No console errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/34-tanstack-table-migration/34-04-SUMMARY.md`
</output>
