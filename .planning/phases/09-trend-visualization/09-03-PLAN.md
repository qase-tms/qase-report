---
phase: 09-trend-visualization
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - package.json
  - src/components/Dashboard/HistoryTimeline.tsx
  - src/components/Dashboard/index.tsx
autonomous: false

must_haves:
  truths:
    - "User can see history timeline of recent runs with status indicators"
    - "Timeline shows run date, duration, and pass/fail counts"
    - "Most recent run appears at top of timeline"
  artifacts:
    - path: "src/components/Dashboard/HistoryTimeline.tsx"
      provides: "MUI Timeline showing recent test runs"
      exports: ["HistoryTimeline"]
      min_lines: 80
    - path: "src/components/Dashboard/index.tsx"
      provides: "Dashboard with HistoryTimeline integration"
      contains: "HistoryTimeline"
  key_links:
    - from: "src/components/Dashboard/HistoryTimeline.tsx"
      to: "src/store/HistoryStore.ts"
      via: "useRootStore().historyStore.recentRuns"
      pattern: "historyStore\\.recentRuns"
    - from: "src/components/Dashboard/index.tsx"
      to: "src/components/Dashboard/HistoryTimeline.tsx"
      via: "import and conditional render"
      pattern: "HistoryTimeline"
---

<objective>
Create HistoryTimeline component using MUI Timeline and integrate into Dashboard.

Purpose: Show chronological view of recent test runs with visual status indicators. Complements TrendsChart by providing detailed run-by-run breakdown.

Output: HistoryTimeline component showing last 10 runs, integrated into Dashboard sidebar or below trends.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-trend-visualization/09-01-SUMMARY.md
@src/store/HistoryStore.ts
@src/components/Dashboard/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install MUI Lab for Timeline components</name>
  <files>package.json</files>
  <action>
Install @mui/lab for Timeline components:

```bash
cd /Users/gda/Documents/github/qase-tms/qase-report && npm install @mui/lab@^5.0.0-alpha.170
```

MUI Timeline is in @mui/lab (not @mui/material). Use alpha version compatible with MUI 5.12.0.
  </action>
  <verify>
Run: `grep "@mui/lab" package.json`
Check: @mui/lab is in dependencies
  </verify>
  <done>
@mui/lab added to package.json dependencies
  </done>
</task>

<task type="auto">
  <name>Task 2: Create HistoryTimeline component</name>
  <files>src/components/Dashboard/HistoryTimeline.tsx</files>
  <action>
Create MUI Timeline-based history visualization:

1. **Imports:**
   ```typescript
   import { observer } from 'mobx-react-lite'
   import { Box, Card, CardContent, Typography, Chip, Stack } from '@mui/material'
   import {
     Timeline,
     TimelineItem,
     TimelineSeparator,
     TimelineConnector,
     TimelineContent,
     TimelineDot,
     TimelineOppositeContent,
   } from '@mui/lab'
   import CheckCircleIcon from '@mui/icons-material/CheckCircle'
   import ErrorIcon from '@mui/icons-material/Error'
   import WarningIcon from '@mui/icons-material/Warning'
   import { useRootStore } from '../../store'
   import type { HistoricalRun } from '../../schemas/QaseHistory.schema'
   ```

2. **Helper function: getRunStatusColor**
   ```typescript
   const getRunStatusColor = (run: HistoricalRun): 'success' | 'error' | 'warning' => {
     if (run.stats.failed > 0) return 'error'
     if (run.stats.skipped > 0 || run.stats.broken > 0) return 'warning'
     return 'success'
   }
   ```

3. **Helper function: getRunStatusIcon**
   ```typescript
   const getRunStatusIcon = (run: HistoricalRun) => {
     if (run.stats.failed > 0) return <ErrorIcon />
     if (run.stats.skipped > 0 || run.stats.broken > 0) return <WarningIcon />
     return <CheckCircleIcon />
   }
   ```

4. **Helper function: formatDuration**
   ```typescript
   const formatDuration = (ms: number): string => {
     if (ms < 1000) return `${ms}ms`
     if (ms < 60000) return `${(ms / 1000).toFixed(1)}s`
     return `${Math.floor(ms / 60000)}m ${Math.round((ms % 60000) / 1000)}s`
   }
   ```

5. **HistoryTimeline component (observer-wrapped):**
   - Get historyStore from useRootStore()
   - Return null if recentRuns.length === 0

6. **Timeline layout:**
   ```tsx
   <Card>
     <CardContent>
       <Typography variant="h6" gutterBottom>
         Recent Runs
       </Typography>
       <Timeline position="right">
         {historyStore.recentRuns.map((run, index) => (
           <TimelineItem key={run.run_id}>
             <TimelineOppositeContent sx={{ flex: 0.3 }}>
               <Typography variant="body2" color="text.secondary">
                 {new Date(run.start_time).toLocaleDateString()}
               </Typography>
               <Typography variant="caption" color="text.secondary">
                 {new Date(run.start_time).toLocaleTimeString()}
               </Typography>
             </TimelineOppositeContent>
             <TimelineSeparator>
               <TimelineDot color={getRunStatusColor(run)}>
                 {getRunStatusIcon(run)}
               </TimelineDot>
               {index < historyStore.recentRuns.length - 1 && <TimelineConnector />}
             </TimelineSeparator>
             <TimelineContent>
               <Typography variant="body2" fontWeight="medium">
                 {run.title || `Run ${run.run_id}`}
               </Typography>
               <Stack direction="row" spacing={0.5} flexWrap="wrap" sx={{ mt: 0.5 }}>
                 <Chip
                   label={`${run.stats.passed} passed`}
                   size="small"
                   color="success"
                   variant="outlined"
                 />
                 {run.stats.failed > 0 && (
                   <Chip
                     label={`${run.stats.failed} failed`}
                     size="small"
                     color="error"
                     variant="outlined"
                   />
                 )}
                 {run.stats.skipped > 0 && (
                   <Chip
                     label={`${run.stats.skipped} skipped`}
                     size="small"
                     color="warning"
                     variant="outlined"
                   />
                 )}
               </Stack>
               <Typography variant="caption" color="text.secondary">
                 {formatDuration(run.duration)}
               </Typography>
             </TimelineContent>
           </TimelineItem>
         ))}
       </Timeline>
     </CardContent>
   </Card>
   ```

7. **Export HistoryTimeline as named export**

Handle edge cases:
- Empty recentRuns: return null
- No title: show "Run {run_id}"
- Zero failed/skipped: don't show those chips
  </action>
  <verify>
Run: `cd /Users/gda/Documents/github/qase-tms/qase-report && npx tsc --noEmit`
Check: No TypeScript errors
Check: File exists with export: `grep "export.*HistoryTimeline" src/components/Dashboard/HistoryTimeline.tsx`
  </verify>
  <done>
HistoryTimeline.tsx exists with:
- MUI Timeline showing recent runs
- Color-coded status dots (green/red/yellow)
- Date/time on left, run details on right
- Chips showing passed/failed/skipped counts
- Duration formatted as human-readable
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate HistoryTimeline into Dashboard</name>
  <files>src/components/Dashboard/index.tsx</files>
  <action>
Update Dashboard to show HistoryTimeline alongside TrendsChart:

1. **Add import:**
   ```typescript
   import { HistoryTimeline } from './HistoryTimeline'
   ```

2. **Get historyStore from useRootStore:**
   ```typescript
   const { reportStore, analyticsStore, historyStore } = useRootStore()
   ```

3. **Update layout to show Timeline alongside Trends:**
   After TrendsChart, add HistoryTimeline in a two-column layout:
   ```tsx
   {(analyticsStore.hasTrendData || historyStore.recentRuns.length > 0) && (
     <Box sx={{ mt: 3 }}>
       <Grid container spacing={3}>
         {analyticsStore.hasTrendData && (
           <Grid item xs={12} lg={8}>
             <TrendsChart />
           </Grid>
         )}
         {historyStore.recentRuns.length > 0 && (
           <Grid item xs={12} lg={4}>
             <HistoryTimeline />
           </Grid>
         )}
       </Grid>
     </Box>
   )}
   ```

4. **Remove previous TrendsChart-only conditional:**
   Replace the earlier `{analyticsStore.hasTrendData && (...)}` block with the combined layout above.

Layout strategy:
- Desktop (lg+): Trends 8 cols, Timeline 4 cols side by side
- Tablet/Mobile: Full width stacked vertically
- Show Timeline even with only 1 run (timeline useful before trends)
  </action>
  <verify>
Run: `cd /Users/gda/Documents/github/qase-tms/qase-report && npx tsc --noEmit`
Check: HistoryTimeline imported: `grep "import.*HistoryTimeline" src/components/Dashboard/index.tsx`
Check: Both components conditionally rendered
  </verify>
  <done>
Dashboard shows TrendsChart and HistoryTimeline in responsive two-column layout. Both components conditionally render based on data availability.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify trend visualization</name>
  <files>n/a</files>
  <action>
Human verification of complete trend visualization implementation.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173
3. Load a report directory that contains test-history.json with multiple runs
4. Verify Dashboard shows:
   - Pass rate trend chart with colored lines (green/red/yellow)
   - Duration trend chart showing execution time
   - History timeline with recent runs and status indicators
5. Hover over chart points - tooltips should show detailed information
6. Verify responsive layout - resize browser to see charts stack on mobile

If no test-history.json available:
- Dashboard should show only the existing stats cards (no empty charts)
- This is correct behavior - trends require history data
  </verify>
  <done>
User confirms all trend visualization components work correctly:
- Charts display with correct data
- Tooltips show detailed information
- Timeline shows recent runs with status indicators
- Responsive layout works on mobile
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build` succeeds
2. MUI Lab dependency: Listed in package.json dependencies
3. HistoryTimeline renders: Shows recent runs with status indicators
4. Responsive layout: TrendsChart and HistoryTimeline stack on mobile
5. Conditional rendering: Components hidden when no history data
6. Human verification: Visual appearance and interactivity confirmed
</verification>

<success_criteria>
- [ ] @mui/lab added to package.json
- [ ] HistoryTimeline.tsx exists with 80+ lines
- [ ] Timeline shows recent runs with date/time
- [ ] Status indicators (green/red/yellow dots) match run results
- [ ] Chips show passed/failed/skipped counts
- [ ] Dashboard shows TrendsChart and HistoryTimeline side by side
- [ ] Responsive layout works on mobile
- [ ] Human verification passed
- [ ] All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-trend-visualization/09-03-SUMMARY.md`
</output>
