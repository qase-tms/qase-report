---
phase: 09-trend-visualization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/store/AnalyticsStore.ts
  - src/store/index.tsx
autonomous: true

must_haves:
  truths:
    - "AnalyticsStore computes pass rate trend from history data"
    - "AnalyticsStore computes duration trend from history data"
    - "Trend data includes timestamps for time-series rendering"
  artifacts:
    - path: "src/store/AnalyticsStore.ts"
      provides: "Computed trends from HistoryStore"
      exports: ["AnalyticsStore"]
      min_lines: 80
    - path: "src/store/index.tsx"
      provides: "AnalyticsStore integration"
      contains: "analyticsStore"
  key_links:
    - from: "src/store/AnalyticsStore.ts"
      to: "src/store/HistoryStore.ts"
      via: "root.historyStore access"
      pattern: "root\\.historyStore"
    - from: "src/store/index.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "import and instantiation"
      pattern: "new AnalyticsStore"
---

<objective>
Create AnalyticsStore with computed trend data derived from HistoryStore history runs.

Purpose: Provide reactive trend data for charts without recomputing on every render. MobX computed values cache results and only recompute when dependencies change.

Output: AnalyticsStore with passRateTrend and durationTrend computed properties integrated into RootStore.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-history-infrastructure/08-02-SUMMARY.md
@src/store/HistoryStore.ts
@src/store/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsStore with computed trend data</name>
  <files>src/store/AnalyticsStore.ts</files>
  <action>
Create MobX store for analytics computations:

1. **Imports:**
   - makeAutoObservable from mobx
   - RootStore type from './index'
   - HistoricalRun type from '../schemas/QaseHistory.schema'

2. **TrendDataPoint interface:**
   ```typescript
   interface TrendDataPoint {
     runId: string
     timestamp: number
     date: string // formatted for chart display
     passed: number
     failed: number
     skipped: number
     broken: number
     total: number
     passRate: number // percentage 0-100
     duration: number // milliseconds
   }
   ```

3. **AnalyticsStore class:**
   - Constructor takes root: RootStore
   - Call makeAutoObservable(this)

4. **Computed property: passRateTrend**
   ```typescript
   get passRateTrend(): TrendDataPoint[] {
     const history = this.root.historyStore.history
     if (!history || history.runs.length === 0) return []

     return history.runs
       .slice() // don't mutate original
       .sort((a, b) => a.start_time - b.start_time) // oldest first for chart
       .map(run => this.mapRunToTrendPoint(run))
   }
   ```

5. **Computed property: durationTrend**
   ```typescript
   get durationTrend(): TrendDataPoint[] {
     // Same as passRateTrend - data structure includes duration
     return this.passRateTrend
   }
   ```

6. **Helper method: mapRunToTrendPoint**
   - Map HistoricalRun to TrendDataPoint
   - Calculate passRate as (passed/total * 100)
   - Format date using toLocaleDateString() for chart labels
   - Handle edge cases: zero total (passRate = 0)

7. **Computed property: hasTrendData**
   ```typescript
   get hasTrendData(): boolean {
     return this.passRateTrend.length >= 2
   }
   ```

8. **Export AnalyticsStore class and TrendDataPoint interface**

No external dependencies needed - use native Date formatting. date-fns will be added in Plan 02 if needed for chart formatting.
  </action>
  <verify>
Run: `cd /Users/gda/Documents/github/qase-tms/qase-report && npx tsc --noEmit`
Check: No TypeScript errors
Check: File exists with exports: `grep -E "export (class|interface)" src/store/AnalyticsStore.ts`
  </verify>
  <done>
AnalyticsStore.ts exists with:
- TrendDataPoint interface exported
- AnalyticsStore class with passRateTrend, durationTrend computed properties
- hasTrendData computed property for conditional rendering
- All TypeScript compilation passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AnalyticsStore into RootStore</name>
  <files>src/store/index.tsx</files>
  <action>
Update RootStore to include AnalyticsStore:

1. **Add import:**
   ```typescript
   import { AnalyticsStore } from './AnalyticsStore'
   ```

2. **Add property to RootStore class:**
   ```typescript
   analyticsStore: AnalyticsStore
   ```

3. **Initialize in constructor:**
   After historyStore initialization, add:
   ```typescript
   this.analyticsStore = new AnalyticsStore(this)
   ```

Order matters: AnalyticsStore depends on HistoryStore, so historyStore must be created first.
  </action>
  <verify>
Run: `cd /Users/gda/Documents/github/qase-tms/qase-report && npx tsc --noEmit`
Check: analyticsStore property exists: `grep "analyticsStore" src/store/index.tsx`
Check: AnalyticsStore imported: `grep "import.*AnalyticsStore" src/store/index.tsx`
  </verify>
  <done>
RootStore includes analyticsStore property, properly initialized after historyStore. TypeScript compilation passes.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npm run build` succeeds
2. AnalyticsStore exports: AnalyticsStore class, TrendDataPoint interface
3. RootStore integration: analyticsStore accessible via useRootStore()
4. Computed caching: passRateTrend returns same array reference when history unchanged
</verification>

<success_criteria>
- [ ] src/store/AnalyticsStore.ts exists with 80+ lines
- [ ] TrendDataPoint interface matches specified shape
- [ ] passRateTrend computed property returns sorted trend data
- [ ] durationTrend computed property returns same data (both in one dataset)
- [ ] hasTrendData returns true when 2+ runs exist
- [ ] RootStore.analyticsStore properly initialized
- [ ] All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-trend-visualization/09-01-SUMMARY.md`
</output>
