---
phase: 05-step-timeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/formatDuration.ts
  - src/components/TestDetails/TestSteps.tsx
  - src/components/TestDetails/TestStep.tsx
  - src/components/TestDetails/TestStepAttachment.tsx
  - src/components/TestDetails/index.tsx
autonomous: true

must_haves:
  truths:
    - "User can see nested test steps with visual hierarchy"
    - "Each step shows status icon and duration"
    - "Steps with attachments show inline preview or links"
    - "User can expand/collapse nested step groups"
  artifacts:
    - path: "src/utils/formatDuration.ts"
      provides: "Shared duration formatting utility"
      exports: ["formatDuration"]
    - path: "src/components/TestDetails/TestSteps.tsx"
      provides: "Step timeline container"
      exports: ["TestSteps"]
    - path: "src/components/TestDetails/TestStep.tsx"
      provides: "Recursive step component with expand/collapse"
      exports: ["TestStep"]
    - path: "src/components/TestDetails/TestStepAttachment.tsx"
      provides: "Attachment display with image preview"
      exports: ["TestStepAttachment"]
  key_links:
    - from: "src/components/TestDetails/index.tsx"
      to: "TestSteps"
      via: "conditional import and render"
      pattern: "selectedTest\\.steps\\.length > 0"
    - from: "src/components/TestDetails/TestStep.tsx"
      to: "TestStep"
      via: "recursive self-call for nested steps"
      pattern: "step\\.steps\\.map.*TestStep"
    - from: "src/components/TestDetails/TestStep.tsx"
      to: "getStatusIcon"
      via: "import from TestList"
      pattern: "getStatusIcon\\(step\\.execution\\.status\\)"
---

<objective>
Implement step timeline that displays nested test steps with hierarchy, status icons, duration, and inline attachments.

Purpose: Users need to see the execution breakdown of each test - what steps ran, how long they took, whether they passed/failed, and what attachments were generated.

Output: TestSteps component integrated into TestDetails sidebar with recursive step rendering, expand/collapse functionality, and attachment previews.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-step-timeline/05-RESEARCH.md
@src/components/TestDetails/index.tsx
@src/components/TestDetails/TestHeader.tsx
@src/components/TestList/statusIcon.tsx
@src/schemas/Step.schema.ts
@src/schemas/Attachment.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create formatDuration utility and recursive TestStep components</name>
  <files>
    src/utils/formatDuration.ts
    src/components/TestDetails/TestSteps.tsx
    src/components/TestDetails/TestStep.tsx
  </files>
  <action>
1. Create `src/utils/formatDuration.ts`:
   - Export function `formatDuration(ms: number): string`
   - Pattern: `if (ms >= 1000) return \`${(ms / 1000).toFixed(1)}s\` else return \`${ms}ms\``
   - This extracts the duplicated logic from TestHeader.tsx and TestListItem.tsx

2. Create `src/components/TestDetails/TestSteps.tsx`:
   - Import Step type from schemas
   - Accept `steps: Step[]` prop
   - Wrap with Box, section title "Steps" using Typography variant="subtitle1"
   - Map over steps rendering TestStep for each with `depth={0}`
   - Use `step.id` as React key (NOT index)

3. Create `src/components/TestDetails/TestStep.tsx`:
   - Import: observer from mobx-react-lite, useState from react
   - Import: Box, Collapse, IconButton, Typography from MUI
   - Import: ExpandMore, ChevronRight from @mui/icons-material
   - Import: getStatusIcon from '../TestList/statusIcon'
   - Import: formatDuration from '../../utils/formatDuration'
   - Import: Step type from schemas
   - Import: TestStepAttachment (forward reference, created in Task 2)

   Props: `{ step: Step; depth: number }`

   Component logic:
   - `const [isExpanded, setIsExpanded] = useState(true)` - steps start expanded
   - `const hasChildren = step.steps && step.steps.length > 0`
   - `const hasAttachments = step.execution.attachments && step.execution.attachments.length > 0`

   Layout (Box with sx):
   - `ml: Math.min(depth * 3, 24)` - indent by depth, cap at 24 to prevent overflow
   - `py: 0.5` - vertical padding

   Row content (Box with flex display):
   - If hasChildren: IconButton with expand/collapse icon (ExpandMore when expanded, ChevronRight when collapsed)
   - If no children: empty Box with width 28px for alignment
   - getStatusIcon(step.execution.status) - reuse existing utility
   - Typography for step action: `step.data?.action || step.id` (fallback to id if no action)
   - Typography variant="caption" color="text.secondary" for duration: formatDuration(step.execution.duration)

   Below row (Collapse with in={isExpanded}):
   - If hasAttachments: map step.execution.attachments to TestStepAttachment
   - If hasChildren: map step.steps to recursive TestStep with depth={depth + 1}
   - Use attachment.id and child.id as keys respectively

   AVOID:
   - Using array index as key (use step.id)
   - Excessive indentation (cap ml at 24)
   - Missing base case (check steps.length before recursion)
  </action>
  <verify>
    - `npm run build` passes with no TypeScript errors
    - Files exist: src/utils/formatDuration.ts, src/components/TestDetails/TestSteps.tsx, src/components/TestDetails/TestStep.tsx
  </verify>
  <done>
    - formatDuration utility created and exported
    - TestSteps container renders list of top-level steps
    - TestStep recursively renders nested steps with indentation
    - Each step shows status icon and formatted duration
    - Expand/collapse toggle works for steps with children
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TestStepAttachment and integrate TestSteps into TestDetails</name>
  <files>
    src/components/TestDetails/TestStepAttachment.tsx
    src/components/TestDetails/index.tsx
  </files>
  <action>
1. Create `src/components/TestDetails/TestStepAttachment.tsx`:
   - Import: Box, Chip from MUI
   - Import: Image as ImageIcon, InsertDriveFile as FileIcon from @mui/icons-material
   - Import: Attachment type from schemas

   Props: `{ attachment: Attachment }`

   Component logic:
   - `const isImage = attachment.mime_type?.startsWith('image/')`

   Layout:
   - Box with `ml: 4, mt: 0.5` (indent from parent step)
   - Chip with:
     - icon: isImage ? ImageIcon : FileIcon (both with fontSize="small")
     - label: attachment.file_name
     - size="small"
     - variant="outlined"
   - If isImage AND attachment.content exists (base64):
     - Box with mt: 1, maxWidth: 300
     - img tag with src={\`data:${attachment.mime_type};base64,${attachment.content}\`}
     - style: maxWidth: '100%', borderRadius: 4, border: '1px solid #eee'
   - If isImage AND attachment.file_path exists (external file):
     - Box with mt: 1, maxWidth: 300
     - img tag with src={attachment.file_path}
     - style: maxWidth: '100%', borderRadius: 4, border: '1px solid #eee'
     - Add onError handler to hide broken images

2. Update `src/components/TestDetails/index.tsx`:
   - Add import: `import { TestSteps } from './TestSteps'`
   - In the Stack (after TestFields section), add conditional render:
     ```tsx
     {selectedTest.steps && selectedTest.steps.length > 0 && (
       <TestSteps steps={selectedTest.steps} />
     )}
     ```
   - Use explicit `.length > 0` check to avoid rendering "0" (per existing project pattern)

   AVOID:
   - Hardcoding attachment paths (use what's in the data)
   - Missing null checks on attachment.mime_type
   - Breaking existing TestDetails layout
  </action>
  <verify>
    - `npm run build` passes with no TypeScript errors
    - `npm run dev` starts without errors
    - Load a report with steps - step timeline appears in TestDetails sidebar
    - Steps display with status icons, action text, and duration
    - Nested steps show with visual indentation
    - Steps with attachments show file chips
    - Image attachments show inline thumbnail preview (if base64 content available)
    - Expand/collapse toggle works on parent steps
  </verify>
  <done>
    - TestStepAttachment component renders attachment chips with icons
    - Image attachments show inline preview when content/path available
    - TestDetails conditionally renders TestSteps section when test has steps
    - Full step timeline visible in sidebar when viewing test with steps
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Build verification:
   - `npm run build` succeeds with no errors or warnings

2. Functional verification with dev server:
   - `npm run dev`
   - Load a Qase report JSON with test steps
   - Select a test with steps
   - Verify step timeline appears in TestDetails sidebar
   - Verify nested steps show with visual indentation
   - Verify each step shows status icon (passed/failed/etc)
   - Verify each step shows formatted duration
   - Verify expand/collapse works on steps with children
   - Verify attachments display as chips with appropriate icons
   - Verify image attachments show inline preview (if data available)
</verification>

<success_criteria>
- Step timeline displays nested step hierarchy with visual indentation
- Each step shows status icon (reusing getStatusIcon) and formatted duration
- Steps with attachments show inline chips with file type icons
- Image attachments show thumbnail preview when possible
- User can expand/collapse nested step groups
- TestDetails integrates TestSteps section conditionally
- No TypeScript errors, build passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-step-timeline/05-01-SUMMARY.md`
</output>
