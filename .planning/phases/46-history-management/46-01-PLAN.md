---
phase: 46-history-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/history.ts
  - src/cli/commands/open.ts
autonomous: true

must_haves:
  truths:
    - "Opening a test run saves it to history file automatically"
    - "User can specify custom history path with --history option"
    - "Default history saves to ./qase-report-history.json in results folder"
    - "History enforces 30-run limit, removing oldest when exceeded"
  artifacts:
    - path: "src/cli/history.ts"
      provides: "History file management module"
      exports: ["loadHistory", "saveHistory", "addRunToHistory"]
    - path: "src/cli/commands/open.ts"
      provides: "CLI open command with --history option"
      contains: "--history"
  key_links:
    - from: "src/cli/commands/open.ts"
      to: "src/cli/history.ts"
      via: "import and call addRunToHistory"
      pattern: "addRunToHistory"
    - from: "src/cli/history.ts"
      to: "fs"
      via: "readFileSync/writeFileSync"
      pattern: "(readFileSync|writeFileSync)"
---

<objective>
Create history file management for CLI open command with auto-save and custom path support.

Purpose: Enable test run history persistence on server side for analytics features when using CLI.
Output: History manager module and updated open command with --history option.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/cli/commands/open.ts
@src/cli/server.ts
@src/schemas/QaseHistory.schema.ts
@src/schemas/QaseRun.schema.ts
@src/schemas/QaseTestResult.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history file manager module</name>
  <files>src/cli/history.ts</files>
  <action>
Create src/cli/history.ts with Node.js file I/O for history management:

1. **Constants:**
   - MAX_HISTORY_RUNS = 30 (per requirements HIST-04)
   - DEFAULT_HISTORY_FILENAME = 'qase-report-history.json'

2. **Type imports:**
   - Import QaseHistory, HistoricalRun, HistoricalTestRunData from '../schemas/QaseHistory.schema.js'
   - Import QaseRun from '../schemas/QaseRun.schema.js'
   - Import QaseTestResult from '../schemas/QaseTestResult.schema.js'

3. **loadHistory(historyPath: string): QaseHistory | null**
   - Read file with fs.readFileSync
   - Parse JSON and return
   - Return null if file doesn't exist (not an error)
   - Log warning and return null if JSON parse fails (corrupted file)

4. **saveHistory(historyPath: string, history: QaseHistory): void**
   - Write JSON.stringify(history, null, 2) to file
   - Create parent directory if needed (path.dirname + fs.mkdirSync recursive)

5. **addRunToHistory(options: { historyPath: string, run: QaseRun, results: QaseTestResult[] }): void**
   - Load existing history or create new { schema_version: '1.0.0', runs: [], tests: [] }
   - Generate runId from run.execution.start_time (timestamp string) or Date.now()
   - Check for duplicate runId and skip if exists
   - Create HistoricalRun object from run data (see HistoryStore.addCurrentRun for reference)
   - Create/update test entries in history.tests for each result with signature
   - Enforce MAX_HISTORY_RUNS limit: shift oldest runs and clean up orphaned tests
   - Save updated history to file

Use same logic as HistoryStore.addCurrentRun() but adapted for Node.js (no MobX, direct file I/O).

Export all three functions.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit -p tsconfig.cli.json`
  </verify>
  <done>
History manager exports loadHistory, saveHistory, addRunToHistory functions with proper typing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add --history option to open command</name>
  <files>src/cli/commands/open.ts</files>
  <action>
Update src/cli/commands/open.ts to support --history option and auto-save:

1. **Add import:**
   ```typescript
   import { addRunToHistory } from '../history.js'
   import { join } from 'path'
   import { readFileSync, readdirSync, existsSync } from 'fs'
   ```

2. **Add option to command:**
   ```typescript
   .option('-H, --history <path>', 'History file path (default: ./qase-report-history.json in results folder)')
   ```
   Use -H as short flag since -h is reserved for help.

3. **Update options type:**
   ```typescript
   options: { port: string; open: boolean; history?: string }
   ```

4. **After server starts successfully, before opening browser:**
   - Determine historyPath: options.history || join(resolvedPath, 'qase-report-history.json')
   - Read run.json to get run data (already validated at this point)
   - Read all results from results/ directory (same logic as server.ts /api/report)
   - Call addRunToHistory({ historyPath, run, results })
   - Log: `History saved to ${historyPath}`

5. **Handle errors gracefully:**
   - Wrap history save in try/catch
   - Log warning on failure but don't exit (non-critical)
   - Example: `console.warn('Warning: Failed to save history:', error.message)`
  </action>
  <verify>
1. `npx tsc --noEmit -p tsconfig.cli.json` passes
2. `npm run build:cli` succeeds
3. Run `node dist/cli/index.js open --help` shows --history option
  </verify>
  <done>
Open command accepts --history option and auto-saves current run to history file on startup.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors for CLI
2. Build CLI: `npm run build:cli`
3. Test with sample data:
   ```bash
   # Create test results directory
   mkdir -p /tmp/test-results/results
   echo '{"execution":{"start_time":1707750000000,"end_time":1707750060000,"duration":60000,"cumulative_duration":60000},"stats":{"total":2,"passed":1,"failed":1,"skipped":0},"results":[],"threads":["main"],"suites":["Suite A"],"host_data":{"node":"20.0.0","system":"Darwin","release":"24.0.0","version":"Darwin Kernel","machine":"arm64"}}' > /tmp/test-results/run.json

   # Run open command (Ctrl+C after verifying)
   node dist/cli/index.js open /tmp/test-results

   # Verify history file created
   cat /tmp/test-results/qase-report-history.json
   ```
4. Verify custom path works: `node dist/cli/index.js open /tmp/test-results --history /tmp/custom-history.json`
</verification>

<success_criteria>
- History file created automatically at default location when running `open` command
- Custom history path works with `--history /path/to/file.json`
- History contains valid QaseHistory structure with runs and tests arrays
- Duplicate runs are not added (idempotent)
- Oldest runs removed when exceeding 30-run limit
</success_criteria>

<output>
After completion, create `.planning/phases/46-history-management/46-01-SUMMARY.md`
</output>
