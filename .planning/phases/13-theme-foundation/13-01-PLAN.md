---
phase: 13-theme-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/theme/index.ts
  - src/theme/ThemeRegistry.tsx
  - src/components/ThemeToggle/index.tsx
  - src/App.tsx
  - index.html
autonomous: false

must_haves:
  truths:
    - "User can switch between Light, Dark, and System theme modes via UI control"
    - "Theme preference persists across browser sessions (survives refresh/close)"
    - "No flash of wrong theme on page load (FOWT prevention)"
    - "System mode follows OS preference and updates when OS setting changes"
  artifacts:
    - path: "src/theme/index.ts"
      provides: "MUI theme configuration with colorSchemes API"
      contains: "colorSchemes"
    - path: "src/theme/ThemeRegistry.tsx"
      provides: "ThemeProvider wrapper with CssBaseline"
      exports: ["ThemeRegistry"]
    - path: "src/components/ThemeToggle/index.tsx"
      provides: "Three-way theme toggle component (light/dark/system)"
      exports: ["ThemeToggle"]
    - path: "index.html"
      provides: "FOWT prevention inline script"
      contains: "data-mui-color-scheme"
  key_links:
    - from: "src/App.tsx"
      to: "src/theme/ThemeRegistry.tsx"
      via: "ThemeRegistry wraps app content"
      pattern: "ThemeRegistry"
    - from: "src/App.tsx"
      to: "src/components/ThemeToggle/index.tsx"
      via: "ThemeToggle in AppBar"
      pattern: "ThemeToggle"
    - from: "src/theme/ThemeRegistry.tsx"
      to: "src/theme/index.ts"
      via: "imports theme configuration"
      pattern: "import.*theme.*from"
    - from: "src/components/ThemeToggle/index.tsx"
      to: "@mui/material/styles"
      via: "useColorScheme hook"
      pattern: "useColorScheme"
---

<objective>
Implement MUI colorSchemes-based theme system with light/dark/system modes, localStorage persistence, and FOWT prevention.

Purpose: Enable users to customize their viewing experience and have the application respect their OS preference. Foundation for v1.2 design refresh.
Output: Working theme toggle in AppBar with automatic persistence and no flash on page load.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-theme-foundation/13-RESEARCH.md
@src/App.tsx
@index.html
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme configuration and ThemeRegistry wrapper</name>
  <files>
    src/theme/index.ts
    src/theme/ThemeRegistry.tsx
  </files>
  <action>
Create `src/theme/` directory with two files:

**src/theme/index.ts:**
- Import `createTheme` from `@mui/material/styles`
- Configure theme with `cssVariables: { colorSchemeSelector: 'data' }`
- Enable `colorSchemes: { light: true, dark: true }`
- Set `defaultMode: 'system'` (per research recommendation for three-way toggle)
- Export named `theme` constant

**src/theme/ThemeRegistry.tsx:**
- Create functional component with `PropsWithChildren` type
- Import `ThemeProvider` from `@mui/material/styles`
- Import `CssBaseline` from `@mui/material/CssBaseline`
- Import `theme` from `./index`
- Wrap children in `ThemeProvider` with `CssBaseline` inside
- Export named `ThemeRegistry` component

**Follow project conventions:**
- No semicolons (per .prettierrc.json)
- Single quotes
- Named exports
  </action>
  <verify>
Files exist and TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- `src/theme/index.ts` exports theme with colorSchemes configuration
- `src/theme/ThemeRegistry.tsx` exports ThemeRegistry component
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ThemeToggle component with three-way menu</name>
  <files>
    src/components/ThemeToggle/index.tsx
  </files>
  <action>
Create `src/components/ThemeToggle/index.tsx`:

- Import `useColorScheme` from `@mui/material/styles`
- Import `IconButton`, `Menu`, `MenuItem`, `ListItemIcon`, `ListItemText` from `@mui/material`
- Import icons: `Brightness4` (dark), `Brightness7` (light), `BrightnessAuto` (system) from `@mui/icons-material`
- Use `useState` for Menu anchor element

**Component logic:**
1. Get `mode` and `setMode` from `useColorScheme()`
2. Guard clause: `if (!mode) return null` (SSR safety per research)
3. Render IconButton that shows current mode icon:
   - 'light' -> Brightness7Icon
   - 'dark' -> Brightness4Icon
   - 'system' -> BrightnessAutoIcon
4. Render Menu with three MenuItem options:
   - "Light" with Brightness7Icon
   - "Dark" with Brightness4Icon
   - "System" with BrightnessAutoIcon
5. Each MenuItem calls `setMode()` with appropriate value and closes menu
6. Add `aria-label="theme settings"` to IconButton for accessibility

**Props:** No props needed - component reads from MUI theme context

Export named `ThemeToggle` component.
  </action>
  <verify>
File exists and TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- `src/components/ThemeToggle/index.tsx` exports ThemeToggle component
- Component uses useColorScheme hook for state management
- Three-way toggle supports light/dark/system modes
- TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate theme system and add FOWT prevention</name>
  <files>
    src/App.tsx
    index.html
  </files>
  <action>
**Update src/App.tsx:**
1. Remove `createTheme` import and inline theme creation
2. Import `ThemeRegistry` from `./theme/ThemeRegistry`
3. Import `ThemeToggle` from `./components/ThemeToggle`
4. Import `Box` from `@mui/material` for AppBar layout
5. Wrap entire app content with `<ThemeRegistry>` instead of `<ThemeProvider>`
6. In Toolbar, add flex layout:
   - Box with `flexGrow: 1` for "Qase | Report" title
   - ThemeToggle component on the right
7. Remove the `theme` variable (no longer needed - theme comes from ThemeRegistry)

**Update index.html:**
Add inline script in `<head>` BEFORE any other scripts for FOWT prevention:
```html
<script>
  (function() {
    var key = 'mui-mode'
    var savedMode = localStorage.getItem(key)
    var systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches
    var mode = savedMode || 'system'
    if (mode === 'system') {
      mode = systemDark ? 'dark' : 'light'
    }
    document.documentElement.setAttribute('data-mui-color-scheme', mode)
  })()
</script>
```

This script:
- Runs before React mounts
- Reads saved preference from localStorage (key: 'mui-mode' matches MUI default)
- Falls back to system preference
- Sets data attribute that MUI CSS variables will use
  </action>
  <verify>
Start dev server and test in browser:
```bash
npm run dev
```
Then verify:
1. Theme toggle appears in AppBar
2. Clicking opens menu with Light/Dark/System options
3. Selecting Dark mode changes UI colors
4. Refresh page - dark mode persists (no flash)
5. Select System and verify it follows OS preference
  </verify>
  <done>
- App.tsx uses ThemeRegistry wrapper
- ThemeToggle visible in AppBar
- Theme switching works via menu
- Dev server runs without errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify theme system functionality</name>
  <what-built>
Complete theme system with light/dark/system modes, persistence, and FOWT prevention
  </what-built>
  <how-to-verify>
1. Open http://localhost:5173 in browser
2. **Test theme switching:**
   - Click theme icon in AppBar (right side)
   - Select "Dark" - verify UI changes to dark colors
   - Select "Light" - verify UI changes to light colors
   - Select "System" - verify it follows your OS preference

3. **Test persistence:**
   - Set theme to "Dark"
   - Refresh page (F5)
   - Verify page loads in dark mode WITHOUT flash of light theme

4. **Test FOWT prevention:**
   - Open DevTools > Network tab
   - Set to "Slow 3G" throttling
   - Refresh with dark mode selected
   - Verify NO white flash before dark theme appears

5. **Test system mode live update:**
   - Select "System" mode
   - Change your OS dark mode setting
   - Verify app theme updates automatically (without refresh)

6. **Test cross-tab sync (bonus):**
   - Open app in two browser tabs
   - Change theme in one tab
   - Verify other tab updates automatically
  </how-to-verify>
  <resume-signal>Type "approved" if all checks pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
**Requirements Coverage:**
- THEME-01: Three-way toggle in ThemeToggle component (light/dark/system)
- THEME-02: MUI colorSchemes handles localStorage persistence automatically
- THEME-03: Inline script in index.html prevents FOWT

**Technical Verification:**
```bash
# TypeScript compiles
npx tsc --noEmit

# Build succeeds
npm run build

# localStorage key exists after interaction
# Open DevTools > Application > Local Storage > look for 'mui-mode'
```
</verification>

<success_criteria>
1. Theme toggle visible in AppBar with three options (Light, Dark, System)
2. Selecting Dark mode changes all MUI component colors to dark palette
3. Selecting Light mode changes all MUI component colors to light palette
4. Selecting System mode follows OS preference
5. Theme persists across page refresh (no flash)
6. Theme persists after closing and reopening browser
7. System mode updates when OS preference changes
8. Build completes successfully with no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-theme-foundation/13-01-SUMMARY.md`
</output>
