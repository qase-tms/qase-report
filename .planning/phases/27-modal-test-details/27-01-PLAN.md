---
phase: 27-modal-test-details
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/index.css
  - src/components/TestDetailsModal/index.tsx
  - src/layout/MainLayout/index.tsx
autonomous: true

must_haves:
  truths:
    - "User clicks test in list and details open in centered modal dialog"
    - "User presses Escape key or clicks outside modal to close it"
    - "User can scroll long test content within modal without issues"
    - "User does not see layout shift or AppBar movement when modal opens"
    - "User can scroll test list with modal open (virtual scrolling still works)"
  artifacts:
    - path: "src/index.css"
      provides: "Scrollbar gutter compensation for layout shift prevention"
      contains: "scrollbar-gutter"
    - path: "src/components/TestDetailsModal/index.tsx"
      provides: "Modal dialog wrapper for test details"
      exports: ["TestDetailsModal"]
      min_lines: 25
    - path: "src/layout/MainLayout/index.tsx"
      provides: "Layout with Dialog replacing Sidebar for test details"
      contains: "TestDetailsModal"
  key_links:
    - from: "src/layout/MainLayout/index.tsx"
      to: "src/components/TestDetailsModal/index.tsx"
      via: "import and render"
      pattern: "import.*TestDetailsModal"
    - from: "src/components/TestDetailsModal/index.tsx"
      to: "src/store/index.tsx"
      via: "useRootStore for selectedTest and clearSelection"
      pattern: "useRootStore.*selectedTest"
---

<objective>
Replace Drawer-based test details panel with centered modal Dialog that meets all DET and LAY requirements.

Purpose: Modal dialogs are standard UX for viewing details without leaving context. Prevents layout shift and works better across device sizes than the current right-anchored Drawer.

Output: TestDetailsModal component with Dialog, MainLayout updated to use it, CSS for scrollbar compensation.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/27-modal-test-details/27-RESEARCH.md

# Existing patterns to follow
@src/components/SearchModal/index.tsx
@src/components/TestDetails/index.tsx
@src/components/Sidebar/index.tsx
@src/layout/MainLayout/index.tsx
@src/store/index.tsx
@src/index.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add scrollbar gutter CSS and create TestDetailsModal component</name>
  <files>
    src/index.css
    src/components/TestDetailsModal/index.tsx
  </files>
  <action>
**1. Update src/index.css:**
Add scrollbar-gutter: stable to html selector to prevent layout shift when modal opens/closes (LAY-03). This is CSS Baseline 2024 - widely supported.

```css
html {
  background-color: var(--mui-palette-background-default);
  overflow-y: auto;
  scrollbar-gutter: stable;
}
```

**2. Create src/components/TestDetailsModal/index.tsx:**
Create new component following SearchModal pattern. Key aspects:
- Use `observer` from mobx-react-lite
- Get `selectedTest` and `clearSelection` from `useRootStore()`
- Dialog open state: `open={!!selectedTest}` (no separate isDockOpen needed)
- Dialog onClose: `onClose={clearSelection}`
- Props: `maxWidth="md"`, `fullWidth`, `scroll="paper"` for scrollable content
- Add `aria-labelledby="test-details-title"` for accessibility
- DialogTitle with test name (from selectedTest.title) and close button
- DialogContent with `dividers` prop, render TestDetails inside
- NO DialogActions needed - TestDetails has its own close button which will also work

Key difference from SearchModal: TestDetailsModal is controlled by store state, not props. Dialog renders when selectedTest is truthy.

**Focus trap note:** Start with default Dialog behavior. If VirtualizedTestList scroll is blocked during testing, add `disableEnforceFocus={true}` prop. Research suggests this is unlikely to be needed.

**Padding adjustment:** TestDetails has `p: 2` wrapper. DialogContent also has padding. Either:
- Pass `sx={{ p: 0 }}` to DialogContent and keep TestDetails padding, OR
- Remove TestDetails outer padding when rendered in modal

Recommend: Keep TestDetails padding, set DialogContent `sx={{ p: 0 }}` to avoid double padding.
  </action>
  <verify>
- File src/index.css contains `scrollbar-gutter: stable`
- File src/components/TestDetailsModal/index.tsx exists and exports TestDetailsModal
- Component imports Dialog, DialogTitle, DialogContent from @mui/material
- Component uses useRootStore for selectedTest and clearSelection
- Component has scroll="paper" and fullWidth maxWidth="md"
  </verify>
  <done>
TestDetailsModal component created following SearchModal pattern, CSS scrollbar compensation in place.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace Sidebar with TestDetailsModal in MainLayout</name>
  <files>
    src/layout/MainLayout/index.tsx
  </files>
  <action>
**Update src/layout/MainLayout/index.tsx:**

1. **Remove Sidebar import and usage:**
   - Remove: `import { Sidebar } from '../../components/Sidebar'`
   - Remove: `const { isDockOpen, closeDock, ... } = useRootStore()` (isDockOpen and closeDock no longer needed)
   - Remove: `<Sidebar isOpen={isDockOpen} onClose={closeDock}><TestDetails /></Sidebar>`

2. **Add TestDetailsModal:**
   - Add: `import { TestDetailsModal } from '../../components/TestDetailsModal'`
   - Remove: `import { TestDetails } from '../../components/TestDetails'` (now imported by TestDetailsModal)
   - Add `<TestDetailsModal />` after the Grid container, before AttachmentViewer

**Resulting structure:**
```tsx
return (
  <>
    <Grid container ...>
      {/* main content */}
    </Grid>
    <TestDetailsModal />
    <AttachmentViewer />
  </>
)
```

Note: The Sidebar component itself (src/components/Sidebar/index.tsx) remains in codebase - it may be removed in Phase 28 (Layout Simplification). This task only removes its usage in MainLayout.

**Keep destructured from useRootStore:**
- `reportStore` - still needed for renderView
- `activeView` - still needed for renderView

**Remove from destructuring:**
- `isDockOpen` - no longer used
- `closeDock` - no longer used
  </action>
  <verify>
- MainLayout no longer imports Sidebar
- MainLayout no longer references isDockOpen or closeDock
- MainLayout imports and renders TestDetailsModal
- Application builds without errors: `npm run build`
- Dev server starts: `npm run dev`
  </verify>
  <done>
MainLayout uses Dialog-based TestDetailsModal instead of Drawer-based Sidebar for test details.
  </done>
</task>

</tasks>

<verification>
**Functional verification (all requirements):**

1. **DET-01 (Modal dialog):** Click any test in list - details should open in centered modal, not slide-in drawer
2. **DET-02 (Close methods):** Press Escape - modal closes. Click outside modal (backdrop) - modal closes
3. **DET-03 (Scroll long content):** Open test with many steps or long stacktrace - content should scroll within modal
4. **LAY-03 (No layout shift):** Open/close modal repeatedly - AppBar and content should not shift horizontally
5. **Virtual scrolling (Success Criteria 5):** With modal open, scroll test list in background - should still work

**Commands:**
```bash
npm run build  # Should complete without errors
npm run dev    # Start dev server for manual testing
```

**Manual test sequence:**
1. Load report with test results
2. Click test in list - verify modal opens (centered, not right-anchored)
3. Press Escape - verify modal closes
4. Click test again - verify modal opens
5. Click backdrop (outside modal) - verify modal closes
6. Find test with long content - verify scrolling works inside modal
7. Watch AppBar during open/close - verify no horizontal shift
8. With modal open, try scrolling test list - verify virtual scroll still works
</verification>

<success_criteria>
- TestDetailsModal component exists and follows MUI Dialog pattern
- Modal opens when clicking test, closes on Escape/backdrop click
- Long content scrolls within modal (scroll="paper" working)
- No layout shift when modal opens (scrollbar-gutter working)
- Virtual scrolling in test list works with modal open
- Build passes, no TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-modal-test-details/27-01-SUMMARY.md`
</output>
