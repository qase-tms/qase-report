---
phase: 11-regression-alerts
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - src/components/Dashboard/AlertsPanel.tsx
  - src/components/Dashboard/index.tsx
autonomous: false

must_haves:
  truths:
    - "User sees alerts panel on dashboard with flakiness and regression warnings"
    - "User can click alert to navigate directly to affected test"
    - "Alerts distinguish between flakiness warnings (orange) and regression errors (red)"
  artifacts:
    - path: "src/components/Dashboard/AlertsPanel.tsx"
      provides: "Clickable alerts list component"
      exports: ["AlertsPanel"]
    - path: "src/components/Dashboard/index.tsx"
      provides: "Dashboard with integrated AlertsPanel"
      contains: "AlertsPanel"
  key_links:
    - from: "src/components/Dashboard/AlertsPanel.tsx"
      to: "src/store/AnalyticsStore.ts"
      via: "useRootStore for alerts access"
      pattern: "analyticsStore\\.alerts"
    - from: "src/components/Dashboard/AlertsPanel.tsx"
      to: "parent navigation callback"
      via: "onAlertClick prop for test selection"
      pattern: "onAlertClick\\(.*testSignature"
---

<objective>
Create AlertsPanel component for dashboard with clickable alerts that navigate to affected tests.

Purpose: Provide users immediate visibility into flakiness warnings and regression errors with one-click navigation.
Output: AlertsPanel component + Dashboard integration with click-to-navigate functionality
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-regression-alerts/11-01-SUMMARY.md

@src/types/alerts.ts
@src/store/AnalyticsStore.ts
@src/components/Dashboard/index.tsx
@src/components/TestList/StabilityBadge.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AlertsPanel component</name>
  <files>src/components/Dashboard/AlertsPanel.tsx</files>
  <action>
Create AlertsPanel component with clickable alert items:

```typescript
import { observer } from 'mobx-react-lite'
import {
  Card,
  CardHeader,
  CardContent,
  List,
  ListItem,
  ListItemButton,
  ListItemIcon,
  ListItemText,
  Chip,
  Typography,
  Box,
} from '@mui/material'
import WarningAmberIcon from '@mui/icons-material/WarningAmber'
import SpeedIcon from '@mui/icons-material/Speed'
import LoopIcon from '@mui/icons-material/Loop'
import NewReleasesIcon from '@mui/icons-material/NewReleases'
import { useRootStore } from '../../store'
import type { AlertItem, AlertType } from '../../types/alerts'

interface AlertsPanelProps {
  /** Callback when alert is clicked - receives test signature for navigation */
  onAlertClick: (testSignature: string) => void
}

/**
 * Returns icon component based on alert type
 */
const getAlertIcon = (type: AlertType) => {
  switch (type) {
    case 'performance_regression':
      return <SpeedIcon color="error" />
    case 'flaky_warning':
      return <LoopIcon color="warning" />
    case 'new_failure':
      return <NewReleasesIcon color="error" />
  }
}

/**
 * Returns badge label based on alert type
 */
const getAlertBadge = (type: AlertType) => {
  switch (type) {
    case 'performance_regression':
      return { label: 'Regression', color: 'error' as const }
    case 'flaky_warning':
      return { label: 'Flaky', color: 'warning' as const }
    case 'new_failure':
      return { label: 'New Failure', color: 'error' as const }
  }
}

export const AlertsPanel = observer(({ onAlertClick }: AlertsPanelProps) => {
  const { analyticsStore } = useRootStore()
  const { alerts } = analyticsStore

  // Don't render panel if no alerts
  if (alerts.length === 0) {
    return null
  }

  return (
    <Card>
      <CardHeader
        title={
          <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
            <WarningAmberIcon color="warning" />
            <Typography variant="h6">Alerts</Typography>
            <Chip
              label={alerts.length}
              size="small"
              color={alerts.some(a => a.severity === 'error') ? 'error' : 'warning'}
            />
          </Box>
        }
        sx={{ pb: 0 }}
      />
      <CardContent sx={{ pt: 1 }}>
        <List dense disablePadding>
          {alerts.slice(0, 10).map((alert) => {
            const badge = getAlertBadge(alert.type)
            return (
              <ListItem key={alert.id} disablePadding>
                <ListItemButton
                  onClick={() => onAlertClick(alert.testSignature)}
                  sx={{ borderRadius: 1 }}
                >
                  <ListItemIcon sx={{ minWidth: 36 }}>
                    {getAlertIcon(alert.type)}
                  </ListItemIcon>
                  <ListItemText
                    primary={
                      <Box sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                        <Typography
                          variant="body2"
                          sx={{
                            overflow: 'hidden',
                            textOverflow: 'ellipsis',
                            whiteSpace: 'nowrap',
                            maxWidth: 200,
                          }}
                        >
                          {alert.testTitle}
                        </Typography>
                        <Chip
                          label={badge.label}
                          color={badge.color}
                          size="small"
                          sx={{ height: 18, fontSize: '0.7rem' }}
                        />
                      </Box>
                    }
                    secondary={alert.message}
                    secondaryTypographyProps={{
                      variant: 'caption',
                      sx: { color: 'text.secondary' },
                    }}
                  />
                </ListItemButton>
              </ListItem>
            )
          })}
        </List>
        {alerts.length > 10 && (
          <Typography variant="caption" color="text.secondary" sx={{ mt: 1, display: 'block' }}>
            +{alerts.length - 10} more alerts
          </Typography>
        )}
      </CardContent>
    </Card>
  )
})
```

Component features:
- Displays up to 10 alerts (most severe first)
- Color-coded icons: red for errors, orange for warnings
- Clickable items call onAlertClick(testSignature)
- Compact badge shows alert type
- Message shows details (percentage, duration stats)
- Count badge shows total alerts
- Null return when no alerts (clean dashboard)
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>AlertsPanel component renders clickable alerts with type-specific icons and colors</done>
</task>

<task type="auto">
  <name>Task 2: Integrate AlertsPanel into Dashboard</name>
  <files>src/components/Dashboard/index.tsx</files>
  <action>
Update Dashboard to include AlertsPanel with navigation callback:

1. Import AlertsPanel:
```typescript
import { AlertsPanel } from './AlertsPanel'
```

2. Update observer component to include testResultsStore for navigation:
```typescript
const { reportStore, analyticsStore, historyStore, testResultsStore } = useRootStore()
```

3. Add alert click handler that:
   - Finds test ID by signature
   - Sets selected test (if testResultsStore has setSelectedTest method)
   - Or dispatches to existing selection mechanism

```typescript
// Handle alert click - find test by signature and select it
const handleAlertClick = (testSignature: string) => {
  // Find test with matching signature in current results
  for (const [id, test] of testResultsStore.results) {
    if (test.signature === testSignature) {
      testResultsStore.setSelectedTestId(id)
      return
    }
  }
}
```

4. Add AlertsPanel to layout, positioned prominently before trends:
```typescript
{/* Alerts panel - show when alerts exist */}
{analyticsStore.hasAlerts && (
  <Box sx={{ mt: 3 }}>
    <AlertsPanel onAlertClick={handleAlertClick} />
  </Box>
)}
```

Insert AFTER the stats cards grid but BEFORE the trend visualization section.

Full structure:
- Stats cards (4 columns)
- Metadata cards (2 columns)
- **AlertsPanel** (new - full width)
- Trend visualization (TrendsChart + HistoryTimeline)
  </action>
  <verify>npx tsc --noEmit</verify>
  <done>Dashboard renders AlertsPanel with functional click-to-navigate</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify AlertsPanel UI and navigation</name>
  <files>n/a</files>
  <action>
Human verification of AlertsPanel displaying flakiness warnings, performance regressions, and new failure alerts with click-to-navigate functionality.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:5173
3. Load a Qase report that has test-history.json with 5+ runs for some tests
4. Verify AlertsPanel appears on dashboard with:
   - Orange chip + Loop icon for flaky warnings
   - Red chip + Speed icon for regression alerts
   - Red chip + NewReleases icon for new failures
5. Click on an alert - should select the test in test list
6. Verify alerts are sorted (errors first, then warnings)

If no test-history.json with sufficient runs available:
- Load report multiple times (addCurrentRun accumulates history)
- Or verify AlertsPanel does not render (correct behavior for no alerts)
  </verify>
  <done>User confirms AlertsPanel displays correctly with working navigation to affected tests</done>
</task>

</tasks>

<verification>
```bash
# TypeScript compilation
npx tsc --noEmit

# Verify component exports
grep -q "export.*AlertsPanel" src/components/Dashboard/AlertsPanel.tsx && echo "AlertsPanel exported"

# Verify Dashboard integration
grep -q "AlertsPanel" src/components/Dashboard/index.tsx && echo "AlertsPanel imported in Dashboard"
grep -q "handleAlertClick" src/components/Dashboard/index.tsx && echo "Click handler exists"
```
</verification>

<success_criteria>
- AlertsPanel component displays alerts with type-specific icons and colors
- Clicking alert navigates to affected test in test list
- Alerts sorted by severity (errors before warnings)
- Dashboard shows AlertsPanel only when alerts exist
- Human verification confirms navigation works
</success_criteria>

<output>
After completion, create `.planning/phases/11-regression-alerts/11-02-SUMMARY.md`
</output>
