---
phase: 08-history-infrastructure
plan: 03
type: execute
wave: 3
depends_on: [08-02]
files_modified:
  - src/services/FileLoaderService.ts
  - src/components/FileUploader.tsx
  - src/store/index.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can select and load test-history.json file"
    - "User sees confirmation when history file loads successfully"
    - "User sees error message if history file is invalid"
    - "User can load history file alongside report in single directory selection"
  artifacts:
    - path: "src/services/FileLoaderService.ts"
      provides: "History file detection and loading"
      contains: "historyFile"
    - path: "src/components/FileUploader.tsx"
      provides: "UI for history file upload"
      contains: "test-history.json"
    - path: "src/store/index.tsx"
      provides: "History file loading integration"
      contains: "loadHistoryFile"
  key_links:
    - from: "src/components/FileUploader.tsx"
      to: "src/store/index.tsx"
      via: "file upload handler"
      pattern: "loadReport|loadHistoryFile"
    - from: "src/store/index.tsx"
      to: "src/store/HistoryStore.ts"
      via: "loadHistoryFile call"
      pattern: "historyStore\\.loadHistoryFile"
    - from: "src/services/FileLoaderService.ts"
      to: "File detection"
      via: "webkitRelativePath filtering"
      pattern: "test-history\\.json"
---

<objective>
Enable users to load test-history.json files via UI.

Purpose: Complete history infrastructure foundation. Users need simple way to load history files (single file or directory with run.json + test-history.json). Graceful error handling for invalid files prevents user confusion.

Output: Working file upload UI with history file detection and validation feedback.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/phases/08-history-infrastructure/08-01-SUMMARY.md
@.planning/phases/08-history-infrastructure/08-02-SUMMARY.md
@src/services/FileLoaderService.ts
@src/store/index.tsx
</context>

<tasks>

<task type="auto">
  <name>Update FileLoaderService to detect history files</name>
  <files>src/services/FileLoaderService.ts</files>
  <action>
    Update loadReportDirectory method to detect and return test-history.json file.

    Changes to return type:
    ```typescript
    async loadReportDirectory(files: FileList): Promise<{
      runFile: File | null
      historyFile: File | null  // NEW
      resultFiles: File[]
      attachmentFiles: File[]
    }>
    ```

    Add history file detection after runFile:
    ```typescript
    const historyFile = fileArray.find(
      (f) => f.webkitRelativePath.endsWith('test-history.json')
    ) || null
    ```

    Update return statement to include historyFile.

    Do NOT change:
    - runFile detection logic
    - resultFiles filtering
    - attachmentFiles filtering
    - readAsText method
  </action>
  <verify>
    TypeScript compiles: npm run build

    Return type includes historyFile:
    grep -q "historyFile: File | null" src/services/FileLoaderService.ts
  </verify>
  <done>
    - loadReportDirectory returns historyFile in result object
    - historyFile detection looks for test-history.json in directory
    - TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Update RootStore to load history files</name>
  <files>src/store/index.tsx</files>
  <action>
    Update loadReport method to detect and load history files from directory uploads.

    Changes to loadReport method:

    1. **Update destructuring** to include historyFile:
       ```typescript
       const { runFile, historyFile, resultFiles, attachmentFiles } =
         await fileLoader.loadReportDirectory(files)
       ```

    2. **Load history file if present** (after loading run.json, before loading results):
       ```typescript
       // Load history file if present
       if (historyFile) {
         try {
           await this.historyStore.loadHistoryFile(historyFile)
         } catch (error) {
           console.error('Failed to load history file:', error)
           // Continue loading report even if history fails
         }
       }
       ```

    3. **Move addCurrentRun call** to after all loading completes (replace existing addCurrentRun call from plan 08-02):
       ```typescript
       // After attachments loop, before method end
       if (this.historyStore.isHistoryLoaded) {
         this.historyStore.addCurrentRun(
           this.reportStore.run!,
           this.testResultsStore.testResults
         )
       }
       ```

    Keep existing error handling for runFile.

    Do NOT change:
    - Other store loading logic
    - Error handling for missing run.json
    - Attachment registration loop
  </action>
  <verify>
    TypeScript compiles: npm run build

    loadReport handles history files:
    grep -q "historyFile" src/store/index.tsx
    grep -q "loadHistoryFile" src/store/index.tsx
  </verify>
  <done>
    - loadReport extracts historyFile from fileLoader result
    - loadReport calls historyStore.loadHistoryFile if historyFile exists
    - History loading errors caught and logged (don't break report loading)
    - addCurrentRun called after all loading completes
    - TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Create FileUploader component for history files</name>
  <files>src/components/FileUploader.tsx</files>
  <action>
    Create new component for file upload UI (directory or single file) following MUI patterns from existing components.

    Component structure:

    1. **Imports:**
       - React: useState from react
       - MobX: observer from mobx-react-lite
       - MUI: Box, Button, Typography, Alert from @mui/material
       - Store: useRootStore hook

    2. **Component:**
       - Name: FileUploader (observer-wrapped)
       - Accept: directory (for run.json + test-history.json) or single file (test-history.json only)

    3. **UI Layout:**
       - Box container with padding
       - Typography heading: "Load Qase Report"
       - Button for directory upload (primary variant)
         - Text: "Select Report Directory"
         - input type="file" webkitdirectory attribute
         - onChange handler calls store.loadReport
       - Typography with margin-top: "Or load history file separately:"
       - Button for single file upload (outlined variant)
         - Text: "Select test-history.json"
         - input type="file" accept=".json"
         - onChange handler calls store.historyStore.loadHistoryFile
       - Alert showing success/error messages (conditional rendering):
         - Show green success Alert if store.historyStore.isHistoryLoaded
         - Show red error Alert if store.historyStore.historyError
         - Show info Alert if store.reportStore.run exists (report loaded)

    4. **File handling:**
       - Directory handler: e.target.files → store.loadReport(files)
       - Single file handler: e.target.files[0] → store.historyStore.loadHistoryFile(file)
       - Catch errors and display in Alert

    Follow codebase conventions:
    - Functional component with observer wrapper
    - Use MUI sx prop for inline styling (margin, padding)
    - Hidden file input with label/button pattern
    - JSDoc comment for component purpose
  </action>
  <verify>
    TypeScript compiles: npm run build

    Component exports:
    grep -q "export const FileUploader" src/components/FileUploader.tsx
  </verify>
  <done>
    - FileUploader.tsx component created
    - Component has directory upload button
    - Component has single file upload button for test-history.json
    - Component shows success/error alerts
    - Component uses observer pattern to react to store changes
    - TypeScript compilation succeeds
  </done>
</task>

<task type="checkpoint:human-verify">
  <name>Verify history file loading flow</name>
  <action>Manual verification of complete history loading infrastructure</action>
  <what-built>
    History file loading infrastructure with UI:
    - FileLoaderService detects test-history.json in directories
    - RootStore loads history files during report loading
    - FileUploader component provides UI for directory and single file uploads
    - HistoryStore validates and persists history data to localStorage
  </what-built>
  <how-to-verify>
    Test history file loading:

    1. Start dev server: npm run dev
    2. Open browser to http://localhost:5173
    3. Locate FileUploader component on main page

    **Test directory upload with history:**
    4. Create test directory with:
       - run.json (from existing test data)
       - test-history.json with sample data:
         ```json
         {
           "schema_version": "1.0.0",
           "runs": [
             {
               "run_id": "run-001",
               "title": "Test Run 1",
               "environment": "staging",
               "start_time": 1704672000000,
               "end_time": 1704672300000,
               "duration": 300000,
               "stats": {
                 "total": 10,
                 "passed": 8,
                 "failed": 2,
                 "skipped": 0
               }
             }
           ],
           "tests": [
             {
               "signature": "test-auth-login",
               "title": "User can log in",
               "runs": [
                 {
                   "run_id": "run-001",
                   "status": "passed",
                   "duration": 1500,
                   "start_time": 1704672010000,
                   "error_message": null
                 }
               ]
             }
           ]
         }
         ```
       - results/ directory with test result JSON files
    5. Click "Select Report Directory" and choose test directory
    6. Verify green success Alert shows "History loaded" or similar
    7. Open browser DevTools → Console
    8. Type: useRootStore().historyStore.totalRuns
    9. Verify result is 1 (from test-history.json)
    10. Type: useRootStore().historyStore.recentRuns
    11. Verify returns array with run-001 data

    **Test single file upload:**
    12. Click "Select test-history.json" button
    13. Choose test-history.json file directly
    14. Verify success Alert shows
    15. Check console: useRootStore().historyStore.isHistoryLoaded
    16. Verify returns true

    **Test localStorage persistence:**
    17. Refresh page (Cmd+R / Ctrl+R)
    18. Check console: useRootStore().historyStore.totalRuns
    19. Verify history persisted (still returns 1)

    **Test invalid file:**
    20. Create invalid-history.json with: {"invalid": "data"}
    21. Click "Select test-history.json" and choose invalid file
    22. Verify red error Alert shows validation error

    **Expected outcomes:**
    - Directory upload loads both run.json and test-history.json
    - Single file upload loads test-history.json only
    - Success alerts display after successful load
    - History data persists across page refreshes
    - Invalid files show error messages (not crashes)
    - Console access to historyStore works
  </how-to-verify>
  <resume-signal>Type "approved" if all tests pass, or describe issues</resume-signal>
</task>

</tasks>

<verification>
Complete file upload flow works:
1. User can select directory with run.json + test-history.json
2. User can select single test-history.json file
3. Valid history files load successfully with confirmation
4. Invalid history files show error messages
5. History data persists to localStorage
6. Page refresh restores history data
</verification>

<success_criteria>
- FileLoaderService detects test-history.json in directories
- RootStore loads history files during report loading
- FileUploader component provides directory and single file upload UI
- Success/error alerts display based on load results
- History data persists across page refreshes
- Invalid files handled gracefully with error messages
- All requirements HIST-01, HIST-02, HIST-03, HIST-04 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/08-history-infrastructure/08-03-SUMMARY.md`
</output>
