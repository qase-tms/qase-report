---
phase: 08-history-infrastructure
plan: 02
type: execute
wave: 2
depends_on: [08-01]
files_modified:
  - src/store/HistoryStore.ts
  - src/store/index.tsx
autonomous: true

must_haves:
  truths:
    - "System loads history data without memory crashes"
    - "System tracks tests by signature across multiple runs"
    - "System stores history in localStorage without browser crashes"
    - "System handles 100+ historical runs efficiently"
  artifacts:
    - path: "src/store/HistoryStore.ts"
      provides: "History data management with tiered loading"
      exports: ["HistoryStore"]
      min_lines: 120
    - path: "src/store/index.tsx"
      provides: "HistoryStore integration into RootStore"
      contains: "historyStore: HistoryStore"
  key_links:
    - from: "src/store/index.tsx"
      to: "src/store/HistoryStore.ts"
      via: "import and instantiation"
      pattern: "import.*HistoryStore.*from.*HistoryStore"
    - from: "src/store/HistoryStore.ts"
      to: "src/schemas/QaseHistory.schema.ts"
      via: "schema validation"
      pattern: "QaseHistorySchema\\.parse"
---

<objective>
Build HistoryStore with tiered loading and localStorage persistence.

Purpose: Prevent memory explosion (research pitfall: browsers crash with 100MB+ observable JSON). Tiered loading = load summary statistics upfront, detailed data on-demand. LocalStorage handles ~2MB (100 runs Ã— ~20KB) without IndexedDB complexity.

Output: MobX store managing historical run data with efficient memory usage and persistence.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@.planning/phases/08-history-infrastructure/08-01-SUMMARY.md
@src/store/index.tsx
@src/store/ReportStore.ts
@src/store/TestResultsStore.ts
@src/schemas/QaseHistory.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Create HistoryStore with tiered loading</name>
  <files>src/store/HistoryStore.ts</files>
  <action>
    Create MobX store for history data management following existing store patterns from ReportStore and TestResultsStore.

    Class structure:

    1. **Observable Properties:**
       - history: QaseHistory | null (full history data, nullable before load)
       - isHistoryLoaded: boolean (tracking state)
       - historyError: string | null (validation or loading errors)

    2. **Constructor:**
       - Accept root: RootStore parameter
       - Initialize with makeAutoObservable(this)
       - Store root reference for accessing other stores
       - Call loadFromLocalStorage() to restore persisted data

    3. **Actions:**

       a. **loadHistoryFile(file: File): Promise<void>**
          - Read file using FileLoaderService.readAsText()
          - Parse JSON
          - Validate with QaseHistorySchema.parse()
          - Set this.history on success
          - Set this.historyError on validation failure
          - Call saveToLocalStorage() after successful load
          - Set this.isHistoryLoaded = true

       b. **saveToLocalStorage(): void**
          - Key: 'qase-report-history'
          - Store JSON.stringify(this.history)
          - Handle localStorage quota errors (catch and set historyError)
          - Warn if data exceeds 2MB (console.warn)

       c. **loadFromLocalStorage(): void**
          - Try to read 'qase-report-history' key
          - Parse JSON if exists
          - Validate with QaseHistorySchema.parse()
          - Set this.history if valid
          - Clear localStorage key if validation fails
          - Set this.isHistoryLoaded = true if successful

       d. **clearHistory(): void**
          - Set this.history = null
          - Clear localStorage key
          - Set this.isHistoryLoaded = false

       e. **addCurrentRun(run: QaseRun, testResults: Map<string, QaseTestResult>): void**
          - Create HistoricalRun from current run data
          - Extract test signatures and create HistoricalTestResult entries
          - Append to this.history.runs and update this.history.tests
          - Limit to most recent 100 runs (shift oldest if exceeds)
          - Call saveToLocalStorage()

    4. **Computed Properties:**

       a. **get recentRuns(): HistoricalRun[]**
          - Return last 10 runs from this.history.runs
          - Return empty array if no history

       b. **getTestHistory(signature: string): HistoricalTestRunData[]**
          - Find test in this.history.tests by signature
          - Return test.runs array
          - Return empty array if test not found

       c. **get totalRuns(): number**
          - Return this.history?.runs.length || 0

    Follow codebase conventions:
    - Import makeAutoObservable from mobx
    - Import QaseHistory, QaseHistorySchema from schemas
    - Import RootStore type from index.tsx
    - Use async/await for file operations
    - Use try/catch for localStorage operations (can throw quota errors)
    - Add JSDoc comments for all methods

    Memory optimization (per research):
    - Do NOT store full test details in memory (only summary data)
    - Limit to 100 runs maximum (research shows diminishing returns after 30-50 runs)
    - Use Map for O(1) lookups if needed, but history data is already indexed by signature
  </action>
  <verify>
    TypeScript compiles: npm run build

    HistoryStore exports class:
    grep -q "export class HistoryStore" src/store/HistoryStore.ts

    Store has required methods:
    grep -q "loadHistoryFile" src/store/HistoryStore.ts
    grep -q "saveToLocalStorage" src/store/HistoryStore.ts
    grep -q "addCurrentRun" src/store/HistoryStore.ts
  </verify>
  <done>
    - HistoryStore.ts exists with MobX observable properties
    - Store implements loadHistoryFile with Zod validation
    - Store implements localStorage persistence (save/load/clear)
    - Store implements addCurrentRun to append current run data
    - Store provides computed properties (recentRuns, getTestHistory, totalRuns)
    - Store limits to 100 runs maximum for memory management
    - TypeScript compilation succeeds
  </done>
</task>

<task type="auto">
  <name>Integrate HistoryStore into RootStore</name>
  <files>src/store/index.tsx</files>
  <action>
    Update RootStore to include HistoryStore following existing patterns for ReportStore, TestResultsStore, AttachmentsStore.

    Changes:

    1. **Import:**
       - Add: import { HistoryStore } from './HistoryStore'

    2. **Property:**
       - Add to RootStore class: historyStore: HistoryStore

    3. **Constructor:**
       - Add after other stores: this.historyStore = new HistoryStore(this)
       - Keep makeAutoObservable(this) call at end

    NOTE: The addCurrentRun call in loadReport will be added in Plan 08-03 Task 2,
    after history file loading is integrated. This plan only adds the store property and instantiation.

    Do NOT modify:
    - Existing store properties or methods
    - Other store instantiation order
    - Context provider or hooks (RootStoreContext, useRootStore)
  </action>
  <verify>
    TypeScript compiles: npm run build

    RootStore includes HistoryStore:
    grep -q "historyStore: HistoryStore" src/store/index.tsx
    grep -q "this.historyStore = new HistoryStore" src/store/index.tsx
  </verify>
  <done>
    - RootStore has historyStore property
    - HistoryStore instantiated in constructor
    - TypeScript compilation succeeds
    - Existing stores unchanged
    - NOTE: addCurrentRun integration added in Plan 08-03
  </done>
</task>

</tasks>

<verification>
HistoryStore integrated into RootStore and accessible via useRootStore hook.

Manual test in browser console:
```typescript
const store = useRootStore()
store.historyStore.totalRuns // should return 0 initially
store.historyStore.isHistoryLoaded // should return false or true if localStorage has data
```
</verification>

<success_criteria>
- HistoryStore.ts exists with tiered loading implementation
- Store validates history data with Zod schema
- Store persists to localStorage with quota error handling
- Store limits to 100 runs for memory management
- RootStore includes historyStore instance
- loadReport integrates with history store to append current run
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/08-history-infrastructure/08-02-SUMMARY.md`
</output>
