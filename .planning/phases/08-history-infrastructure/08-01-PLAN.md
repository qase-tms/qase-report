---
phase: 08-history-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/schemas/QaseHistory.schema.ts
autonomous: true

must_haves:
  truths:
    - "System validates history file with schema_version field"
    - "System rejects invalid history data with clear error messages"
    - "History schema supports multiple runs with test signatures"
  artifacts:
    - path: "src/schemas/QaseHistory.schema.ts"
      provides: "History data validation and TypeScript types"
      exports: ["QaseHistorySchema", "QaseHistory", "HistoricalRun", "HistoricalTestResult"]
      min_lines: 80
  key_links:
    - from: "src/schemas/QaseHistory.schema.ts"
      to: "zod validation"
      via: "z.object() schemas"
      pattern: "z\\.(object|string|number|array)"
---

<objective>
Create schema and validation for test-history.json with versioning support.

Purpose: Foundation for history tracking. Schema versioning from v1.0 prevents future migration pain (research pitfall: schema evolution without versioning). Signature-based test identity enables stable tracking across runs (not run-specific UUIDs).

Output: Zod schema file providing TypeScript types and runtime validation for history data.
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@src/schemas/QaseRun.schema.ts
@src/schemas/QaseTestResult.schema.ts
</context>

<tasks>

<task type="auto">
  <name>Create QaseHistory.schema.ts with versioning</name>
  <files>src/schemas/QaseHistory.schema.ts</files>
  <action>
    Create Zod schema for test-history.json file following existing schema patterns from QaseRun.schema.ts and QaseTestResult.schema.ts.

    Schema structure (following research recommendation for tiered loading):

    1. **schema_version field** (string, default "1.0.0") - SchemaVer format (MODEL-REVISION-ADDITION) for future migrations

    2. **HistoricalRunSchema** - Summary data for each historical run:
       - run_id: string (unique identifier, can be timestamp or UUID)
       - title: string (optional, nullable)
       - environment: string (optional, nullable)
       - start_time: number (Unix timestamp milliseconds)
       - end_time: number (Unix timestamp milliseconds)
       - duration: number (milliseconds)
       - stats: RunStatsSchema (reuse from QaseRun.schema.ts - passed, failed, skipped, broken/blocked/invalid)

    3. **HistoricalTestResultSchema** - Per-test summary across runs:
       - signature: string (test identifier, stable across runs - matches signature from QaseTestResult)
       - title: string (test name)
       - runs: array of HistoricalTestRunDataSchema with:
         - run_id: string (references HistoricalRunSchema.run_id)
         - status: TestStatusEnum (passed, failed, skipped, broken)
         - duration: number (milliseconds)
         - start_time: number (Unix timestamp)
         - error_message: string (nullable - first line of stacktrace or message, for flakiness detection)

    4. **QaseHistorySchema** - Root schema:
       - schema_version: string (default "1.0.0")
       - runs: array of HistoricalRunSchema
       - tests: array of HistoricalTestResultSchema

    Export TypeScript types using z.infer for: QaseHistory, HistoricalRun, HistoricalTestResult, HistoricalTestRunData.

    Follow codebase conventions:
    - Use z.object(), z.string(), z.number(), z.array(), z.nullable(), z.optional() from zod
    - Add JSDoc comments for all schemas and fields
    - Import shared schemas (RunStatsSchema) from QaseRun.schema.ts if needed, or redefine inline
    - Use existing TestStatusEnum pattern from QaseTestResult.schema.ts
  </action>
  <verify>
    TypeScript compiles without errors: npm run build

    Schema file exists with proper exports:
    grep -q "export const QaseHistorySchema" src/schemas/QaseHistory.schema.ts
    grep -q "export type QaseHistory" src/schemas/QaseHistory.schema.ts
  </verify>
  <done>
    - QaseHistory.schema.ts exists with schema_version field
    - Schema exports QaseHistorySchema, HistoricalRunSchema, HistoricalTestResultSchema
    - TypeScript types exported: QaseHistory, HistoricalRun, HistoricalTestResult
    - Schema validates runs array with summary stats
    - Schema validates tests array with per-test run history
    - Error messages field included for flakiness detection
  </done>
</task>

</tasks>

<verification>
Schema file compiles and exports correct types.

Test validation manually:
```typescript
import { QaseHistorySchema } from './src/schemas/QaseHistory.schema'

const validHistory = {
  schema_version: "1.0.0",
  runs: [{
    run_id: "run-001",
    title: "Test Run 1",
    environment: "staging",
    start_time: 1704672000000,
    end_time: 1704672300000,
    duration: 300000,
    stats: { total: 10, passed: 8, failed: 2, skipped: 0 }
  }],
  tests: [{
    signature: "test-auth-login",
    title: "User can log in",
    runs: [{
      run_id: "run-001",
      status: "passed",
      duration: 1500,
      start_time: 1704672010000,
      error_message: null
    }]
  }]
}

QaseHistorySchema.parse(validHistory) // should succeed
```
</verification>

<success_criteria>
- Schema file exists at src/schemas/QaseHistory.schema.ts
- Schema includes schema_version field for future migrations
- Schema uses signature-based test identity (not UUID)
- Schema supports tiered loading (summary stats in runs, detailed data in tests)
- TypeScript compilation succeeds
- Zod validation works for valid history data
</success_criteria>

<output>
After completion, create `.planning/phases/08-history-infrastructure/08-01-SUMMARY.md`
</output>
