---
phase: 45-local-server
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/cli/server.ts
autonomous: true

must_haves:
  truths:
    - "Express server starts and listens on specified port"
    - "Server serves React app static files from dist/"
    - "API endpoint returns report data (run.json + results)"
    - "Server shuts down gracefully on SIGINT/SIGTERM"
  artifacts:
    - path: "src/cli/server.ts"
      provides: "Express server with static serving and data API"
      min_lines: 80
      exports: ["createServer", "startServer"]
  key_links:
    - from: "src/cli/server.ts"
      to: "dist/index.html"
      via: "express.static middleware"
      pattern: "express\\.static"
    - from: "src/cli/server.ts"
      to: "/api/report"
      via: "GET endpoint handler"
      pattern: "app\\.get.*api/report"
---

<objective>
Create Express server infrastructure for serving the React app and providing data API

Purpose: Foundation for local development server that serves built React app and exposes report data via REST API
Output: Server module that can be imported and started by the open command
</objective>

<execution_context>
@/Users/gda/.claude/get-shit-done/workflows/execute-plan.md
@/Users/gda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/44-cli-foundation/44-01-SUMMARY.md
@src/cli/index.ts
@package.json
@tsconfig.cli.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install server dependencies</name>
  <files>package.json</files>
  <action>
Install Express.js and the `open` package for browser opening:

```bash
npm install express open
npm install --save-dev @types/express
```

Express is standard for Node.js HTTP servers. The `open` package provides cross-platform browser opening (works on macOS, Windows, Linux).
  </action>
  <verify>
Run `npm ls express open` and verify both packages are installed.
Check package.json contains both in dependencies.
  </verify>
  <done>
Express and open packages installed in dependencies, @types/express in devDependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Express server module</name>
  <files>src/cli/server.ts</files>
  <action>
Create `src/cli/server.ts` with:

1. **Server factory function** `createServer(options: ServerOptions)`:
   - `options.reportPath`: Path to results directory (required)
   - `options.port`: Port number (default 3000)
   - Returns Express app instance

2. **Static file serving**:
   - Serve built React app from `dist/` directory (relative to package root)
   - Use `express.static` middleware
   - Handle SPA routing: serve index.html for all non-API routes

3. **Data API endpoint** `GET /api/report`:
   - Read `run.json` from reportPath
   - Read all `*.json` files from `reportPath/results/`
   - Return JSON: `{ run: {...}, results: [...], attachmentsPath: string }`
   - Handle errors with appropriate HTTP status codes (404 if not found, 500 for read errors)

4. **Attachments endpoint** `GET /api/attachments/:filename`:
   - Serve files from `reportPath/attachments/` directory
   - Use express.static or sendFile for proper MIME types
   - Return 404 if file not found

5. **Start function** `startServer(app, port)`:
   - Returns Promise that resolves when server is listening
   - Logs "Server running at http://localhost:{port}"

6. **Graceful shutdown**:
   - Handle SIGINT and SIGTERM signals
   - Close HTTP server connections
   - Log "Server stopped" message
   - Exit process with code 0

Use ES modules (import/export) compatible with NodeNext module system from tsconfig.cli.json.
Use `fileURLToPath` and `dirname` pattern from existing CLI code for path resolution.
  </action>
  <verify>
1. File exists at src/cli/server.ts
2. TypeScript compiles without errors: `npm run build:cli`
3. Module exports createServer and startServer functions
  </verify>
  <done>
Server module created with Express app factory, static file serving, data API endpoint, attachments serving, and graceful shutdown handling.
  </done>
</task>

</tasks>

<verification>
1. `npm run build:cli` completes without errors
2. Server module compiles to dist/cli/server.js
3. Both express and open packages in package.json
</verification>

<success_criteria>
- Express server module ready for use by open command
- API endpoint designed to serve report data
- Static file serving configured for React app
- Graceful shutdown implemented
</success_criteria>

<output>
After completion, create `.planning/phases/45-local-server/45-01-SUMMARY.md`
</output>
